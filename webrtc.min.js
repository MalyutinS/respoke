function trace(text){"\n"==text[text.length-1]&&(text=text.substring(0,text.length-1)),console.log((performance.now()/1e3).toFixed(3)+": "+text)}!function(definition){if("function"==typeof bootstrap)bootstrap("promise",definition);else if("object"==typeof exports)module.exports=definition();else if("function"==typeof define&&define.amd)define(definition);else if("undefined"!=typeof ses){if(!ses.ok())return;ses.makeQ=definition}else Q=definition()}(function(){"use strict";function uncurryThis(f){return function(){return call.apply(f,arguments)}}function isObject(value){return value===Object(value)}function isStopIteration(exception){return"[object StopIteration]"===object_toString(exception)||exception instanceof QReturnValue}function makeStackTraceLong(error,promise){if(hasStacks&&promise.stack&&"object"==typeof error&&null!==error&&error.stack&&-1===error.stack.indexOf(STACK_JUMP_SEPARATOR)){for(var stacks=[],p=promise;p;p=p.source)p.stack&&stacks.unshift(p.stack);stacks.unshift(error.stack);var concatedStacks=stacks.join("\n"+STACK_JUMP_SEPARATOR+"\n");error.stack=filterStackString(concatedStacks)}}function filterStackString(stackString){for(var lines=stackString.split("\n"),desiredLines=[],i=0;i<lines.length;++i){var line=lines[i];isInternalFrame(line)||isNodeFrame(line)||!line||desiredLines.push(line)}return desiredLines.join("\n")}function isNodeFrame(stackLine){return-1!==stackLine.indexOf("(module.js:")||-1!==stackLine.indexOf("(node.js:")}function getFileNameAndLineNumber(stackLine){var attempt1=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(stackLine);if(attempt1)return[attempt1[1],Number(attempt1[2])];var attempt2=/at ([^ ]+):(\d+):(?:\d+)$/.exec(stackLine);if(attempt2)return[attempt2[1],Number(attempt2[2])];var attempt3=/.*@(.+):(\d+)$/.exec(stackLine);return attempt3?[attempt3[1],Number(attempt3[2])]:void 0}function isInternalFrame(stackLine){var fileNameAndLineNumber=getFileNameAndLineNumber(stackLine);if(!fileNameAndLineNumber)return!1;var fileName=fileNameAndLineNumber[0],lineNumber=fileNameAndLineNumber[1];return fileName===qFileName&&lineNumber>=qStartingLine&&qEndingLine>=lineNumber}function captureLine(){if(hasStacks)try{throw new Error}catch(e){var lines=e.stack.split("\n"),firstLine=lines[0].indexOf("@")>0?lines[1]:lines[2],fileNameAndLineNumber=getFileNameAndLineNumber(firstLine);if(!fileNameAndLineNumber)return;return qFileName=fileNameAndLineNumber[0],fileNameAndLineNumber[1]}}function deprecate(callback,name,alternative){return function(){return"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(name+" is deprecated, use "+alternative+" instead.",new Error("").stack),callback.apply(callback,arguments)}}function Q(value){return isPromise(value)?value:isPromiseAlike(value)?coerce(value):fulfill(value)}function defer(){function become(newPromise){resolvedPromise=newPromise,promise.source=newPromise,array_reduce(messages,function(undefined,message){nextTick(function(){newPromise.promiseDispatch.apply(newPromise,message)})},void 0),messages=void 0,progressListeners=void 0}var resolvedPromise,messages=[],progressListeners=[],deferred=object_create(defer.prototype),promise=object_create(Promise.prototype);if(promise.promiseDispatch=function(resolve,op,operands){var args=array_slice(arguments);messages?(messages.push(args),"when"===op&&operands[1]&&progressListeners.push(operands[1])):nextTick(function(){resolvedPromise.promiseDispatch.apply(resolvedPromise,args)})},promise.valueOf=deprecate(function(){if(messages)return promise;var nearerValue=nearer(resolvedPromise);return isPromise(nearerValue)&&(resolvedPromise=nearerValue),nearerValue},"valueOf","inspect"),promise.inspect=function(){return resolvedPromise?resolvedPromise.inspect():{state:"pending"}},Q.longStackSupport&&hasStacks)try{throw new Error}catch(e){promise.stack=e.stack.substring(e.stack.indexOf("\n")+1)}return deferred.promise=promise,deferred.resolve=function(value){resolvedPromise||become(Q(value))},deferred.fulfill=function(value){resolvedPromise||become(fulfill(value))},deferred.reject=function(reason){resolvedPromise||become(reject(reason))},deferred.notify=function(progress){resolvedPromise||array_reduce(progressListeners,function(undefined,progressListener){nextTick(function(){progressListener(progress)})},void 0)},deferred}function promise(resolver){if("function"!=typeof resolver)throw new TypeError("resolver must be a function.");var deferred=defer();try{resolver(deferred.resolve,deferred.reject,deferred.notify)}catch(reason){deferred.reject(reason)}return deferred.promise}function race(answerPs){return promise(function(resolve,reject){for(var i=0,len=answerPs.length;len>i;i++)Q(answerPs[i]).then(resolve,reject)})}function Promise(descriptor,fallback,inspect){void 0===fallback&&(fallback=function(op){return reject(new Error("Promise does not support operation: "+op))}),void 0===inspect&&(inspect=function(){return{state:"unknown"}});var promise=object_create(Promise.prototype);if(promise.promiseDispatch=function(resolve,op,args){var result;try{result=descriptor[op]?descriptor[op].apply(promise,args):fallback.call(promise,op,args)}catch(exception){result=reject(exception)}resolve&&resolve(result)},promise.inspect=inspect,inspect){var inspected=inspect();"rejected"===inspected.state&&(promise.exception=inspected.reason),promise.valueOf=deprecate(function(){var inspected=inspect();return"pending"===inspected.state||"rejected"===inspected.state?promise:inspected.value})}return promise}function when(value,fulfilled,rejected,progressed){return Q(value).then(fulfilled,rejected,progressed)}function nearer(value){if(isPromise(value)){var inspected=value.inspect();if("fulfilled"===inspected.state)return inspected.value}return value}function isPromise(object){return isObject(object)&&"function"==typeof object.promiseDispatch&&"function"==typeof object.inspect}function isPromiseAlike(object){return isObject(object)&&"function"==typeof object.then}function isPending(object){return isPromise(object)&&"pending"===object.inspect().state}function isFulfilled(object){return!isPromise(object)||"fulfilled"===object.inspect().state}function isRejected(object){return isPromise(object)&&"rejected"===object.inspect().state}function displayUnhandledReasons(){unhandledReasonsDisplayed||"undefined"==typeof window||window.Touch||!window.console||console.warn("[Q] Unhandled rejection reasons (should be empty):",unhandledReasons),unhandledReasonsDisplayed=!0}function logUnhandledReasons(){for(var i=0;i<unhandledReasons.length;i++){var reason=unhandledReasons[i];reason&&"undefined"!=typeof reason.stack?console.warn("Unhandled rejection reason:",reason.stack):console.warn("Unhandled rejection reason (no stack):",reason)}}function resetUnhandledRejections(){unhandledReasons.length=0,unhandledRejections.length=0,unhandledReasonsDisplayed=!1,trackUnhandledRejections||(trackUnhandledRejections=!0,"undefined"!=typeof process&&process.on&&process.on("exit",logUnhandledReasons))}function trackRejection(promise,reason){trackUnhandledRejections&&(unhandledRejections.push(promise),unhandledReasons.push(reason),displayUnhandledReasons())}function untrackRejection(promise){if(trackUnhandledRejections){var at=array_indexOf(unhandledRejections,promise);-1!==at&&(unhandledRejections.splice(at,1),unhandledReasons.splice(at,1))}}function reject(reason){var rejection=Promise({when:function(rejected){return rejected&&untrackRejection(this),rejected?rejected(reason):this}},function(){return this},function(){return{state:"rejected",reason:reason}});return trackRejection(rejection,reason),rejection}function fulfill(value){return Promise({when:function(){return value},get:function(name){return value[name]},set:function(name,rhs){value[name]=rhs},"delete":function(name){delete value[name]},post:function(name,args){return null===name||void 0===name?value.apply(void 0,args):value[name].apply(value,args)},apply:function(thisp,args){return value.apply(thisp,args)},keys:function(){return object_keys(value)}},void 0,function(){return{state:"fulfilled",value:value}})}function coerce(promise){var deferred=defer();return nextTick(function(){try{promise.then(deferred.resolve,deferred.reject,deferred.notify)}catch(exception){deferred.reject(exception)}}),deferred.promise}function master(object){return Promise({isDef:function(){}},function(op,args){return dispatch(object,op,args)},function(){return Q(object).inspect()})}function spread(value,fulfilled,rejected){return Q(value).spread(fulfilled,rejected)}function async(makeGenerator){return function(){function continuer(verb,arg){var result;if(hasES6Generators){try{result=generator[verb](arg)}catch(exception){return reject(exception)}return result.done?result.value:when(result.value,callback,errback)}try{result=generator[verb](arg)}catch(exception){return isStopIteration(exception)?exception.value:reject(exception)}return when(result,callback,errback)}var generator=makeGenerator.apply(this,arguments),callback=continuer.bind(continuer,"next"),errback=continuer.bind(continuer,"throw");return callback()}}function spawn(makeGenerator){Q.done(Q.async(makeGenerator)())}function _return(value){throw new QReturnValue(value)}function promised(callback){return function(){return spread([this,all(arguments)],function(self,args){return callback.apply(self,args)})}}function dispatch(object,op,args){return Q(object).dispatch(op,args)}function all(promises){return when(promises,function(promises){var countDown=0,deferred=defer();return array_reduce(promises,function(undefined,promise,index){var snapshot;isPromise(promise)&&"fulfilled"===(snapshot=promise.inspect()).state?promises[index]=snapshot.value:(++countDown,when(promise,function(value){promises[index]=value,0===--countDown&&deferred.resolve(promises)},deferred.reject,function(progress){deferred.notify({index:index,value:progress})}))},void 0),0===countDown&&deferred.resolve(promises),deferred.promise})}function allResolved(promises){return when(promises,function(promises){return promises=array_map(promises,Q),when(all(array_map(promises,function(promise){return when(promise,noop,noop)})),function(){return promises})})}function allSettled(promises){return Q(promises).allSettled()}function progress(object,progressed){return Q(object).then(void 0,void 0,progressed)}function nodeify(object,nodeback){return Q(object).nodeify(nodeback)}var hasStacks=!1;try{throw new Error}catch(e){hasStacks=!!e.stack}var qFileName,QReturnValue,qStartingLine=captureLine(),noop=function(){},nextTick=function(){function flush(){for(;head.next;){head=head.next;var task=head.task;head.task=void 0;var domain=head.domain;domain&&(head.domain=void 0,domain.enter());try{task()}catch(e){if(isNodeJS)throw domain&&domain.exit(),setTimeout(flush,0),domain&&domain.enter(),e;setTimeout(function(){throw e},0)}domain&&domain.exit()}flushing=!1}var head={task:void 0,next:null},tail=head,flushing=!1,requestTick=void 0,isNodeJS=!1;if(nextTick=function(task){tail=tail.next={task:task,domain:isNodeJS&&process.domain,next:null},flushing||(flushing=!0,requestTick())},"undefined"!=typeof process&&process.nextTick)isNodeJS=!0,requestTick=function(){process.nextTick(flush)};else if("function"==typeof setImmediate)requestTick="undefined"!=typeof window?setImmediate.bind(window,flush):function(){setImmediate(flush)};else if("undefined"!=typeof MessageChannel){var channel=new MessageChannel;channel.port1.onmessage=flush,requestTick=function(){channel.port2.postMessage(0)}}else requestTick=function(){setTimeout(flush,0)};return nextTick}(),call=Function.call,array_slice=uncurryThis(Array.prototype.slice),array_reduce=uncurryThis(Array.prototype.reduce||function(callback,basis){var index=0,length=this.length;if(1===arguments.length)for(;;){if(index in this){basis=this[index++];break}if(++index>=length)throw new TypeError}for(;length>index;index++)index in this&&(basis=callback(basis,this[index],index));return basis}),array_indexOf=uncurryThis(Array.prototype.indexOf||function(value){for(var i=0;i<this.length;i++)if(this[i]===value)return i;return-1}),array_map=uncurryThis(Array.prototype.map||function(callback,thisp){var self=this,collect=[];return array_reduce(self,function(undefined,value,index){collect.push(callback.call(thisp,value,index,self))},void 0),collect}),object_create=Object.create||function(prototype){function Type(){}return Type.prototype=prototype,new Type},object_hasOwnProperty=uncurryThis(Object.prototype.hasOwnProperty),object_keys=Object.keys||function(object){var keys=[];for(var key in object)object_hasOwnProperty(object,key)&&keys.push(key);return keys},object_toString=uncurryThis(Object.prototype.toString);QReturnValue="undefined"!=typeof ReturnValue?ReturnValue:function(value){this.value=value};var hasES6Generators;try{new Function("(function* (){ yield 1; })"),hasES6Generators=!0}catch(e){hasES6Generators=!1}var STACK_JUMP_SEPARATOR="From previous event:";Q.resolve=Q,Q.nextTick=nextTick,Q.longStackSupport=!1,Q.defer=defer,defer.prototype.makeNodeResolver=function(){var self=this;return function(error,value){error?self.reject(error):arguments.length>2?self.resolve(array_slice(arguments,1)):self.resolve(value)}},Q.promise=promise,Q.passByCopy=function(object){return object},Promise.prototype.passByCopy=function(){return this},Q.join=function(x,y){return Q(x).join(y)},Promise.prototype.join=function(that){return Q([this,that]).spread(function(x,y){if(x===y)return x;throw new Error("Can't join: not the same: "+x+" "+y)})},Q.race=race,Promise.prototype.race=function(){return this.then(Q.race)},Q.makePromise=Promise,Promise.prototype.toString=function(){return"[object Promise]"},Promise.prototype.then=function(fulfilled,rejected,progressed){function _fulfilled(value){try{return"function"==typeof fulfilled?fulfilled(value):value}catch(exception){return reject(exception)}}function _rejected(exception){if("function"==typeof rejected){makeStackTraceLong(exception,self);try{return rejected(exception)}catch(newException){return reject(newException)}}return reject(exception)}function _progressed(value){return"function"==typeof progressed?progressed(value):value}var self=this,deferred=defer(),done=!1;return nextTick(function(){self.promiseDispatch(function(value){done||(done=!0,deferred.resolve(_fulfilled(value)))},"when",[function(exception){done||(done=!0,deferred.resolve(_rejected(exception)))}])}),self.promiseDispatch(void 0,"when",[void 0,function(value){var newValue,threw=!1;try{newValue=_progressed(value)}catch(e){if(threw=!0,!Q.onerror)throw e;Q.onerror(e)}threw||deferred.notify(newValue)}]),deferred.promise},Q.when=when,Promise.prototype.thenResolve=function(value){return this.then(function(){return value})},Q.thenResolve=function(promise,value){return Q(promise).thenResolve(value)},Promise.prototype.thenReject=function(reason){return this.then(function(){throw reason})},Q.thenReject=function(promise,reason){return Q(promise).thenReject(reason)},Q.nearer=nearer,Q.isPromise=isPromise,Q.isPromiseAlike=isPromiseAlike,Q.isPending=isPending,Promise.prototype.isPending=function(){return"pending"===this.inspect().state},Q.isFulfilled=isFulfilled,Promise.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state},Q.isRejected=isRejected,Promise.prototype.isRejected=function(){return"rejected"===this.inspect().state};var unhandledReasons=[],unhandledRejections=[],unhandledReasonsDisplayed=!1,trackUnhandledRejections=!0;Q.resetUnhandledRejections=resetUnhandledRejections,Q.getUnhandledReasons=function(){return unhandledReasons.slice()},Q.stopUnhandledRejectionTracking=function(){resetUnhandledRejections(),"undefined"!=typeof process&&process.on&&process.removeListener("exit",logUnhandledReasons),trackUnhandledRejections=!1},resetUnhandledRejections(),Q.reject=reject,Q.fulfill=fulfill,Q.master=master,Q.spread=spread,Promise.prototype.spread=function(fulfilled,rejected){return this.all().then(function(array){return fulfilled.apply(void 0,array)},rejected)},Q.async=async,Q.spawn=spawn,Q["return"]=_return,Q.promised=promised,Q.dispatch=dispatch,Promise.prototype.dispatch=function(op,args){var self=this,deferred=defer();return nextTick(function(){self.promiseDispatch(deferred.resolve,op,args)}),deferred.promise},Q.get=function(object,key){return Q(object).dispatch("get",[key])},Promise.prototype.get=function(key){return this.dispatch("get",[key])},Q.set=function(object,key,value){return Q(object).dispatch("set",[key,value])},Promise.prototype.set=function(key,value){return this.dispatch("set",[key,value])},Q.del=Q["delete"]=function(object,key){return Q(object).dispatch("delete",[key])},Promise.prototype.del=Promise.prototype["delete"]=function(key){return this.dispatch("delete",[key])},Q.mapply=Q.post=function(object,name,args){return Q(object).dispatch("post",[name,args])},Promise.prototype.mapply=Promise.prototype.post=function(name,args){return this.dispatch("post",[name,args])},Q.send=Q.mcall=Q.invoke=function(object,name){return Q(object).dispatch("post",[name,array_slice(arguments,2)])},Promise.prototype.send=Promise.prototype.mcall=Promise.prototype.invoke=function(name){return this.dispatch("post",[name,array_slice(arguments,1)])},Q.fapply=function(object,args){return Q(object).dispatch("apply",[void 0,args])},Promise.prototype.fapply=function(args){return this.dispatch("apply",[void 0,args])},Q["try"]=Q.fcall=function(object){return Q(object).dispatch("apply",[void 0,array_slice(arguments,1)])},Promise.prototype.fcall=function(){return this.dispatch("apply",[void 0,array_slice(arguments)])},Q.fbind=function(object){var promise=Q(object),args=array_slice(arguments,1);return function(){return promise.dispatch("apply",[this,args.concat(array_slice(arguments))])}},Promise.prototype.fbind=function(){var promise=this,args=array_slice(arguments);return function(){return promise.dispatch("apply",[this,args.concat(array_slice(arguments))])}},Q.keys=function(object){return Q(object).dispatch("keys",[])},Promise.prototype.keys=function(){return this.dispatch("keys",[])},Q.all=all,Promise.prototype.all=function(){return all(this)},Q.allResolved=deprecate(allResolved,"allResolved","allSettled"),Promise.prototype.allResolved=function(){return allResolved(this)},Q.allSettled=allSettled,Promise.prototype.allSettled=function(){return this.then(function(promises){return all(array_map(promises,function(promise){function regardless(){return promise.inspect()}return promise=Q(promise),promise.then(regardless,regardless)}))})},Q.fail=Q["catch"]=function(object,rejected){return Q(object).then(void 0,rejected)},Promise.prototype.fail=Promise.prototype["catch"]=function(rejected){return this.then(void 0,rejected)},Q.progress=progress,Promise.prototype.progress=function(progressed){return this.then(void 0,void 0,progressed)},Q.fin=Q["finally"]=function(object,callback){return Q(object)["finally"](callback)},Promise.prototype.fin=Promise.prototype["finally"]=function(callback){return callback=Q(callback),this.then(function(value){return callback.fcall().then(function(){return value})},function(reason){return callback.fcall().then(function(){throw reason})})},Q.done=function(object,fulfilled,rejected,progress){return Q(object).done(fulfilled,rejected,progress)},Promise.prototype.done=function(fulfilled,rejected,progress){var onUnhandledError=function(error){nextTick(function(){if(makeStackTraceLong(error,promise),!Q.onerror)throw error;Q.onerror(error)})},promise=fulfilled||rejected||progress?this.then(fulfilled,rejected,progress):this;"object"==typeof process&&process&&process.domain&&(onUnhandledError=process.domain.bind(onUnhandledError)),promise.then(void 0,onUnhandledError)},Q.timeout=function(object,ms,message){return Q(object).timeout(ms,message)},Promise.prototype.timeout=function(ms,message){var deferred=defer(),timeoutId=setTimeout(function(){deferred.reject(new Error(message||"Timed out after "+ms+" ms"))},ms);return this.then(function(value){clearTimeout(timeoutId),deferred.resolve(value)},function(exception){clearTimeout(timeoutId),deferred.reject(exception)},deferred.notify),deferred.promise},Q.delay=function(object,timeout){return void 0===timeout&&(timeout=object,object=void 0),Q(object).delay(timeout)},Promise.prototype.delay=function(timeout){return this.then(function(value){var deferred=defer();return setTimeout(function(){deferred.resolve(value)},timeout),deferred.promise})},Q.nfapply=function(callback,args){return Q(callback).nfapply(args)},Promise.prototype.nfapply=function(args){var deferred=defer(),nodeArgs=array_slice(args);return nodeArgs.push(deferred.makeNodeResolver()),this.fapply(nodeArgs).fail(deferred.reject),deferred.promise},Q.nfcall=function(callback){var args=array_slice(arguments,1);return Q(callback).nfapply(args)},Promise.prototype.nfcall=function(){var nodeArgs=array_slice(arguments),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),this.fapply(nodeArgs).fail(deferred.reject),deferred.promise},Q.nfbind=Q.denodeify=function(callback){var baseArgs=array_slice(arguments,1);return function(){var nodeArgs=baseArgs.concat(array_slice(arguments)),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),Q(callback).fapply(nodeArgs).fail(deferred.reject),deferred.promise}},Promise.prototype.nfbind=Promise.prototype.denodeify=function(){var args=array_slice(arguments);return args.unshift(this),Q.denodeify.apply(void 0,args)},Q.nbind=function(callback,thisp){var baseArgs=array_slice(arguments,2);return function(){function bound(){return callback.apply(thisp,arguments)}var nodeArgs=baseArgs.concat(array_slice(arguments)),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),Q(bound).fapply(nodeArgs).fail(deferred.reject),deferred.promise}},Promise.prototype.nbind=function(){var args=array_slice(arguments,0);return args.unshift(this),Q.nbind.apply(void 0,args)},Q.nmapply=Q.npost=function(object,name,args){return Q(object).npost(name,args)},Promise.prototype.nmapply=Promise.prototype.npost=function(name,args){var nodeArgs=array_slice(args||[]),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),this.dispatch("post",[name,nodeArgs]).fail(deferred.reject),deferred.promise},Q.nsend=Q.nmcall=Q.ninvoke=function(object,name){var nodeArgs=array_slice(arguments,2),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),Q(object).dispatch("post",[name,nodeArgs]).fail(deferred.reject),deferred.promise},Promise.prototype.nsend=Promise.prototype.nmcall=Promise.prototype.ninvoke=function(name){var nodeArgs=array_slice(arguments,1),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),this.dispatch("post",[name,nodeArgs]).fail(deferred.reject),deferred.promise},Q.nodeify=nodeify,Promise.prototype.nodeify=function(nodeback){return nodeback?(this.then(function(value){nextTick(function(){nodeback(null,value)})},function(error){nextTick(function(){nodeback(error)})}),void 0):this};var qEndingLine=captureLine();return Q});var Base64=function(){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",b={encode:function(b){var d,e,f,g,h,i,j,c="",k=0;do d=b.charCodeAt(k++),e=b.charCodeAt(k++),f=b.charCodeAt(k++),g=d>>2,h=(3&d)<<4|e>>4,i=(15&e)<<2|f>>6,j=63&f,isNaN(e)?i=j=64:isNaN(f)&&(j=64),c=c+a.charAt(g)+a.charAt(h)+a.charAt(i)+a.charAt(j);while(k<b.length);return c},decode:function(b){var d,e,f,g,h,i,j,c="",k=0;b=b.replace(/[^A-Za-z0-9\+\/\=]/g,"");do g=a.indexOf(b.charAt(k++)),h=a.indexOf(b.charAt(k++)),i=a.indexOf(b.charAt(k++)),j=a.indexOf(b.charAt(k++)),d=g<<2|h>>4,e=(15&h)<<4|i>>2,f=(3&i)<<6|j,c+=String.fromCharCode(d),64!=i&&(c+=String.fromCharCode(e)),64!=j&&(c+=String.fromCharCode(f));while(k<b.length);return c}};return b}(),MD5=function(){var a=0,b="",c=8,d=function(a,b){var c=(65535&a)+(65535&b),d=(a>>16)+(b>>16)+(c>>16);return d<<16|65535&c},e=function(a,b){return a<<b|a>>>32-b},f=function(a){for(var b=[],d=(1<<c)-1,e=0;e<a.length*c;e+=c)b[e>>5]|=(a.charCodeAt(e/c)&d)<<e%32;return b},g=function(a){for(var b="",d=(1<<c)-1,e=0;e<32*a.length;e+=c)b+=String.fromCharCode(a[e>>5]>>>e%32&d);return b},h=function(b){for(var c=a?"0123456789ABCDEF":"0123456789abcdef",d="",e=0;e<4*b.length;e++)d+=c.charAt(15&b[e>>2]>>8*(e%4)+4)+c.charAt(15&b[e>>2]>>8*(e%4));return d},i=function(a){for(var e,f,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",d="",g=0;g<4*a.length;g+=3)for(e=(255&a[g>>2]>>8*(g%4))<<16|(255&a[g+1>>2]>>8*((g+1)%4))<<8|255&a[g+2>>2]>>8*((g+2)%4),f=0;4>f;f++)d+=8*g+6*f>32*a.length?b:c.charAt(63&e>>6*(3-f));return d},j=function(a,b,c,f,g,h){return d(e(d(d(b,a),d(f,h)),g),c)},k=function(a,b,c,d,e,f,g){return j(b&c|~b&d,a,b,e,f,g)},l=function(a,b,c,d,e,f,g){return j(b&d|c&~d,a,b,e,f,g)},m=function(a,b,c,d,e,f,g){return j(b^c^d,a,b,e,f,g)},n=function(a,b,c,d,e,f,g){return j(c^(b|~d),a,b,e,f,g)},o=function(a,b){a[b>>5]|=128<<b%32,a[(b+64>>>9<<4)+14]=b;for(var h,i,j,o,c=1732584193,e=-271733879,f=-1732584194,g=271733878,p=0;p<a.length;p+=16)h=c,i=e,j=f,o=g,c=k(c,e,f,g,a[p+0],7,-680876936),g=k(g,c,e,f,a[p+1],12,-389564586),f=k(f,g,c,e,a[p+2],17,606105819),e=k(e,f,g,c,a[p+3],22,-1044525330),c=k(c,e,f,g,a[p+4],7,-176418897),g=k(g,c,e,f,a[p+5],12,1200080426),f=k(f,g,c,e,a[p+6],17,-1473231341),e=k(e,f,g,c,a[p+7],22,-45705983),c=k(c,e,f,g,a[p+8],7,1770035416),g=k(g,c,e,f,a[p+9],12,-1958414417),f=k(f,g,c,e,a[p+10],17,-42063),e=k(e,f,g,c,a[p+11],22,-1990404162),c=k(c,e,f,g,a[p+12],7,1804603682),g=k(g,c,e,f,a[p+13],12,-40341101),f=k(f,g,c,e,a[p+14],17,-1502002290),e=k(e,f,g,c,a[p+15],22,1236535329),c=l(c,e,f,g,a[p+1],5,-165796510),g=l(g,c,e,f,a[p+6],9,-1069501632),f=l(f,g,c,e,a[p+11],14,643717713),e=l(e,f,g,c,a[p+0],20,-373897302),c=l(c,e,f,g,a[p+5],5,-701558691),g=l(g,c,e,f,a[p+10],9,38016083),f=l(f,g,c,e,a[p+15],14,-660478335),e=l(e,f,g,c,a[p+4],20,-405537848),c=l(c,e,f,g,a[p+9],5,568446438),g=l(g,c,e,f,a[p+14],9,-1019803690),f=l(f,g,c,e,a[p+3],14,-187363961),e=l(e,f,g,c,a[p+8],20,1163531501),c=l(c,e,f,g,a[p+13],5,-1444681467),g=l(g,c,e,f,a[p+2],9,-51403784),f=l(f,g,c,e,a[p+7],14,1735328473),e=l(e,f,g,c,a[p+12],20,-1926607734),c=m(c,e,f,g,a[p+5],4,-378558),g=m(g,c,e,f,a[p+8],11,-2022574463),f=m(f,g,c,e,a[p+11],16,1839030562),e=m(e,f,g,c,a[p+14],23,-35309556),c=m(c,e,f,g,a[p+1],4,-1530992060),g=m(g,c,e,f,a[p+4],11,1272893353),f=m(f,g,c,e,a[p+7],16,-155497632),e=m(e,f,g,c,a[p+10],23,-1094730640),c=m(c,e,f,g,a[p+13],4,681279174),g=m(g,c,e,f,a[p+0],11,-358537222),f=m(f,g,c,e,a[p+3],16,-722521979),e=m(e,f,g,c,a[p+6],23,76029189),c=m(c,e,f,g,a[p+9],4,-640364487),g=m(g,c,e,f,a[p+12],11,-421815835),f=m(f,g,c,e,a[p+15],16,530742520),e=m(e,f,g,c,a[p+2],23,-995338651),c=n(c,e,f,g,a[p+0],6,-198630844),g=n(g,c,e,f,a[p+7],10,1126891415),f=n(f,g,c,e,a[p+14],15,-1416354905),e=n(e,f,g,c,a[p+5],21,-57434055),c=n(c,e,f,g,a[p+12],6,1700485571),g=n(g,c,e,f,a[p+3],10,-1894986606),f=n(f,g,c,e,a[p+10],15,-1051523),e=n(e,f,g,c,a[p+1],21,-2054922799),c=n(c,e,f,g,a[p+8],6,1873313359),g=n(g,c,e,f,a[p+15],10,-30611744),f=n(f,g,c,e,a[p+6],15,-1560198380),e=n(e,f,g,c,a[p+13],21,1309151649),c=n(c,e,f,g,a[p+4],6,-145523070),g=n(g,c,e,f,a[p+11],10,-1120210379),f=n(f,g,c,e,a[p+2],15,718787259),e=n(e,f,g,c,a[p+9],21,-343485551),c=d(c,h),e=d(e,i),f=d(f,j),g=d(g,o);return[c,e,f,g]},p=function(a,b){var d=f(a);d.length>16&&(d=o(d,a.length*c));for(var e=Array(16),g=Array(16),h=0;16>h;h++)e[h]=909522486^d[h],g[h]=1549556828^d[h];var i=o(e.concat(f(b)),512+b.length*c);return o(g.concat(i),640)},q={hexdigest:function(a){return h(o(f(a),a.length*c))},b64digest:function(a){return i(o(f(a),a.length*c))},hash:function(a){return g(o(f(a),a.length*c))},hmac_hexdigest:function(a,b){return h(p(a,b))},hmac_b64digest:function(a,b){return i(p(a,b))},hmac_hash:function(a,b){return g(p(a,b))},test:function(){return"900150983cd24fb0d6963f7d28e17f72"===MD5.hexdigest("abc")}};return q}();Function.prototype.bind||(Function.prototype.bind=function(a){var b=this,c=Array.prototype.slice,d=Array.prototype.concat,e=c.call(arguments,1);return function(){return b.apply(a?a:this,d.call(e,c.call(arguments,0)))}}),Array.prototype.indexOf||(Array.prototype.indexOf=function(a){var b=this.length,c=Number(arguments[1])||0;for(c=0>c?Math.ceil(c):Math.floor(c),0>c&&(c+=b);b>c;c++)if(c in this&&this[c]===a)return c;return-1}),function(a){function f(a){return new b.Builder("presence",a)}function e(a){return new b.Builder("iq",a)}function d(a){return new b.Builder("message",a)}function c(a,c){return new b.Builder(a,c)}var b;b={VERSION:"@VERSION@",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas"},addNamespace:function(a,c){b.NS[a]=c},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3},TIMEOUT:1.1,SECONDARY_TIMEOUT:.1,forEachChild:function(a,c,d){var e,f;for(e=0;e<a.childNodes.length;e++)f=a.childNodes[e],f.nodeType==b.ElementType.NORMAL&&(!c||this.isTagEqual(f,c))&&d(f)},isTagEqual:function(a,b){return a.tagName.toLowerCase()==b.toLowerCase()},_xmlGenerator:null,_makeGenerator:function(){var a;return window.ActiveXObject?(a=this._getIEXmlDom(),a.appendChild(a.createElement("strophe"))):a=document.implementation.createDocument("jabber:client","strophe",null),a},xmlGenerator:function(){return b._xmlGenerator||(b._xmlGenerator=b._makeGenerator()),b._xmlGenerator},_getIEXmlDom:function(){for(var a=null,b=["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.5.0","Msxml2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"],c=0;c<b.length&&null===a;c++)try{a=new ActiveXObject(b[c])}catch(d){a=null}return a},xmlElement:function(a){if(!a)return null;var d,e,f,c=b.xmlGenerator().createElement(a);for(d=1;d<arguments.length;d++)if(arguments[d])if("string"==typeof arguments[d]||"number"==typeof arguments[d])c.appendChild(b.xmlTextNode(arguments[d]));else if("object"==typeof arguments[d]&&"function"==typeof arguments[d].sort)for(e=0;e<arguments[d].length;e++)"object"==typeof arguments[d][e]&&"function"==typeof arguments[d][e].sort&&c.setAttribute(arguments[d][e][0],arguments[d][e][1]);else if("object"==typeof arguments[d])for(f in arguments[d])arguments[d].hasOwnProperty(f)&&c.setAttribute(f,arguments[d][f]);return c},xmlescape:function(a){return a=a.replace(/\&/g,"&amp;"),a=a.replace(/</g,"&lt;"),a=a.replace(/>/g,"&gt;"),a},xmlTextNode:function(a){return a=b.xmlescape(a),b.xmlGenerator().createTextNode(a)},getText:function(a){if(!a)return null;var c="";0===a.childNodes.length&&a.nodeType==b.ElementType.TEXT&&(c+=a.nodeValue);for(var d=0;d<a.childNodes.length;d++)a.childNodes[d].nodeType==b.ElementType.TEXT&&(c+=a.childNodes[d].nodeValue);return c},copyElement:function(a){var c,d;if(a.nodeType==b.ElementType.NORMAL){for(d=b.xmlElement(a.tagName),c=0;c<a.attributes.length;c++)d.setAttribute(a.attributes[c].nodeName.toLowerCase(),a.attributes[c].value);for(c=0;c<a.childNodes.length;c++)d.appendChild(b.copyElement(a.childNodes[c]))}else a.nodeType==b.ElementType.TEXT&&(d=b.xmlTextNode(a.nodeValue));return d},escapeNode:function(a){return a.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(a){return a.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")
},getNodeFromJid:function(a){return a.indexOf("@")<0?null:a.split("@")[0]},getDomainFromJid:function(a){var c=b.getBareJidFromJid(a);if(c.indexOf("@")<0)return c;var d=c.split("@");return d.splice(0,1),d.join("@")},getResourceFromJid:function(a){var b=a.split("/");return b.length<2?null:(b.splice(0,1),b.join("/"))},getBareJidFromJid:function(a){return a?a.split("/")[0]:null},log:function(){},debug:function(a){this.log(this.LogLevel.DEBUG,a)},info:function(a){this.log(this.LogLevel.INFO,a)},warn:function(a){this.log(this.LogLevel.WARN,a)},error:function(a){this.log(this.LogLevel.ERROR,a)},fatal:function(a){this.log(this.LogLevel.FATAL,a)},serialize:function(a){var c;if(!a)return null;"function"==typeof a.tree&&(a=a.tree());var e,f,d=a.nodeName;for(a.getAttribute("_realname")&&(d=a.getAttribute("_realname")),c="<"+d,e=0;e<a.attributes.length;e++)"_realname"!=a.attributes[e].nodeName&&(c+=" "+a.attributes[e].nodeName.toLowerCase()+"='"+a.attributes[e].value.replace(/&/g,"&amp;").replace(/\'/g,"&apos;").replace(/</g,"&lt;")+"'");if(a.childNodes.length>0){for(c+=">",e=0;e<a.childNodes.length;e++)f=a.childNodes[e],f.nodeType==b.ElementType.NORMAL?c+=b.serialize(f):f.nodeType==b.ElementType.TEXT&&(c+=f.nodeValue);c+="</"+d+">"}else c+="/>";return c},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(a,c){b._connectionPlugins[a]=c}},b.Builder=function(a,c){("presence"==a||"message"==a||"iq"==a)&&(c&&!c.xmlns?c.xmlns=b.NS.CLIENT:c||(c={xmlns:b.NS.CLIENT})),this.nodeTree=b.xmlElement(a,c),this.node=this.nodeTree},b.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return b.serialize(this.nodeTree)},up:function(){return this.node=this.node.parentNode,this},attrs:function(a){for(var b in a)a.hasOwnProperty(b)&&this.node.setAttribute(b,a[b]);return this},c:function(a,c){var d=b.xmlElement(a,c);return this.node.appendChild(d),this.node=d,this},cnode:function(a){var c=b.xmlGenerator(),d=c.importNode?c.importNode(a,!0):b.copyElement(a);return this.node.appendChild(d),this.node=d,this},t:function(a){var c=b.xmlTextNode(a);return this.node.appendChild(c),this}},b.Handler=function(a,c,d,e,f,g,h){this.handler=a,this.ns=c,this.name=d,this.type=e,this.id=f,this.options=h||{matchbare:!1},this.options.matchBare||(this.options.matchBare=!1),this.from=this.options.matchBare?g?b.getBareJidFromJid(g):null:g,this.user=!0},b.Handler.prototype={isMatch:function(a){var c,d=null;if(d=this.options.matchBare?b.getBareJidFromJid(a.getAttribute("from")):a.getAttribute("from"),c=!1,this.ns){var e=this;b.forEachChild(a,null,function(a){a.getAttribute("xmlns")==e.ns&&(c=!0)}),c=c||a.getAttribute("xmlns")==this.ns}else c=!0;return!c||this.name&&!b.isTagEqual(a,this.name)||this.type&&a.getAttribute("type")!=this.type||this.id&&a.getAttribute("id")!=this.id||this.from&&d!=this.from?!1:!0},run:function(a){var c=null;try{c=this.handler(a)}catch(d){throw d.sourceURL?b.fatal("error: "+this.handler+" "+d.sourceURL+":"+d.line+" - "+d.name+": "+d.message):d.fileName?("undefined"!=typeof console&&(console.trace(),console.error(this.handler," - error - ",d,d.message)),b.fatal("error: "+this.handler+" "+d.fileName+":"+d.lineNumber+" - "+d.name+": "+d.message)):b.fatal("error: "+this.handler),d}return c},toString:function(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}},b.TimedHandler=function(a,b){this.period=a,this.handler=b,this.lastCalled=(new Date).getTime(),this.user=!0},b.TimedHandler.prototype={run:function(){return this.lastCalled=(new Date).getTime(),this.handler()},reset:function(){this.lastCalled=(new Date).getTime()},toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}},b.Request=function(a,c,d,e){this.id=++b._requestId,this.xmlData=a,this.data=b.serialize(a),this.origFunc=c,this.func=c,this.rid=d,this.date=0/0,this.sends=e||0,this.abort=!1,this.dead=null,this.age=function(){if(!this.date)return 0;var a=new Date;return(a-this.date)/1e3},this.timeDead=function(){if(!this.dead)return 0;var a=new Date;return(a-this.dead)/1e3},this.xhr=this._newXHR()},b.Request.prototype={getResponse:function(){var a=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){if(a=this.xhr.responseXML.documentElement,"parsererror"==a.tagName)throw b.error("invalid response received"),b.error("responseText: "+this.xhr.responseText),b.error("responseXML: "+b.serialize(this.xhr.responseXML)),"parsererror"}else this.xhr.responseText&&(b.error("invalid response received"),b.error("responseText: "+this.xhr.responseText),b.error("responseXML: "+b.serialize(this.xhr.responseXML)));return a},_newXHR:function(){var a=null;return window.XMLHttpRequest?(a=new XMLHttpRequest,a.overrideMimeType&&a.overrideMimeType("text/xml")):window.ActiveXObject&&(a=new ActiveXObject("Microsoft.XMLHTTP")),a.onreadystatechange=this.func.bind(null,this),a}},b.Connection=function(a){this.service=a,this.jid="",this.rid=Math.floor(4294967295*Math.random()),this.sid=null,this.streamId=null,this.features=null,this.do_session=!1,this.do_bind=!1,this.timedHandlers=[],this.handlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this._idleTimeout=null,this._disconnectTimeout=null,this.authenticated=!1,this.disconnecting=!1,this.connected=!1,this.errors=0,this.paused=!1,this.hold=1,this.wait=60,this.window=5,this._data=[],this._requests=[],this._uniqueId=Math.round(1e4*Math.random()),this._sasl_success_handler=null,this._sasl_failure_handler=null,this._sasl_challenge_handler=null,this._idleTimeout=setTimeout(this._onIdle.bind(this),100);for(var c in b._connectionPlugins)if(b._connectionPlugins.hasOwnProperty(c)){var d=b._connectionPlugins[c],e=function(){};e.prototype=d,this[c]=new e,this[c].init(this)}},b.Connection.prototype={reset:function(){this.rid=Math.floor(4294967295*Math.random()),this.sid=null,this.streamId=null,this.do_session=!1,this.do_bind=!1,this.timedHandlers=[],this.handlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this.authenticated=!1,this.disconnecting=!1,this.connected=!1,this.errors=0,this._requests=[],this._uniqueId=Math.round(1e4*Math.random())},pause:function(){this.paused=!0},resume:function(){this.paused=!1},getUniqueId:function(a){return"string"==typeof a||"number"==typeof a?++this._uniqueId+":"+a:++this._uniqueId+""},connect:function(a,c,d,e,f,g){this.jid=a,this.pass=c,this.connect_callback=d,this.disconnecting=!1,this.connected=!1,this.authenticated=!1,this.errors=0,this.wait=e||this.wait,this.hold=f||this.hold,this.domain=b.getDomainFromJid(this.jid);var h=this._buildBody().attrs({to:this.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":b.NS.BOSH});g&&h.attrs({route:g}),this._changeConnectStatus(b.Status.CONNECTING,null),this._requests.push(new b.Request(h.tree(),this._onRequestStateChange.bind(this,this._connect_cb.bind(this)),h.tree().getAttribute("rid"))),this._throttledRequestHandler()},attach:function(a,c,d,e,f,g,h){this.jid=a,this.sid=c,this.rid=d,this.connect_callback=e,this.domain=b.getDomainFromJid(this.jid),this.authenticated=!0,this.connected=!0,this.wait=f||this.wait,this.hold=g||this.hold,this.window=h||this.window,this._changeConnectStatus(b.Status.ATTACHED,null)},xmlInput:function(){},xmlOutput:function(){},rawInput:function(){},rawOutput:function(){},send:function(a){if(null!==a){if("function"==typeof a.sort)for(var b=0;b<a.length;b++)this._queueData(a[b]);else"function"==typeof a.tree?this._queueData(a.tree()):this._queueData(a);this._throttledRequestHandler(),clearTimeout(this._idleTimeout),this._idleTimeout=setTimeout(this._onIdle.bind(this),100)}},flush:function(){clearTimeout(this._idleTimeout),this._onIdle()},sendIQ:function(a,b,c,d){var e=null,f=this;"function"==typeof a.tree&&(a=a.tree());var g=a.getAttribute("id");g||(g=this.getUniqueId("sendIQ"),a.setAttribute("id",g));var h=this.addHandler(function(a){e&&f.deleteTimedHandler(e);var d=a.getAttribute("type");if("result"==d)b&&b(a);else{if("error"!=d)throw{name:"StropheError",message:"Got bad IQ type of "+d};c&&c(a)}},null,"iq",null,g);return d&&(e=this.addTimedHandler(d,function(){return f.deleteHandler(h),c&&c(null),!1})),this.send(a),g},_queueData:function(a){if(null===a||!a.tagName||!a.childNodes)throw{name:"StropheError",message:"Cannot queue non-DOMElement."};this._data.push(a)},_sendRestart:function(){this._data.push("restart"),this._throttledRequestHandler(),clearTimeout(this._idleTimeout),this._idleTimeout=setTimeout(this._onIdle.bind(this),100)},addTimedHandler:function(a,c){var d=new b.TimedHandler(a,c);return this.addTimeds.push(d),d},deleteTimedHandler:function(a){this.removeTimeds.push(a)},addHandler:function(a,c,d,e,f,g,h){var i=new b.Handler(a,c,d,e,f,g,h);return this.addHandlers.push(i),i},deleteHandler:function(a){this.removeHandlers.push(a)},disconnect:function(a){this._changeConnectStatus(b.Status.DISCONNECTING,a),b.info("Disconnect was called because: "+a),this.connected&&(this._disconnectTimeout=this._addSysTimedHandler(3e3,this._onDisconnectTimeout.bind(this)),this._sendTerminate())},_changeConnectStatus:function(a,c){for(var d in b._connectionPlugins)if(b._connectionPlugins.hasOwnProperty(d)){var e=this[d];if(e.statusChanged)try{e.statusChanged(a,c)}catch(f){b.error(""+d+" plugin caused an exception "+"changing status: "+f)}}if(this.connect_callback)try{this.connect_callback(a,c)}catch(g){b.error("User connection callback caused an exception: "+g)}},_buildBody:function(){var a=c("body",{rid:this.rid++,xmlns:b.NS.HTTPBIND});return null!==this.sid&&a.attrs({sid:this.sid}),a},_removeRequest:function(a){b.debug("removing request");var c;for(c=this._requests.length-1;c>=0;c--)a==this._requests[c]&&this._requests.splice(c,1);a.xhr.onreadystatechange=function(){},this._throttledRequestHandler()},_restartRequest:function(a){var b=this._requests[a];null===b.dead&&(b.dead=new Date),this._processRequest(a)},_processRequest:function(a){var c=this._requests[a],d=-1;try{4==c.xhr.readyState&&(d=c.xhr.status)}catch(e){b.error("caught an error in _requests["+a+"], reqStatus: "+d)}if("undefined"==typeof d&&(d=-1),c.sends>5)this._onDisconnectTimeout();else{var f=c.age(),g=!isNaN(f)&&f>Math.floor(b.TIMEOUT*this.wait),h=null!==c.dead&&c.timeDead()>Math.floor(b.SECONDARY_TIMEOUT*this.wait),i=4==c.xhr.readyState&&(1>d||d>=500);if((g||h||i)&&(h&&b.error("Request "+this._requests[a].id+" timed out (secondary), restarting"),c.abort=!0,c.xhr.abort(),c.xhr.onreadystatechange=function(){},this._requests[a]=new b.Request(c.xmlData,c.origFunc,c.rid,c.sends),c=this._requests[a]),0===c.xhr.readyState){b.debug("request id "+c.id+"."+c.sends+" posting"),c.date=new Date;try{c.xhr.open("POST",this.service,!0)}catch(j){return b.error("XHR open failed."),this.connected||this._changeConnectStatus(b.Status.CONNFAIL,"bad-service"),this.disconnect(),void 0}var k=function(){c.xhr.send(c.data)};if(c.sends>1){var l=1e3*Math.pow(c.sends,3);setTimeout(k,l)}else k();c.sends++,this.xmlOutput(c.xmlData),this.rawOutput(c.data)}else b.debug("_processRequest: "+(0===a?"first":"second")+" request has readyState of "+c.xhr.readyState)}},_throttledRequestHandler:function(){this._requests?b.debug("_throttledRequestHandler called with "+this._requests.length+" requests"):b.debug("_throttledRequestHandler called with undefined requests"),!!this._requests&&0!==this._requests.length&&(this._requests.length>0&&this._processRequest(0),this._requests.length>1&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window&&this._processRequest(1))},_onRequestStateChange:function(a,c){if(b.debug("request id "+c.id+"."+c.sends+" state changed to "+c.xhr.readyState),c.abort)c.abort=!1;else{var d;if(4==c.xhr.readyState){d=0;try{d=c.xhr.status}catch(e){}if("undefined"==typeof d&&(d=0),this.disconnecting&&d>=400)return this._hitError(d),void 0;var f=this._requests[0]==c,g=this._requests[1]==c;(d>0&&500>d||c.sends>5)&&(this._removeRequest(c),b.debug("request id "+c.id+" should now be removed")),200==d?((g||f&&this._requests.length>0&&this._requests[0].age()>Math.floor(b.SECONDARY_TIMEOUT*this.wait))&&this._restartRequest(0),b.debug("request id "+c.id+"."+c.sends+" got 200"),a(c),this.errors=0):(b.error("request id "+c.id+"."+c.sends+" error "+d+" happened"),(0===d||d>=400&&600>d||d>=12e3)&&(this._hitError(d),d>=400&&500>d&&(this._changeConnectStatus(b.Status.DISCONNECTING,null),this._doDisconnect()))),d>0&&500>d||c.sends>5||this._throttledRequestHandler()}}},_hitError:function(a){this.errors++,b.warn("request errored, status: "+a+", number of errors: "+this.errors),this.errors>4&&this._onDisconnectTimeout()},_doDisconnect:function(){b.info("_doDisconnect was called"),this.authenticated=!1,this.disconnecting=!1,this.sid=null,this.streamId=null,this.rid=Math.floor(4294967295*Math.random()),this.connected&&(this._changeConnectStatus(b.Status.DISCONNECTED,null),this.connected=!1),this.handlers=[],this.timedHandlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[]},_dataRecv:function(a){try{var c=a.getResponse()}catch(d){if("parsererror"!=d)throw d;this.disconnect("strophe-parsererror")}if(null!==c){this.xmlInput(c),this.rawInput(b.serialize(c));for(var e,f;this.removeHandlers.length>0;)f=this.removeHandlers.pop(),e=this.handlers.indexOf(f),e>=0&&this.handlers.splice(e,1);for(;this.addHandlers.length>0;)this.handlers.push(this.addHandlers.pop());if(this.disconnecting&&0===this._requests.length)return this.deleteTimedHandler(this._disconnectTimeout),this._disconnectTimeout=null,this._doDisconnect(),void 0;var h,i,g=c.getAttribute("type");if(null!==g&&"terminate"==g){if(this.disconnecting)return;return h=c.getAttribute("condition"),i=c.getElementsByTagName("conflict"),null!==h?("remote-stream-error"==h&&i.length>0&&(h="conflict"),this._changeConnectStatus(b.Status.CONNFAIL,h)):this._changeConnectStatus(b.Status.CONNFAIL,"unknown"),this.disconnect(),void 0}var j=this;b.forEachChild(c,null,function(a){var b,c;for(c=j.handlers,j.handlers=[],b=0;b<c.length;b++){var d=c[b];!d.isMatch(a)||!j.authenticated&&d.user?j.handlers.push(d):d.run(a)&&j.handlers.push(d)}})}},_sendTerminate:function(){b.info("_sendTerminate was called");var a=this._buildBody().attrs({type:"terminate"});this.authenticated&&a.c("presence",{xmlns:b.NS.CLIENT,type:"unavailable"}),this.disconnecting=!0;var c=new b.Request(a.tree(),this._onRequestStateChange.bind(this,this._dataRecv.bind(this)),a.tree().getAttribute("rid"));this._requests.push(c),this._throttledRequestHandler()},_connect_cb:function(a){b.info("_connect_cb was called"),this.connected=!0;var d=a.getResponse();if(d){this.xmlInput(d),this.rawInput(b.serialize(d));var g,h,f=d.getAttribute("type");if(null!==f&&"terminate"==f)return g=d.getAttribute("condition"),h=d.getElementsByTagName("conflict"),null!==g?("remote-stream-error"==g&&h.length>0&&(g="conflict"),this._changeConnectStatus(b.Status.CONNFAIL,g)):this._changeConnectStatus(b.Status.CONNFAIL,"unknown"),void 0;this.sid||(this.sid=d.getAttribute("sid")),this.stream_id||(this.stream_id=d.getAttribute("authid"));var i=d.getAttribute("requests");i&&(this.window=parseInt(i,10));var j=d.getAttribute("hold");j&&(this.hold=parseInt(j,10));var k=d.getAttribute("wait");k&&(this.wait=parseInt(k,10));var p,q,r,s,l=!1,m=!1,n=!1,o=d.getElementsByTagName("mechanism");if(!(o.length>0)){var t=this._buildBody();return this._requests.push(new b.Request(t.tree(),this._onRequestStateChange.bind(this,this._connect_cb.bind(this)),t.tree().getAttribute("rid"))),this._throttledRequestHandler(),void 0}for(p=0;p<o.length;p++)q=b.getText(o[p]),"DIGEST-MD5"==q?m=!0:"PLAIN"==q?l=!0:"ANONYMOUS"==q&&(n=!0);null===b.getNodeFromJid(this.jid)&&n?(this._changeConnectStatus(b.Status.AUTHENTICATING,null),this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),this.send(c("auth",{xmlns:b.NS.SASL,mechanism:"ANONYMOUS"}).tree())):null===b.getNodeFromJid(this.jid)?(this._changeConnectStatus(b.Status.CONNFAIL,"x-strophe-bad-non-anon-jid"),this.disconnect()):m?(this._changeConnectStatus(b.Status.AUTHENTICATING,null),this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge1_cb.bind(this),null,"challenge",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),this.send(c("auth",{xmlns:b.NS.SASL,mechanism:"DIGEST-MD5"}).tree())):l?(r=b.getBareJidFromJid(this.jid),r+="\x00",r+=b.getNodeFromJid(this.jid),r+="\x00",r+=this.pass,this._changeConnectStatus(b.Status.AUTHENTICATING,null),this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),s=Base64.encode(r),this.send(c("auth",{xmlns:b.NS.SASL,mechanism:"PLAIN"}).t(s).tree())):(this._changeConnectStatus(b.Status.AUTHENTICATING,null),this._addSysHandler(this._auth1_cb.bind(this),null,null,null,"_auth_1"),this.send(e({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:b.NS.AUTH}).c("username",{}).t(b.getNodeFromJid(this.jid)).tree()))}},_sasl_challenge1_cb:function(a){var k,d=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/,e=Base64.decode(b.getText(a)),f=MD5.hexdigest(1234567890*Math.random()),g="",h=null,i="",j="";for(this.deleteHandler(this._sasl_failure_handler);e.match(d);)switch(k=e.match(d),e=e.replace(k[0],""),k[2]=k[2].replace(/^"(.+)"$/,"$1"),k[1]){case"realm":g=k[2];break;case"nonce":i=k[2];break;case"qop":j=k[2];break;case"host":h=k[2]}var l="xmpp/"+this.domain;null!==h&&(l=l+"/"+h);var m=MD5.hash(b.getNodeFromJid(this.jid)+":"+g+":"+this.pass)+":"+i+":"+f,n="AUTHENTICATE:"+l,o="";return o+="username="+this._quote(b.getNodeFromJid(this.jid))+",",o+="realm="+this._quote(g)+",",o+="nonce="+this._quote(i)+",",o+="cnonce="+this._quote(f)+",",o+='nc="00000001",',o+='qop="auth",',o+="digest-uri="+this._quote(l)+",",o+="response="+this._quote(MD5.hexdigest(MD5.hexdigest(m)+":"+i+":00000001:"+f+":auth:"+MD5.hexdigest(n)))+",",o+='charset="utf-8"',this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge2_cb.bind(this),null,"challenge",null,null),this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),this.send(c("response",{xmlns:b.NS.SASL}).t(Base64.encode(o)).tree()),!1},_quote:function(a){return'"'+a.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'},_sasl_challenge2_cb:function(){return this.deleteHandler(this._sasl_success_handler),this.deleteHandler(this._sasl_failure_handler),this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),this.send(c("response",{xmlns:b.NS.SASL}).tree()),!1},_auth1_cb:function(){var c=e({type:"set",id:"_auth_2"}).c("query",{xmlns:b.NS.AUTH}).c("username",{}).t(b.getNodeFromJid(this.jid)).up().c("password").t(this.pass);return b.getResourceFromJid(this.jid)||(this.jid=b.getBareJidFromJid(this.jid)+"/strophe"),c.up().c("resource",{}).t(b.getResourceFromJid(this.jid)),this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2"),this.send(c.tree()),!1},_sasl_success_cb:function(){return b.info("SASL authentication succeeded."),this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._addSysHandler(this._sasl_auth1_cb.bind(this),null,"stream:features",null,null),this._sendRestart(),!1},_sasl_auth1_cb:function(a){this.features=a;var c,d;for(c=0;c<a.childNodes.length;c++)d=a.childNodes[c],"bind"==d.nodeName&&(this.do_bind=!0),"session"==d.nodeName&&(this.do_session=!0);if(!this.do_bind)return this._changeConnectStatus(b.Status.AUTHFAIL,null),!1;this._addSysHandler(this._sasl_bind_cb.bind(this),null,null,null,"_bind_auth_2");var f=b.getResourceFromJid(this.jid);return f?this.send(e({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:b.NS.BIND}).c("resource",{}).t(f).tree()):this.send(e({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:b.NS.BIND}).tree()),!1},_sasl_bind_cb:function(a){if("error"==a.getAttribute("type"))return b.info("SASL binding failed."),this._changeConnectStatus(b.Status.AUTHFAIL,null),!1;var d,c=a.getElementsByTagName("bind");return c.length>0?(d=c[0].getElementsByTagName("jid"),d.length>0&&(this.jid=b.getText(d[0]),this.do_session?(this._addSysHandler(this._sasl_session_cb.bind(this),null,null,null,"_session_auth_2"),this.send(e({type:"set",id:"_session_auth_2"}).c("session",{xmlns:b.NS.SESSION}).tree())):(this.authenticated=!0,this._changeConnectStatus(b.Status.CONNECTED,null))),void 0):(b.info("SASL binding failed."),this._changeConnectStatus(b.Status.AUTHFAIL,null),!1)},_sasl_session_cb:function(a){if("result"==a.getAttribute("type"))this.authenticated=!0,this._changeConnectStatus(b.Status.CONNECTED,null);else if("error"==a.getAttribute("type"))return b.info("Session creation failed."),this._changeConnectStatus(b.Status.AUTHFAIL,null),!1;return!1},_sasl_failure_cb:function(){return this._sasl_success_handler&&(this.deleteHandler(this._sasl_success_handler),this._sasl_success_handler=null),this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._changeConnectStatus(b.Status.AUTHFAIL,null),!1},_auth2_cb:function(a){return"result"==a.getAttribute("type")?(this.authenticated=!0,this._changeConnectStatus(b.Status.CONNECTED,null)):"error"==a.getAttribute("type")&&(this._changeConnectStatus(b.Status.AUTHFAIL,null),this.disconnect()),!1},_addSysTimedHandler:function(a,c){var d=new b.TimedHandler(a,c);return d.user=!1,this.addTimeds.push(d),d},_addSysHandler:function(a,c,d,e,f){var g=new b.Handler(a,c,d,e,f);return g.user=!1,this.addHandlers.push(g),g},_onDisconnectTimeout:function(){b.info("_onDisconnectTimeout was called");for(var a;this._requests.length>0;)a=this._requests.pop(),a.abort=!0,a.xhr.abort(),a.xhr.onreadystatechange=function(){};return this._doDisconnect(),!1},_onIdle:function(){for(var a,c,d,e;this.addTimeds.length>0;)this.timedHandlers.push(this.addTimeds.pop());for(;this.removeTimeds.length>0;)c=this.removeTimeds.pop(),a=this.timedHandlers.indexOf(c),a>=0&&this.timedHandlers.splice(a,1);var f=(new Date).getTime();for(e=[],a=0;a<this.timedHandlers.length;a++)c=this.timedHandlers[a],(this.authenticated||!c.user)&&(d=c.lastCalled+c.period,0>=d-f?c.run()&&e.push(c):e.push(c));this.timedHandlers=e;var g,h;if(this.authenticated&&0===this._requests.length&&0===this._data.length&&!this.disconnecting&&(b.info("no requests during idle cycle, sending blank request"),this._data.push(null)),this._requests.length<2&&this._data.length>0&&!this.paused){for(g=this._buildBody(),a=0;a<this._data.length;a++)null!==this._data[a]&&("restart"===this._data[a]?g.attrs({to:this.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":b.NS.BOSH}):g.cnode(this._data[a]).up());delete this._data,this._data=[],this._requests.push(new b.Request(g.tree(),this._onRequestStateChange.bind(this,this._dataRecv.bind(this)),g.tree().getAttribute("rid"))),this._processRequest(this._requests.length-1)}this._requests.length>0&&(h=this._requests[0].age(),null!==this._requests[0].dead&&this._requests[0].timeDead()>Math.floor(b.SECONDARY_TIMEOUT*this.wait)&&this._throttledRequestHandler(),h>Math.floor(b.TIMEOUT*this.wait)&&(b.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(b.TIMEOUT*this.wait)+" seconds since last activity"),this._throttledRequestHandler())),clearTimeout(this._idleTimeout),this._idleTimeout=setTimeout(this._onIdle.bind(this),100)}},a&&a(b,c,d,e,f)}(function(){window.Strophe=arguments[0],window.$build=arguments[1],window.$msg=arguments[2],window.$iq=arguments[3],window.$pres=arguments[4]}),function(undefined){var undefinedType="undefined";!function(name,definition){"undefined"!=typeof module?module.exports=definition():"function"==typeof define&&"object"==typeof define.amd?define(definition):this[name]=definition()}("log",function(){function realMethod(methodName){return typeof console===undefinedType?noop:console[methodName]===undefined?boundToConsole(console,"log")||noop:boundToConsole(console,methodName)}function boundToConsole(console,methodName){var method=console[methodName];return method.bind===undefined?Function.prototype.bind===undefined?function(){method.apply(console,arguments)}:Function.prototype.bind.call(console[methodName],console):console[methodName].bind(console)}function clearMethods(){for(var ii=0;ii<logMethods.length;ii++)self[logMethods[ii]]=noop}function cookiesAvailable(){return typeof window!==undefinedType&&window.document!==undefined&&window.document.cookie!==undefined}function setLevelInCookie(levelNum){if(cookiesAvailable()){var levelName;for(var key in self.levels)if(self.levels.hasOwnProperty(key)&&self.levels[key]===levelNum){levelName=key;break}levelName!==undefined&&(window.document.cookie="loglevel="+levelName+";")}}function loadLevelFromCookie(){var cookieLevel;if(cookiesAvailable()){var cookieMatch=cookieRegex.exec(window.document.cookie)||[];cookieLevel=cookieMatch[1]}self.setLevel(self.levels[cookieLevel]||self.levels.WARN)}var self={},noop=function(){},logMethods=["trace","debug","info","warn","error"],cookieRegex=/loglevel=([^;]+)/;self.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},self.setLevel=function(level){if("number"==typeof level&&level>=0&&level<=self.levels.SILENT){if(setLevelInCookie(level),level===self.levels.SILENT)return clearMethods(),void 0;if(typeof console===undefinedType)throw clearMethods(),"No console available for logging";for(var ii=0;ii<logMethods.length;ii++){var methodName=logMethods[ii];self[methodName]=level<=self.levels[methodName.toUpperCase()]?realMethod(methodName):noop}}else{if("string"!=typeof level)throw"log.setLevel() called with invalid level: "+level;self.setLevel(self.levels[level.toUpperCase()])}},self.enableAll=function(){self.setLevel(self.levels.TRACE)},self.disableAll=function(){self.setLevel(self.levels.SILENT)};try{loadLevelFromCookie()}catch(e){self.setLevel(self.levels.SILENT)}return self})}();var RTCPeerConnection=null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null;navigator.mozGetUserMedia?(console.log("This appears to be Firefox"),webrtcDetectedBrowser="firefox",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]),RTCPeerConnection=mozRTCPeerConnection,RTCSessionDescription=mozRTCSessionDescription,RTCIceCandidate=mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),createIceServer=function(url,username,password){var iceServer=null,url_parts=url.split(":");if(0===url_parts[0].indexOf("stun"))iceServer={url:url};else if(0===url_parts[0].indexOf("turn")&&(-1!==url.indexOf("transport=udp")||-1===url.indexOf("?transport"))){var turn_url_parts=url.split("?");iceServer={url:turn_url_parts[0],credential:password,username:username}}return iceServer},attachMediaStream=function(element,stream){console.log("Attaching media stream"),element.mozSrcObject=stream,element.play()},reattachMediaStream=function(to,from){console.log("Reattaching media stream"),to.mozSrcObject=from.mozSrcObject,to.play()},MediaStream.prototype.getVideoTracks=function(){return[]},MediaStream.prototype.getAudioTracks=function(){return[]}):navigator.webkitGetUserMedia?(console.log("This appears to be Chrome"),webrtcDetectedBrowser="chrome",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2]),createIceServer=function(url,username,password){var iceServer=null,url_parts=url.split(":");if(0===url_parts[0].indexOf("stun"))iceServer={url:url};else if(0===url_parts[0].indexOf("turn"))if(28>webrtcDetectedVersion){var url_turn_parts=url.split("turn:");iceServer={url:"turn:"+username+"@"+url_turn_parts[1],credential:password}}else iceServer={url:url,credential:password,username:username};return iceServer},RTCPeerConnection=webkitRTCPeerConnection,getUserMedia=navigator.webkitGetUserMedia.bind(navigator),attachMediaStream=function(element,stream){"undefined"!=typeof element.srcObject?element.srcObject=stream:"undefined"!=typeof element.mozSrcObject?element.mozSrcObject=stream:"undefined"!=typeof element.src?element.src=URL.createObjectURL(stream):console.log("Error attaching stream to element.")},reattachMediaStream=function(to,from){to.src=from.src},webkitMediaStream.prototype.getVideoTracks||(webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks},webkitMediaStream.prototype.getAudioTracks=function(){return this.audioTracks}),webkitRTCPeerConnection.prototype.getLocalStreams||(webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams},webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams})):console.log("Browser does not appear to be WebRTC-capable");var webrtc={};log.setLevel("debug"),Object.defineProperty(Object.prototype,"forOwn",{value:function(func){"use strict";for(var name in this)this.hasOwnProperty(name)&&func(this[name],name)},enumerable:!1,configurable:!1}),Object.defineProperty(Object.prototype,"isNumber",{value:function(number){"use strict";return!isNaN(parseFloat(number))&&isFinite(number)&&void 0===number.length},enumerable:!1,configurable:!1}),Object.defineProperty(Object.prototype,"publicize",{value:function(name,func){"use strict";return this[name]=func,func},enumerable:!1,configurable:!1}),webrtc.Class=function(params){"use strict";var that={className:"webrtc.Class"};return params=params||{},params.forOwn(function(thing,name){that[name]=thing}),that.publicize("getClass",function(){return that.className}),that},Q.longStackSupport=!0,Q.stackJumpLimit=5,Q.longStackJumpLimit=20,webrtc.EventThrower=function(params){"use strict";params=params||{};var that=webrtc.Class(params);that.className="webrtc.EventThrower";var eventList={};return that.publicize("listen",function(eventType,listener){eventList[eventType]=eventList[eventType]||[],"function"==typeof listener&&eventList[eventType].push(listener)}),that.publicize("ignore",function(eventType,listener){return void 0===eventType?(eventList={},void 0):void 0===listener?(eventList[eventType]=[],void 0):(eventList[eventType].reverse().forEach(function(eachListener,index){listener===eachListener&&eventList[eventType].splice(index,1)}),void 0)}),that.publicize("fire",function(eventType){if(eventType&&eventList[eventType]){var args=Array.prototype.slice.call(arguments,1);eventList[eventType].forEach(function(listener){if("function"==typeof listener)try{listener.apply(that,args)}catch(e){log.error("Error in "+that.className+"#"+eventType+": "+e.message),log.error(e.stack)}})}}),that},webrtc.Mercury=function(params){"use strict";params=params||{};var that=webrtc.EventThrower(params);that.className="webrtc.Mercury",window.location.hostname,window.location.port;var connected=!1,mediaSettings={constraints:params.constraints||[{video:{mandatory:{minWidth:640,minHeight:480}},audio:!0,optional:[],mandatory:{}}],servers:params.servers||{iceServers:[{url:"turn:toto@174.129.201.5:3478",credential:"password"}]}};that.appSettings={signalingChannel:"XMPPSignalingChannel",identityProvider:"XMPPIdentityProvider",chatMessage:"XMPPChatMessage",signalingMessage:"XMPPSignalingMessage",presenceMessage:"XMPPPresenceMessage"};var findClass=function(className){return webrtc[className]?webrtc[className]:window[className]?window[className]:void 0};return that.signalingChannel=findClass(that.appSettings.signalingChannel)(),that.identityProvider=findClass(that.appSettings.identityProvider)(),that.chatMessage=findClass(that.appSettings.chatMessage),that.signalingMessage=findClass(that.appSettings.signalingMessage),that.presenceMessage=findClass(that.appSettings.presenceMessage),that.mediaSession=findClass(that.appSettings.mediaSession),that.user=null,that.publicize("connect",function(){that.signalingChannel.open(),connected=!0
}),that.publicize("disconnect",function(){that.signalingChannel.close(),connected=!1}),that.publicize("login",function(userAccount,token){var userPromise=that.identityProvider.login(userAccount,token);return userPromise.then(function(user){user.setOnline(),that.user=user,log.info("logged in as user "+user.getID()),log.debug(user)},function(error){log.error(error.message)}).done(),userPromise}),that.publicize("logout",function(usernames){var userSession=that.user.getUserSession();(!usernames||userSession.userAccount in usernames)&&(that.identityProvider.logout(userSession.userAccount,userSession.token),userSession.loggedIn=!1)}),that.publicize("isConnected",function(){return!!connected}),that.publicize("isLoggedIn",function(){return that.user?!!that.user.getUserSession().isLoggedIn():!1}),that.publicize("getMediaSettings",function(){return mediaSettings}),that.publicize("setDefaultMediaSettings",function(settings){settings=settings||{},settings.constraints&&(mediaSettings.constraints=settings.constraints),settings.servers&&(mediaSettings.servers=settings.servers)}),that.publicize("getSignalingChannel",function(){return that.signalingChannel}),that},webrtc.IdentityProvider=function(params){"use strict";params=params||{};var that=webrtc.EventThrower(params);return that.className="webrtc.IdentityProvider",that.publicize("login",function(){}),that.publicize("logout",function(){}),that.publicize("isLoggedIn",function(){}),that},webrtc.ContactList=function(params){"use strict";params=params||{};var that=webrtc.EventThrower(params);that.className="webrtc.ContactList",that.length=0;var contacts={},presenceQueue=[];return that.publicize("add",function(contact){if(contact instanceof webrtc.Endpoint||!contact.getID)throw new Error("Can't add endpoint to list. Wrong type!");contact.getID()in contacts||(that.length+=1,that.fire("new",contact),contacts[contact.getID()]=contact)}),that.publicize("get",function(contactID){return contacts[contactID]}),that.publicize("remove",function(contactID){contacts.hasOwnProperty(contactID)&&(that.length-=1,that.fire("remove",contacts[contactID]),contacts[contactID]=void 0)}),that.publicize("getContacts",function(sortField){var values=[];return sortField=sortField||"id",contacts.forOwn(function(value){values.push(value)}),that.length=values.length,values=values.sort(function(a,b){return sortField in a&&sortField in b?webrtc.isNumber(a[sortField])&&webrtc.isNumber(b[sortField])?a[sortField]-b[sortField]:a.toLowerCase&&b.toLowerCase?a[sortField].toLowerCase()<b[sortField].toLowerCase()?-1:a[sortField].toLowerCase()>b[sortField].toLowerCase()?1:0:a[sortField]<b[sortField]?-1:a[sortField]>b[sortField]?1:0:(log.warn("sortField doesn't exist in both objects."),0)})}),that.publicize("queuePresence",function(message){presenceQueue.push(message)}),that.publicize("processPresenceQueue",function(){for(var i=0;i<=presenceQueue.length;i+=1)presenceQueue[i]&&that.fire("presence",presenceQueue[i]);presenceQueue=[]}),that},webrtc.Presentable=function(params){"use strict";params=params||{};var that=webrtc.EventThrower(params);that.className="webrtc.Presentable",that.name="Unknown",that.id="";var presence="unavailable",skills={video:{send:!0,receive:!0},audio:{send:!0,receive:!0}};return that.publicize("hasMedia",function(){return!1}),that.publicize("canSendAudio",function(){return skills.audio.send}),that.publicize("canSendVideo",function(){return skills.video.send}),that.publicize("getID",function(){return that.id}),that.publicize("getName",function(){return that.name}),that.publicize("getDisplayName",function(){return that.name}),that.publicize("getPresence",function(){return presence}),that.publicize("setPresence",function(newPresence){presence=newPresence,that.fire("presence",presence)}),that},webrtc.Endpoint=function(params){"use strict";params=params||{};var that=webrtc.Presentable(params);that.className="webrtc.Endpoint",that.mediaSessions=[];var signalingChannel=mercury.getSignalingChannel();return that.publicize("sendMessage",function(message){signalingChannel.isOpen()&&signalingChannel.send(message)}),that.publicize("startMedia",function(){}),that.publicize("stopMedia",function(){}),that},webrtc.User=function(params){"use strict";params=params||{};var that=webrtc.Presentable(params);that.className="webrtc.User";var contactList=[],userSession=webrtc.UserSession({token:params.token,timeLoggedIn:params.timeLoggedIn||new Date,loggedIn:params.loggedIn});return delete params.token,delete params.timeLoggedIn,delete params.loggedIn,that.publicize("getUserSession",function(){return userSession}),that.publicize("getContactList",function(){return contactList}),that.publicize("setOnline",function(){that.setPresence("available")}),that},webrtc.UserSession=function(params){"use strict";params=params||{};var that=webrtc.EventThrower(params);that.className="webrtc.UserSession";var token=params.token||"";params.timeLoggedIn||null;var loggedIn=params.loggedIn||!1;return delete params.token,delete params.timeLoggedIn,delete params.loggedIn,that.publicize("getAuthToken",function(){return token}),that.publicize("isLoggedIn",function(){return!!loggedIn}),that},webrtc.Contact=function(params){"use strict";params=params||{};var that=webrtc.Endpoint(params);return that.className="webrtc.Contact",that.publicize("getMessages",function(){}),that},webrtc.SignalingChannel=function(params){"use strict";params=params||{};var that=webrtc.EventThrower(params);that.className="webrtc.SignalingChannel";var state="new";return that.publicize("open",function(){state="open"}),that.publicize("close",function(){state="closed"}),that.publicize("getState",function(){return state}),that.publicize("isOpen",function(){return"open"===state}),that.publicize("send",function(){}),that},webrtc.Message=function(params){"use strict";params=params||{};var that=webrtc.Class(params);return that.className="webrtc.Message",that.publicize("parse",function(){}),that.publicize("getPayload",function(){}),that.publicize("getText",function(){}),that},webrtc.MediaSession=function(params){"use strict";params=params||{};var that=webrtc.EventThrower(params);that.className="webrtc.MediaSession",that.initiator||(that.initiator=!1);var pc=null,savedOffer=null,receivedAnswer=!1,receivedBye=!1,candidateSendingQueue=[],candidateReceivingQueue=[],mediaStreams=[],localVideoElements=params.localVideoElements||[],remoteVideoElements=params.remoteVideoElements||[],signalingChannel=mercury.getSignalingChannel(),remoteEndpoint=params.remoteEndpoint,signalInitiate=params.signalInitiate,signalAccept=params.signalAccept,signalTerminate=params.signalTerminate,signalReport=params.signalReport,signalCandidate=params.signalCandidate,mediaSettings=mercury.getMediaSettings(),options={optional:[{DtlsSrtpKeyAgreement:!0},{RtpDataChannels:!1}]};params.mediaSettings&&params.mediaSettings.constraints&&(mediaSettings.constraints=params.mediaSettings.constraints),params.mediaSettings&&params.mediaSettings.servers&&(mediaSettings.servers=params.mediaSettings.servers);var report={startCallCount:0,startCount:0,callStarted:0,callStopped:0,roomkey:null,sessionkey:null,lastSDPString:"",sdpsSent:[],sdpsReceived:[],candidatesSent:[],candidatesReceived:[],userAgent:navigator.userAgent,os:navigator.platform};that.publicize("start",function(){if(!that.username)throw new Error("Can't use a MediaSession without username.");report.startCount+=1,log.trace("calling requestMedia from start."),log.debug("I am "+(that.initiator?"":"not ")+"the initiator."),requestMedia()});var startCall=function(){log.trace("startCall"),report.startCallCount+=1,log.info("creating offer"),pc.createOffer(saveOfferAndSend,function(){log.error("createOffer failed")},null)},onReceiveUserMedia=function(stream,oneConstraints,index){var videoElement=null;if(log.debug("User gave permission to use media."),log.trace(onReceiveUserMedia),log.trace(stream),null===pc)return log.error("Peer connection is null!"),void 0;mediaStreams.push(webrtc.MediaStream({stream:stream,isLocal:!0})),stream.id=mercury.user.getID()+index,pc.addStream(stream);for(var i=0;i<localVideoElements.length&&null===videoElement;i+=1)"VIDEO"!==localVideoElements[i].tagName||localVideoElements[i].used||(videoElement=localVideoElements[i]);null===videoElement&&(videoElement=document.createElement("video")),videoElement.muted=!0,videoElement.autoplay=!0,attachMediaStream(videoElement,stream),setTimeout(function(){videoElement.play()},100),that.fire("stream:local:received",videoElement),videoElement.used=!0,1===mediaStreams.length&&(that.initiator?(that.fire("call:initiate"),startCall()):acceptCall())},requestMedia=function(){var now=new Date,toDelete=[],url="";report.callStarted=now.getTime(),log.trace(requestMedia);try{pc=new RTCPeerConnection(mediaSettings.servers,options)}catch(e){log.debug("Removing TURN servers.");for(var i in mediaSettings.servers.iceServers)mediaSettings.servers.iceServers.hasOwnProperty(i)&&(url=mediaSettings.servers.iceServers[i].url,url.toLowerCase().indexOf("turn")>-1&&toDelete.push(i));toDelete.sort(function(a,b){return b-a}),toDelete.forEach(function(value,index){mediaSettings.servers.iceServers.splice(index)}),pc=new RTCPeerConnection(mediaSettings.servers,options)}pc.onaddstream=onRemoteStreamAdded,pc.onremovestream=onRemoteStreamRemoved,pc.onicecandidate=onIceCandidate,pc.onnegotiationneeded=onNegotiationNeeded,pc.onstatechange=onStateChange,pc.onicechange=onIceChange,savedOffer&&(processOffer(savedOffer),savedOffer=null),mediaSettings.constraints.forOwn(function(oneConstraints,index){try{log.debug("Running getUserMedia with constraints"),log.debug(oneConstraints),getUserMedia(oneConstraints,function(p){onReceiveUserMedia(p,oneConstraints,index)},function(p){onUserMediaError(p,oneConstraints,index)})}catch(e){log.error("Couldn't get user media: "+e.message)}})},onUserMediaError=function(p){log.trace("onUserMediaError"),1===p.code?(log.warn("Permission denied."),report.callStoppedReason="Permission denied."):(log.warn(p),report.callStoppedReason=p.code),stopMedia(!that.initiator)},acceptCall=function(){log.trace("acceptCall"),savedOffer?(processOffer(savedOffer),savedOffer=null):(log.error("Can't process offer--no SDP!"),stopMedia(!0))},onRemoteStreamRemoved=function(){log.trace("pc event: remote stream removed")},onRemoteStreamAdded=function(evt){var videoElement=null;log.trace("received remote media");for(var i=0;i<remoteVideoElements.length&&null===videoElement;i+=1)"VIDEO"!==remoteVideoElements[i].tagName||remoteVideoElements[i].used||(videoElement=remoteVideoElements[i]);null===videoElement&&(videoElement=document.createElement("video")),videoElement.autoplay=!0,attachMediaStream(videoElement,evt.stream),setTimeout(function(){videoElement.play()},100),that.fire("stream:remote:received",videoElement),videoElement.used=!0,mediaStreams.push(webrtc.MediaStream({stream:evt.stream,isLocal:!1}))},onStateChange=function(p){log.trace("iceState is "+p.currentTarget.iceState),log.trace("readyState is "+p.currentTarget.readyState)},onIceChange=function(p){log.trace("pc event: ice changed"),log.trace(p)},onIceCandidate=function(oCan){oCan.candidate&&(log.trace("original browser-generated candidate object"),log.trace(oCan.candidate),that.initiator&&!receivedAnswer?candidateSendingQueue.push(oCan.candidate):that.initiator||(report.candidatesSent.push(oCan.candidate),signalCandidate(oCan.candidate)))},onNegotiationNeeded=function(){log.warn("Negotiation needed.")},processQueues=function(){var can=null;log.trace("Processing candidate queues.");for(var i=0;i<=candidateSendingQueue.length;i+=1)can=candidateSendingQueue[i],signalCandidate(can);candidateSendingQueue=[];for(var i=0;i<=candidateReceivingQueue.length;i+=1)can=candidateReceivingQueue[i],log.trace("Calling processCandidate in processQueues"),log.trace(can),processCandidate(can);candidateReceivingQueue=[]},saveOfferAndSend=function(oSession){oSession.type="offer",log.debug("setting and sending initiate"),log.debug(oSession),report.sdpsSent.push(oSession),pc.setLocalDescription(oSession,function(){signalInitiate(oSession)},function(p){log.error("setLocalDescription failed"),log.error(p)})},saveAnswerAndSend=function(oSession){oSession.type="answer",log.debug("setting and sending accept"),log.debug(oSession),report.sdpsSent.push(oSession),pc.setLocalDescription(oSession,function(){signalAccept(oSession)},function(p){log.error("setLocalDescription failed"),log.error(p)})},stopMedia=that.publicize("stopMedia",function(sendSignal){null!==pc&&(log.debug("hanging up"),sendSignal="boolean"==typeof sendSignal?sendSignal:!0,!receivedBye&&sendSignal&&(log.info("sending bye"),signalTerminate()),report.callStopped=(new Date).getTime(),signalReport(report),that.fire("hangup",sendSignal),that.ignore(),signalingChannel.ignore("received:offer",onOffer),signalingChannel.ignore("received:answer",onAnswer),signalingChannel.ignore("received:candidate",processCandidate),signalingChannel.ignore("received:bye",onBye),mediaStreams.forOwn(function(stream){stream.stop()}),pc&&pc.close(),mediaStreams=[],pc=null)}),processOffer=function(oSession){oSession.type="offer",log.trace("processOffer"),log.trace(oSession);try{pc.setRemoteDescription(new RTCSessionDescription(oSession),function(){log.debug("set remote desc of offer succeeded"),pc.createAnswer(saveAnswerAndSend,function(p){log.error("Error creating SDP answer."),report.callStoppedReason="Error creating SDP answer.",log.error(p)}),that.savedOffer=null},function(p){log.error("set remote desc of offer failed"),report.callStoppedReason="setLocalDescr failed at offer.",log.error(oSession),log.error(p),that.stopMedia()})}catch(e){log.error("error processing offer: "+e.message)}};that.publicize("isActive",function(){var inProgress=!1;return log.trace("isActive"),pc&&receivedBye!==!0?(inProgress=pc.readyState in["new","active"],log.info("readyState is "+pc.readyState+". Call is "+(inProgress?"":"not ")+"in progress."),inProgress):!1});var onOffer=function(oSession){log.debug("got offer"),log.debug(oSession),savedOffer=oSession,that.initiator?(log.warn("Got initiate in precall state."),signalTerminate()):(report.sdpsReceived.push(oSession),report.lastSDPString=oSession.sdp)},onAnswer=function(oSession){log.debug("remote side sdp is"),log.debug(oSession),savedOffer=oSession,receivedAnswer=!0,report.sdpsReceived.push(oSession),report.lastSDPString=oSession.sdp,pc.setRemoteDescription(new RTCSessionDescription(oSession),processQueues,function(){log.error("set remote desc of answer failed"),report.callStoppedReason="setRemoteDescription failed at answer.",log.error(oSession),that.stopMedia()})},processCandidate=function(oCan){if(!oCan||null===oCan.candidate)return log.info("End of candidates."),void 0;if(oCan.hasOwnProperty("sdpMLineIndex")&&oCan.candidate||(log.warn("processCandidate got wrong format!"),log.warn(oCan)),that.initiator&&!receivedAnswer)return candidateReceivingQueue.push(oCan),log.debug("Queueing a candidate."),void 0;try{pc.addIceCandidate(new RTCIceCandidate(oCan))}catch(e){log.error("Couldn't add ICE candidate: "+e.message),log.error(oCan)}report.candidatesReceived.push(oCan)};that.publicize("getState",function(){return pc?pc.readyState:"before"}),that.publicize("isInitiator",function(){return that.initiator}),that.publicize("getContactID",function(){return remoteEndpoint}),that.publicize("getStreams",function(){return mediaStreams}),that.publicize("getLocalStreams",function(){var streams=[];return mediaStreams.forOwn(function(stream){stream.isLocal()&&streams.push(stream)}),streams}),that.publicize("getRemoteStreams",function(){var streams=[];return mediaStreams.forOwn(function(stream){stream.isLocal()||streams.push(stream)}),streams}),that.publicize("toggleVideo",function(){that.isActive()&&(pc.localStreams[0].videoTracks[0].enabled?that.muteVideo():that.unmuteVideo())}),that.publicize("toggleAudio",function(){that.isActive()&&(pc.localStreams[0].audioTracks[0].enabled?that.muteAudio():that.unmuteAudio())}),that.publicize("muteVideo",function(){log.trace("muting video"),mediaStreams.forOwn(function(stream){stream.muteVideo()}),that.fire("video:muted")}),that.publicize("unmuteVideo",function(){log.trace("unmuting video"),mediaStreams.forOwn(function(stream){stream.unmuteVideo()}),that.fire("video:unmuted")}),that.publicize("muteAudio",function(){log.trace("muting audio"),mediaStreams.forOwn(function(stream){stream.muteAudio()}),that.fire("audio:muted")}),that.publicize("unmuteAudio",function(){log.trace("unmuting audio"),mediaStreams.forOwn(function(stream){stream.unmuteAudio()}),that.fire("audio:unmuted")});var onBye=function(){receivedBye=!0,stopMedia()};return signalingChannel.listen("received:offer",onOffer),signalingChannel.listen("received:answer",onAnswer),signalingChannel.listen("received:candidate",processCandidate),signalingChannel.listen("received:bye",onBye),that},webrtc.MediaStream=function(params){"use strict";params=params||{};var that=webrtc.EventThrower(params);that.className="webrtc.MediaStream";var stream=params.stream,local=params.isLocal;that.publicize("stop",function(){stream.stop()}),that.publicize("muteAudio",function(){stream.audioTracks[0].enabled=!1,that.fire("audio:muted")}),that.publicize("muteVideo",function(){stream.videoTracks[0].enabled=!1,that.fire("video:muted")}),that.publicize("unmuteAudio",function(){stream.audioTracks[0].enabled=!0,that.fire("audio:unmuted")}),that.publicize("unmuteVideo",function(){stream.videoTracks[0].enabled=!0,that.fire("video:unmuted")});var isLocal=that.publicize("isLocal",function(){return!!local});return that.publicize("isRemote",function(){return!isLocal()}),that.publicize("getID",function(){return stream.id}),that.publicize("getURL",function(){}),that},webrtc.XMPPSignalingChannel=function(params){"use strict";params=params||{};var that=webrtc.SignalingChannel(params);that.className="webrtc.XMPPSignalingChannel";var state="new",BOSH_SERVICE="http://mercury.digiumlabs.com:5280/http-bind/",NS="mercury:signaling",stropheConnection=null;return that.publicize("open",function(){stropheConnection=new Strophe.Connection(BOSH_SERVICE),log.trace("Signaling connection open."),state="open"}),that.publicize("close",function(){stropheConnection.disconnect(),log.trace("Signaling connection closed."),state="closed"}),that.publicize("getState",function(){return state}),that.publicize("isOpen",function(){return"open"===state}),that.publicize("sendPresence",function(presenceString){var pres=null;switch(log.trace("Signaling sendPresence"),presenceString){case"":case null:case void 0:case!1:case"available":pres=$pres();break;case"unavailable":pres=$pres({type:"unavailable"});break;case"dnd":case"away":case"xa":pres=$pres().c("show",{}).t(presenceString);break;default:throw new Error("Can't send invalid presence "+presenceString+"!")}stropheConnection.send(pres.tree())}),that.publicize("requestRoster",function(myJID){var rosterStanza=null;if(log.trace("requestRoster"),!myJID)throw new Error("Can't request roster without JID.");rosterStanza=$iq({from:myJID,type:"get",id:"roster_1"}).c("query",{xmlns:Strophe.NS.ROSTER}).tree(),stropheConnection.send(rosterStanza)}),that.publicize("sendMessage",function(message){var stanza=message.getXMPP();stropheConnection.send(stanza.tree()),message.getRecipient().fire("message:sent",message)}),that.publicize("send",function(recipient,msgObj){var text="";return msgObj?recipient?recipient===stropheConnection.jid?(log.warn("Can't send, recipient is me!"),void 0):(log.debug("sending a "+msgObj.type),text=$msg({to:recipient,from:stropheConnection.jid,type:"signaling"}).c("signaling",{xmlns:NS}).t(escape(JSON.stringify(msgObj))).tree(),log.debug(text),stropheConnection.send(text),void 0):(log.warn("Can't send, recipient is "+recipient),void 0):(log.warn("Can't send, no message."),void 0)}),that.publicize("sendCandidate",function(recipient,candObj){var text="";if(!stropheConnection.jid||!recipient)throw new Error("Can't send without sender and recipient.`");text=$msg({to:recipient,from:stropheConnection.jid,type:"signaling"}).c("signaling",{xmlns:NS,type:"candidate"}).t(escape(JSON.stringify(candObj))).tree(),log.debug(text),stropheConnection.send(text)}),that.publicize("sendSDP",function(recipient,sdpObj){var text="";if(!stropheConnection.jid||!recipient)throw new Error("Can't send without sender and recipient.`");text=$msg({to:recipient,from:stropheConnection.jid,type:"signaling"}).c("signaling",{xmlns:NS,type:sdpObj.type}).t(escape(JSON.stringify(sdpObj))).tree(),log.debug(text),stropheConnection.send(text)}),that.publicize("sendBye",function(recipient,reason){var text="";if(!stropheConnection.jid||!recipient)throw new Error("Can't send without sender and recipient.`");text=$msg({to:recipient,from:stropheConnection.jid,type:"signaling"}).c("signaling",{xmlns:NS,type:"bye"}).t(escape(JSON.stringify({type:"bye",reason:reason}))).tree(),log.debug(text),stropheConnection.send(text)}),that.publicize("parseText",function(msgXML){var json={},sig=null,signalingElements=msgXML.getElementsByTagName("signaling");if(0===signalingElements.length)return null;sig=signalingElements[0],json.value=unescape(Strophe.getText(sig)),json.from=msgXML.getAttribute("from"),json.to=msgXML.getAttribute("to"),json.type=sig.getAttribute("type");try{json.value=JSON.parse(json.value)}catch(e){json.value=null,log.warn("Couldn't parse JSON from msg received: "+e.message)}return json}),that.publicize("routeSignal",function(message){mercury.user.getMediaSessionByContact(message.sender);var signal=message.getPayload();switch(signal.type){case"offer":case"answer":case"candidate":case"bye":that.fire("received:"+signal.type,signal.value);break;case"error":log.warn("Received an error"),log.warn(signal);break;default:log.error("Don't know what to do with msg of unknown type "+signal.type)}}),that.publicize("addHandler",function(type,handler){stropheConnection.addHandler(handler,null,type,null,null,null)}),that.publicize("authenticate",function(username,password,onStatusChange){stropheConnection.connect(username,password,onStatusChange)}),that},webrtc.XMPPIdentityProvider=function(params){"use strict";params=params||{};var that=webrtc.IdentityProvider(params);that.className="webrtc.XMPPIdentityProvider";var signalingChannel=null,loggedIn=!1;return that.publicize("login",function(username,password){var deferred=null;return log.trace("User login"),null===signalingChannel&&(signalingChannel=mercury.getSignalingChannel()),signalingChannel.isOpen()||signalingChannel.open(),deferred=Q.defer(),signalingChannel.authenticate(username,password,function(statusCode){var user=null;statusCode===Strophe.Status.CONNECTED?(log.info("Strophe is connected."),user=webrtc.XMPPUser({jid:username,loggedIn:!0}),deferred.resolve(user)):statusCode===Strophe.Status.ERROR?deferred.reject(new Error("Unknown error.")):statusCode===Strophe.Status.AUTHFAIL?deferred.reject(new Error("Authentication failure.")):statusCode===Strophe.Status.CONNFAIL?deferred.reject(new Error("Couldn't connect.")):statusCode===Strophe.Status.DISCONNECTED?deferred.reject(new Error("Got disconnected.")):statusCode===Strophe.Status.AUTHENTICATING||statusCode===Strophe.Status.ATTACHED||statusCode===Strophe.Status.CONNECTING||statusCode===Strophe.Status.DISCONNECTING||log.warn("unknown strophe connection status. "+statusCode)}),deferred.promise}),that.publicize("logout",function(){log.trace("User logout"),signalingChannel.listen("closed",function(){loggedIn=!1}),signalingChannel.close()}),that.publicize("isLoggedIn",function(){return!!loggedIn}),that},webrtc.XMPPPresentable=function(params){"use strict";params=params||{};var that=webrtc.Presentable(params);that.className="webrtc.XMPPPresentable",that.domain=null,that.username=null,that.emailFormat=null,that.resourceFormat=null,that.idstring=null;var resources=[],presence="unavailable";that.listen("signaling:received",function(message){try{mercury.getSignalingChannel().routeSignal(message)}catch(e){log.error("Couldn't route message: "+e.message)}});var init=function(){var resourcePieces=[],jidPieces=[];if(!that.jid)throw new Error("Can't use an XMPPPresentable without a JID.");if(resourcePieces=that.jid.split("/"),resourcePieces[1]&&resources.push({resource:resourcePieces[1],presence:"unavailable",show:""}),jidPieces=resourcePieces[0].split("@"),that.emailFormat=resourcePieces[0],that.id=resourcePieces[0],that.username=jidPieces[0],that.name=jidPieces[0],that.domain=jidPieces[1],!that.username||!that.domain||!that.emailFormat)throw new Error("Can't create an XMPPPresentable. "+that.jid+" is wrong format!");that.idstring=that.emailFormat.replace("@",".")};return that.publicize("getID",function(){return that.emailFormat}),that.publicize("getEmailFormat",function(){return that.emailFormat}),that.publicize("getResourceFormat",function(){return that.jid}),that.publicize("getIDString",function(){return that.idstring}),that.publicize("getDisplayName",function(){return that.name||that.username||that.jid||that.emailFormat}),that.publicize("getUsername",function(){return that.username}),that.publicize("matchesJID",function(jid){var pieces=[],regex=null;return jid&&that.jid?(pieces=jid.split("/"),regex=new RegExp("^"+that.username+"\\@"+that.domain+"\\/?\\w*$","i"),regex.test(pieces[0])):!1}),that.publicize("getStatus",function(){return presence}),that.jid&&init(),that},webrtc.XMPPEndpoint=function(params){"use strict";params=params||{};var that=webrtc.XMPPPresentable(params);that.className="webrtc.XMPPEndpoint";var signalingChannel=mercury.getSignalingChannel();return that.publicize("sendMessage",function(message){signalingChannel.sendMessage(webrtc.XMPPChatMessage({recipient:that,sender:mercury.user.getResourceFormat(),payload:message}))}),that.publicize("startMedia",function(mediaSettings,initiator){var id=that.getID(),mediaSession=null;return log.trace("startMedia"),void 0===initiator&&(initiator=!0),mediaSession=webrtc.MediaSession({username:mercury.user,remoteEndpoint:id,initiator:initiator,signalInitiate:function(sdp){sdp.type="offer",signalingChannel.sendSDP(id,sdp)},signalAccept:function(sdp){sdp.type="answer",signalingChannel.sendSDP(id,sdp)},signalCandidate:function(oCan){null!==oCan&&signalingChannel.sendCandidate(id,oCan)},signalTerminate:function(){signalingChannel.sendBye(id)},signalReport:function(oReport){log.debug("Not sending report"),log.debug(oReport)}}),mediaSession.start(),mercury.user.addMediaSession(mediaSession),mediaSession.listen("hangup",function(){mercury.user.removeMediaSession(id)}),mediaSession}),that},webrtc.XMPPContact=function(params){"use strict";params=params||{};var that=webrtc.XMPPEndpoint(params);that.className="webrtc.XMPPContact";var presence="unavailable",resources={};that.publicize("setPresence",function(presenceString,resourceID){presenceString=presenceString||"available",resources.hasOwnProperty(resourceID)||(resources[resourceID]={resourceID:resourceID,presence:presenceString}),resources[resourceID].presence=presenceString,resolvePresence()});var resolvePresence=function(){var options=[];resources.forOwn(function(resource){switch(options.push(resource.presence),resource.presence){case"chat":presence=resource.presence;break;case"available":presence in["chat"]||(presence=resource.presence);break;case"away":presence in["chat","available"]||(presence=resource.presence);break;case"dnd":presence in["chat","available","away"]||(presence=resource.presence);break;case"xa":presence in["chat","available","away","dnd"]||(presence=resource.presence)}}),presence||(presence="unavailable"),log.debug("presences "+options.join(", ")+" resolved to "+presence),that.fire("presence",presence)};return that},webrtc.XMPPUser=function(params){"use strict";params=params||{};var that=webrtc.XMPPPresentable(params);that.className="webrtc.XMPPUser";var mediaSessions=[],contactList=new webrtc.ContactList,presence="unavailable",signalingChannel=mercury.getSignalingChannel(),userSession=new webrtc.UserSession({token:params.token,timeLoggedIn:params.timeLoggedIn,loggedIn:params.loggedIn});that.listen("presence",function(presenceString){presence=presenceString,signalingChannel&&signalingChannel.isOpen()?(log.info("sending my presence update "+presenceString),signalingChannel.sendPresence(presenceString)):log.error("Can't send my presence: no signaling channel.")}),contactList.listen("new",function(contact){that.fire("contact:new",contact)}),contactList.listen("presence",function(presenceMessage){var presPayload=null,from=null,jid=null,resource=null,contact=null;try{if(presPayload=presenceMessage.getPayload(),"error"===presPayload.presence)return;if(from=presenceMessage.sender.split("/"),jid=from[0],resource=from[1],contact=this.get(jid),jid===that.jid&&resource!==that.resource)return this.remoteUserSessions[resource]={jid:that.jid,resource:resource,presence:presPayload.presence},void 0;if(!contact)return;contact.setPresence(presPayload.presence,resource)}catch(e){log.error("Couldn't update presence for contact "+that.jid+": "+e.message),log.error(e.stack),log.error(presenceMessage)}}),that.publicize("requestContacts",function(){var deferred=Q.defer(),itemElements=[];return userSession.isLoggedIn()?(deferred.promise.then(function(contactList){setTimeout(function(){contactList.processPresenceQueue()},1e3)}).done(),signalingChannel.addHandler("iq",function(stanza){return log.debug(stanza),itemElements=$j(stanza).find("item"),0===itemElements.length?(deferred.reject(new Error("No items in the roster.")),!0):(itemElements.each(function(){var sub=$j(this).attr("subscription"),jid=$j(this).attr("jid"),name=$j(this).attr("name"),contact=null;if(!sub||"to"===sub||"both"===sub){try{contact=new webrtc.XMPPContact({jid:jid,name:name,subscription:sub})}catch(e){return log.error("Couldn't create contact: "+e.message),void 0}contactList.add(contact)}}),deferred.resolve(contactList),!0)}),signalingChannel.requestRoster(that.getResourceFormat()),deferred.promise):(deferred.reject(new Error("Can't request contacts unless logged in.")),deferred.promise)}),that.publicize("getUserSession",function(){return userSession}),that.publicize("getActiveMediaSession",function(){var session=null;return mediaSessions.forEach(function(mediaSession){mediaSession.isActive()&&(session=mediaSession)}),session}),that.publicize("getMediaSessionByContact",function(contactJID){var session=null,contact=null;if(mediaSessions.forEach(function(mediaSession){mediaSession.remoteEndpoint===contactJID&&(session=mediaSession)}),null===session)try{contact=contactList.get(contactJID),session=contact.startMedia(mercury.getMediaSettings(),!1),addMediaSession(session)}catch(e){log.error("Couldn't create MediaSession: "+e.message)}return session});var addMediaSession=that.publicize("addMediaSession",function(mediaSession){mediaSessions.push(mediaSession),that.fire("media:started",mediaSession,mediaSession.getContactID())});return that.publicize("removeMediaSession",function(contactJID){var toDelete=null;return contactJID||(mediaSessions=[]),mediaSessions.forEach(function(mediaSession,index){mediaSession.remoteEndpoint===contactJID&&(toDelete=index)}),null===toDelete?(log.warn("Couldn't find mediaSession in removeMediaSession"),void 0):(mediaSessions.splice(toDelete),void 0)}),that.publicize("setOnline",function(){signalingChannel.addHandler("presence",function(stanza){log.debug(stanza);var message=mercury.presenceMessage({rawMessage:stanza,sender:stanza.getAttribute("from"),recipient:that});return 0===contactList.length?contactList.queuePresence(message):contactList.fire("presence",message),!0}),signalingChannel.addHandler("message",function(stanza){var from=stanza.getAttribute("from"),type=stanza.getAttribute("type"),fromPieces=[],contact=null,params=null;return log.debug(stanza),-1===["chat","signaling","groupchat"].indexOf(type)?(log.warn("wrong type "+type),!0):(fromPieces=from.split("/"),(contact=contactList.get(fromPieces[0]))?(params={rawMessage:stanza,recipient:that,sender:contact.getResourceFormat()},"signaling"===type?contact.fire("signaling:received",mercury.signalingMessage(params)):contact.fire("message:received",mercury.chatMessage(params)),!0):(log.info("no contact"),!0))
}),that.setPresence("available")}),that},webrtc.XMPPChatMessage=function(params){"use strict";params=params||{};var that=webrtc.Message(params);that.className="webrtc.XMPPChatMessage";var rawMessage=params.rawMessage,payload=params.payload,sender=params.sender,recipient=params.recipient,parse=that.publicize("parse",function(thisMsg){thisMsg&&(rawMessage=thisMsg);try{payload=Strophe.getText(rawMessage.getElementsByTagName("body")[0])}catch(e){log.error("Not an XMPP text message!")}});that.publicize("getXMPP",function(){return $msg({to:recipient.getEmailFormat(),from:sender,type:"chat"}).c("body").t(payload)});var getPayload=that.publicize("getPayload",function(){return payload});return that.publicize("getText",getPayload),that.publicize("getRecipient",function(){return recipient}),rawMessage&&parse(),that},webrtc.XMPPSignalingMessage=function(params){"use strict";params=params||{};var that=webrtc.Message(params);that.className="webrtc.XMPPSignalingMessage";var rawMessage=params.rawMessage,payload=null;params.sender;var recipient=params.recipient,parse=that.publicize("parse",function(){payload=mercury.getSignalingChannel().parseText(rawMessage)});return that.publicize("getText",function(){return payload.type}),that.publicize("getPayload",function(){return payload}),that.publicize("getRecipient",function(){return recipient}),rawMessage&&parse(),that},webrtc.XMPPPresenceMessage=function(params){"use strict";params=params||{};var that=webrtc.Message(params);that.className="webrtc.XMPPPresenceMessage";var rawMessage=params.rawMessage,payload={},sender=params.sender,recipient=params.recipient,parse=that.publicize("parse",function(thisMsg){var show="",showElements=[];thisMsg&&(rawMessage=thisMsg),payload.presence=rawMessage.getAttribute("type")||"available",showElements=$j(rawMessage).find("show"),0!==showElements.length&&(show=Strophe.getText(showElements[0]),show&&(payload.presence=show))});return that.publicize("getXMPP",function(){if(!payload)throw new Error("No message payload.");return $msg({to:recipient.getEmailFormat(),from:sender,type:"chat"}).c("body").t(payload)}),that.publicize("getText",function(){if(!payload)throw new Error("No message payload.");return payload.presence}),that.publicize("getPayload",function(){return payload}),that.publicize("getRecipient",function(){return recipient}),rawMessage&&parse(),that};