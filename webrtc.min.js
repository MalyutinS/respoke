function trace(text){"\n"==text[text.length-1]&&(text=text.substring(0,text.length-1)),console.log((performance.now()/1e3).toFixed(3)+": "+text)}var io="undefined"==typeof module?{}:module.exports;!function(){!function(exports,global){var io=exports;io.version="0.9.16",io.protocol=1,io.transports=[],io.j=[],io.sockets={},io.connect=function(host,details){var uuri,socket,uri=io.util.parseUri(host);global&&global.location&&(uri.protocol=uri.protocol||global.location.protocol.slice(0,-1),uri.host=uri.host||(global.document?global.document.domain:global.location.hostname),uri.port=uri.port||global.location.port),uuri=io.util.uniqueUri(uri);var options={host:uri.host,secure:"https"==uri.protocol,port:uri.port||("https"==uri.protocol?443:80),query:uri.query||""};return io.util.merge(options,details),(options["force new connection"]||!io.sockets[uuri])&&(socket=new io.Socket(options)),!options["force new connection"]&&socket&&(io.sockets[uuri]=socket),socket=socket||io.sockets[uuri],socket.of(uri.path.length>1?uri.path:"")}}("object"==typeof module?module.exports:this.io={},this),function(exports,global){var util=exports.util={},re=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,parts=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];util.parseUri=function(str){for(var m=re.exec(str||""),uri={},i=14;i--;)uri[parts[i]]=m[i]||"";return uri},util.uniqueUri=function(uri){var protocol=uri.protocol,host=uri.host,port=uri.port;return"document"in global?(host=host||document.domain,port=port||("https"==protocol&&"https:"!==document.location.protocol?443:document.location.port)):(host=host||"localhost",port||"https"!=protocol||(port=443)),(protocol||"http")+"://"+host+":"+(port||80)},util.query=function(base,addition){var query=util.chunkQuery(base||""),components=[];util.merge(query,util.chunkQuery(addition||""));for(var part in query)query.hasOwnProperty(part)&&components.push(part+"="+query[part]);return components.length?"?"+components.join("&"):""},util.chunkQuery=function(qs){for(var kv,query={},params=qs.split("&"),i=0,l=params.length;l>i;++i)kv=params[i].split("="),kv[0]&&(query[kv[0]]=kv[1]);return query};var pageLoaded=!1;util.load=function(fn){return"document"in global&&"complete"===document.readyState||pageLoaded?fn():(util.on(global,"load",fn,!1),void 0)},util.on=function(element,event,fn,capture){element.attachEvent?element.attachEvent("on"+event,fn):element.addEventListener&&element.addEventListener(event,fn,capture)},util.request=function(xdomain){if(xdomain&&"undefined"!=typeof XDomainRequest&&!util.ua.hasCORS)return new XDomainRequest;if("undefined"!=typeof XMLHttpRequest&&(!xdomain||util.ua.hasCORS))return new XMLHttpRequest;if(!xdomain)try{return new(window[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(e){}return null},"undefined"!=typeof window&&util.load(function(){pageLoaded=!0}),util.defer=function(fn){return util.ua.webkit&&"undefined"==typeof importScripts?(util.load(function(){setTimeout(fn,100)}),void 0):fn()},util.merge=function(target,additional,deep,lastseen){var prop,seen=lastseen||[],depth="undefined"==typeof deep?2:deep;for(prop in additional)additional.hasOwnProperty(prop)&&util.indexOf(seen,prop)<0&&("object"==typeof target[prop]&&depth?util.merge(target[prop],additional[prop],depth-1,seen):(target[prop]=additional[prop],seen.push(additional[prop])));return target},util.mixin=function(ctor,ctor2){util.merge(ctor.prototype,ctor2.prototype)},util.inherit=function(ctor,ctor2){function f(){}f.prototype=ctor2.prototype,ctor.prototype=new f},util.isArray=Array.isArray||function(obj){return"[object Array]"===Object.prototype.toString.call(obj)},util.intersect=function(arr,arr2){for(var ret=[],longest=arr.length>arr2.length?arr:arr2,shortest=arr.length>arr2.length?arr2:arr,i=0,l=shortest.length;l>i;i++)~util.indexOf(longest,shortest[i])&&ret.push(shortest[i]);return ret},util.indexOf=function(arr,o,i){for(var j=arr.length,i=0>i?0>i+j?0:i+j:i||0;j>i&&arr[i]!==o;i++);return i>=j?-1:i},util.toArray=function(enu){for(var arr=[],i=0,l=enu.length;l>i;i++)arr.push(enu[i]);return arr},util.ua={},util.ua.hasCORS="undefined"!=typeof XMLHttpRequest&&function(){try{var a=new XMLHttpRequest}catch(e){return!1}return void 0!=a.withCredentials}(),util.ua.webkit="undefined"!=typeof navigator&&/webkit/i.test(navigator.userAgent),util.ua.iDevice="undefined"!=typeof navigator&&/iPad|iPhone|iPod/i.test(navigator.userAgent)}("undefined"!=typeof io?io:module.exports,this),function(exports,io){function EventEmitter(){}exports.EventEmitter=EventEmitter,EventEmitter.prototype.on=function(name,fn){return this.$events||(this.$events={}),this.$events[name]?io.util.isArray(this.$events[name])?this.$events[name].push(fn):this.$events[name]=[this.$events[name],fn]:this.$events[name]=fn,this},EventEmitter.prototype.addListener=EventEmitter.prototype.on,EventEmitter.prototype.once=function(name,fn){function on(){self.removeListener(name,on),fn.apply(this,arguments)}var self=this;return on.listener=fn,this.on(name,on),this},EventEmitter.prototype.removeListener=function(name,fn){if(this.$events&&this.$events[name]){var list=this.$events[name];if(io.util.isArray(list)){for(var pos=-1,i=0,l=list.length;l>i;i++)if(list[i]===fn||list[i].listener&&list[i].listener===fn){pos=i;break}if(0>pos)return this;list.splice(pos,1),list.length||delete this.$events[name]}else(list===fn||list.listener&&list.listener===fn)&&delete this.$events[name]}return this},EventEmitter.prototype.removeAllListeners=function(name){return void 0===name?(this.$events={},this):(this.$events&&this.$events[name]&&(this.$events[name]=null),this)},EventEmitter.prototype.listeners=function(name){return this.$events||(this.$events={}),this.$events[name]||(this.$events[name]=[]),io.util.isArray(this.$events[name])||(this.$events[name]=[this.$events[name]]),this.$events[name]},EventEmitter.prototype.emit=function(name){if(!this.$events)return!1;var handler=this.$events[name];if(!handler)return!1;var args=Array.prototype.slice.call(arguments,1);if("function"==typeof handler)handler.apply(this,args);else{if(!io.util.isArray(handler))return!1;for(var listeners=handler.slice(),i=0,l=listeners.length;l>i;i++)listeners[i].apply(this,args)}return!0}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(exports,nativeJSON){"use strict";function f(n){return 10>n?"0"+n:n}function date(d){return isFinite(d.valueOf())?d.getUTCFullYear()+"-"+f(d.getUTCMonth()+1)+"-"+f(d.getUTCDate())+"T"+f(d.getUTCHours())+":"+f(d.getUTCMinutes())+":"+f(d.getUTCSeconds())+"Z":null}function quote(string){return escapable.lastIndex=0,escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return"string"==typeof c?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,partial,mind=gap,value=holder[key];switch(value instanceof Date&&(value=date(key)),"function"==typeof rep&&(value=rep.call(holder,key,value)),typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value)return"null";if(gap+=indent,partial=[],"[object Array]"===Object.prototype.toString.apply(value)){for(length=value.length,i=0;length>i;i+=1)partial[i]=str(i,value)||"null";return v=0===partial.length?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]",gap=mind,v}if(rep&&"object"==typeof rep)for(length=rep.length,i=0;length>i;i+=1)"string"==typeof rep[i]&&(k=rep[i],v=str(k,value),v&&partial.push(quote(k)+(gap?": ":":")+v));else for(k in value)Object.prototype.hasOwnProperty.call(value,k)&&(v=str(k,value),v&&partial.push(quote(k)+(gap?": ":":")+v));return v=0===partial.length?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}",gap=mind,v}}if(nativeJSON&&nativeJSON.parse)return exports.JSON={parse:nativeJSON.parse,stringify:nativeJSON.stringify};var JSON=exports.JSON={},cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;JSON.stringify=function(value,replacer,space){var i;if(gap="",indent="","number"==typeof space)for(i=0;space>i;i+=1)indent+=" ";else"string"==typeof space&&(indent=space);if(rep=replacer,replacer&&"function"!=typeof replacer&&("object"!=typeof replacer||"number"!=typeof replacer.length))throw new Error("JSON.stringify");return str("",{"":value})},JSON.parse=function(text,reviver){function walk(holder,key){var k,v,value=holder[key];if(value&&"object"==typeof value)for(k in value)Object.prototype.hasOwnProperty.call(value,k)&&(v=walk(value,k),void 0!==v?value[k]=v:delete value[k]);return reviver.call(holder,key,value)}var j;if(text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof JSON?JSON:void 0),function(exports,io){var parser=exports.parser={},packets=parser.packets=["disconnect","connect","heartbeat","message","json","event","ack","error","noop"],reasons=parser.reasons=["transport not supported","client not handshaken","unauthorized"],advice=parser.advice=["reconnect"],JSON=io.JSON,indexOf=io.util.indexOf;parser.encodePacket=function(packet){var type=indexOf(packets,packet.type),id=packet.id||"",endpoint=packet.endpoint||"",ack=packet.ack,data=null;switch(packet.type){case"error":var reason=packet.reason?indexOf(reasons,packet.reason):"",adv=packet.advice?indexOf(advice,packet.advice):"";(""!==reason||""!==adv)&&(data=reason+(""!==adv?"+"+adv:""));break;case"message":""!==packet.data&&(data=packet.data);break;case"event":var ev={name:packet.name};packet.args&&packet.args.length&&(ev.args=packet.args),data=JSON.stringify(ev);break;case"json":data=JSON.stringify(packet.data);break;case"connect":packet.qs&&(data=packet.qs);break;case"ack":data=packet.ackId+(packet.args&&packet.args.length?"+"+JSON.stringify(packet.args):"")}var encoded=[type,id+("data"==ack?"+":""),endpoint];return null!==data&&void 0!==data&&encoded.push(data),encoded.join(":")},parser.encodePayload=function(packets){var decoded="";if(1==packets.length)return packets[0];for(var i=0,l=packets.length;l>i;i++){var packet=packets[i];decoded+="�"+packet.length+"�"+packets[i]}return decoded};var regexp=/([^:]+):([0-9]+)?(\+)?:([^:]+)?:?([\s\S]*)?/;parser.decodePacket=function(data){var pieces=data.match(regexp);if(!pieces)return{};var id=pieces[2]||"",data=pieces[5]||"",packet={type:packets[pieces[1]],endpoint:pieces[4]||""};switch(id&&(packet.id=id,packet.ack=pieces[3]?"data":!0),packet.type){case"error":var pieces=data.split("+");packet.reason=reasons[pieces[0]]||"",packet.advice=advice[pieces[1]]||"";break;case"message":packet.data=data||"";break;case"event":try{var opts=JSON.parse(data);packet.name=opts.name,packet.args=opts.args}catch(e){}packet.args=packet.args||[];break;case"json":try{packet.data=JSON.parse(data)}catch(e){}break;case"connect":packet.qs=data||"";break;case"ack":var pieces=data.match(/^([0-9]+)(\+)?(.*)/);if(pieces&&(packet.ackId=pieces[1],packet.args=[],pieces[3]))try{packet.args=pieces[3]?JSON.parse(pieces[3]):[]}catch(e){}break;case"disconnect":case"heartbeat":}return packet},parser.decodePayload=function(data){if("�"==data.charAt(0)){for(var ret=[],i=1,length="";i<data.length;i++)"�"==data.charAt(i)?(ret.push(parser.decodePacket(data.substr(i+1).substr(0,length))),i+=Number(length)+1,length=""):length+=data.charAt(i);return ret}return[parser.decodePacket(data)]}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(exports,io){function Transport(socket,sessid){this.socket=socket,this.sessid=sessid}exports.Transport=Transport,io.util.mixin(Transport,io.EventEmitter),Transport.prototype.heartbeats=function(){return!0},Transport.prototype.onData=function(data){if(this.clearCloseTimeout(),(this.socket.connected||this.socket.connecting||this.socket.reconnecting)&&this.setCloseTimeout(),""!==data){var msgs=io.parser.decodePayload(data);if(msgs&&msgs.length)for(var i=0,l=msgs.length;l>i;i++)this.onPacket(msgs[i])}return this},Transport.prototype.onPacket=function(packet){return this.socket.setHeartbeatTimeout(),"heartbeat"==packet.type?this.onHeartbeat():("connect"==packet.type&&""==packet.endpoint&&this.onConnect(),"error"==packet.type&&"reconnect"==packet.advice&&(this.isOpen=!1),this.socket.onPacket(packet),this)},Transport.prototype.setCloseTimeout=function(){if(!this.closeTimeout){var self=this;this.closeTimeout=setTimeout(function(){self.onDisconnect()},this.socket.closeTimeout)}},Transport.prototype.onDisconnect=function(){return this.isOpen&&this.close(),this.clearTimeouts(),this.socket.onDisconnect(),this},Transport.prototype.onConnect=function(){return this.socket.onConnect(),this},Transport.prototype.clearCloseTimeout=function(){this.closeTimeout&&(clearTimeout(this.closeTimeout),this.closeTimeout=null)},Transport.prototype.clearTimeouts=function(){this.clearCloseTimeout(),this.reopenTimeout&&clearTimeout(this.reopenTimeout)},Transport.prototype.packet=function(packet){this.send(io.parser.encodePacket(packet))},Transport.prototype.onHeartbeat=function(){this.packet({type:"heartbeat"})},Transport.prototype.onOpen=function(){this.isOpen=!0,this.clearCloseTimeout(),this.socket.onOpen()},Transport.prototype.onClose=function(){this.isOpen=!1,this.socket.onClose(),this.onDisconnect()},Transport.prototype.prepareUrl=function(){var options=this.socket.options;return this.scheme()+"://"+options.host+":"+options.port+"/"+options.resource+"/"+io.protocol+"/"+this.name+"/"+this.sessid},Transport.prototype.ready=function(socket,fn){fn.call(this)}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(exports,io,global){function Socket(options){if(this.options={port:80,secure:!1,document:"document"in global?document:!1,resource:"socket.io",transports:io.transports,"connect timeout":1e4,"try multiple transports":!0,reconnect:!0,"reconnection delay":500,"reconnection limit":1/0,"reopen delay":3e3,"max reconnection attempts":10,"sync disconnect on unload":!1,"auto connect":!0,"flash policy port":10843,manualFlush:!1},io.util.merge(this.options,options),this.connected=!1,this.open=!1,this.connecting=!1,this.reconnecting=!1,this.namespaces={},this.buffer=[],this.doBuffer=!1,this.options["sync disconnect on unload"]&&(!this.isXDomain()||io.util.ua.hasCORS)){var self=this;io.util.on(global,"beforeunload",function(){self.disconnectSync()},!1)}this.options["auto connect"]&&this.connect()}function empty(){}exports.Socket=Socket,io.util.mixin(Socket,io.EventEmitter),Socket.prototype.of=function(name){return this.namespaces[name]||(this.namespaces[name]=new io.SocketNamespace(this,name),""!==name&&this.namespaces[name].packet({type:"connect"})),this.namespaces[name]},Socket.prototype.publish=function(){this.emit.apply(this,arguments);var nsp;for(var i in this.namespaces)this.namespaces.hasOwnProperty(i)&&(nsp=this.of(i),nsp.$emit.apply(nsp,arguments))},Socket.prototype.handshake=function(fn){function complete(data){data instanceof Error?(self.connecting=!1,self.onError(data.message)):fn.apply(null,data.split(":"))}var self=this,options=this.options,url=["http"+(options.secure?"s":"")+":/",options.host+":"+options.port,options.resource,io.protocol,io.util.query(this.options.query,"t="+ +new Date)].join("/");if(this.isXDomain()&&!io.util.ua.hasCORS){var insertAt=document.getElementsByTagName("script")[0],script=document.createElement("script");script.src=url+"&jsonp="+io.j.length,insertAt.parentNode.insertBefore(script,insertAt),io.j.push(function(data){complete(data),script.parentNode.removeChild(script)})}else{var xhr=io.util.request();xhr.open("GET",url,!0),this.isXDomain()&&(xhr.withCredentials=!0),xhr.onreadystatechange=function(){4==xhr.readyState&&(xhr.onreadystatechange=empty,200==xhr.status?complete(xhr.responseText):403==xhr.status?self.onError(xhr.responseText):(self.connecting=!1,!self.reconnecting&&self.onError(xhr.responseText)))},xhr.send(null)}},Socket.prototype.getTransport=function(override){for(var transport,transports=override||this.transports,i=0;transport=transports[i];i++)if(io.Transport[transport]&&io.Transport[transport].check(this)&&(!this.isXDomain()||io.Transport[transport].xdomainCheck(this)))return new io.Transport[transport](this,this.sessionid);return null},Socket.prototype.connect=function(fn){if(this.connecting)return this;var self=this;return self.connecting=!0,this.handshake(function(sid,heartbeat,close,transports){function connect(transports){return self.transport&&self.transport.clearTimeouts(),self.transport=self.getTransport(transports),self.transport?(self.transport.ready(self,function(){self.connecting=!0,self.publish("connecting",self.transport.name),self.transport.open(),self.options["connect timeout"]&&(self.connectTimeoutTimer=setTimeout(function(){if(!self.connected&&(self.connecting=!1,self.options["try multiple transports"])){for(var remaining=self.transports;remaining.length>0&&remaining.splice(0,1)[0]!=self.transport.name;);remaining.length?connect(remaining):self.publish("connect_failed")}},self.options["connect timeout"]))}),void 0):self.publish("connect_failed")}self.sessionid=sid,self.closeTimeout=1e3*close,self.heartbeatTimeout=1e3*heartbeat,self.transports||(self.transports=self.origTransports=transports?io.util.intersect(transports.split(","),self.options.transports):self.options.transports),self.setHeartbeatTimeout(),connect(self.transports),self.once("connect",function(){clearTimeout(self.connectTimeoutTimer),fn&&"function"==typeof fn&&fn()})}),this},Socket.prototype.setHeartbeatTimeout=function(){if(clearTimeout(this.heartbeatTimeoutTimer),!this.transport||this.transport.heartbeats()){var self=this;this.heartbeatTimeoutTimer=setTimeout(function(){self.transport.onClose()},this.heartbeatTimeout)}},Socket.prototype.packet=function(data){return this.connected&&!this.doBuffer?this.transport.packet(data):this.buffer.push(data),this},Socket.prototype.setBuffer=function(v){this.doBuffer=v,!v&&this.connected&&this.buffer.length&&(this.options.manualFlush||this.flushBuffer())},Socket.prototype.flushBuffer=function(){this.transport.payload(this.buffer),this.buffer=[]},Socket.prototype.disconnect=function(){return(this.connected||this.connecting)&&(this.open&&this.of("").packet({type:"disconnect"}),this.onDisconnect("booted")),this},Socket.prototype.disconnectSync=function(){var xhr=io.util.request(),uri=["http"+(this.options.secure?"s":"")+":/",this.options.host+":"+this.options.port,this.options.resource,io.protocol,"",this.sessionid].join("/")+"/?disconnect=1";xhr.open("GET",uri,!1),xhr.send(null),this.onDisconnect("booted")},Socket.prototype.isXDomain=function(){var port=global.location.port||("https:"==global.location.protocol?443:80);return this.options.host!==global.location.hostname||this.options.port!=port},Socket.prototype.onConnect=function(){this.connected||(this.connected=!0,this.connecting=!1,this.doBuffer||this.setBuffer(!1),this.emit("connect"))},Socket.prototype.onOpen=function(){this.open=!0},Socket.prototype.onClose=function(){this.open=!1,clearTimeout(this.heartbeatTimeoutTimer)},Socket.prototype.onPacket=function(packet){this.of(packet.endpoint).onPacket(packet)},Socket.prototype.onError=function(err){err&&err.advice&&"reconnect"===err.advice&&(this.connected||this.connecting)&&(this.disconnect(),this.options.reconnect&&this.reconnect()),this.publish("error",err&&err.reason?err.reason:err)},Socket.prototype.onDisconnect=function(reason){var wasConnected=this.connected,wasConnecting=this.connecting;this.connected=!1,this.connecting=!1,this.open=!1,(wasConnected||wasConnecting)&&(this.transport.close(),this.transport.clearTimeouts(),wasConnected&&(this.publish("disconnect",reason),"booted"!=reason&&this.options.reconnect&&!this.reconnecting&&this.reconnect()))},Socket.prototype.reconnect=function(){function reset(){if(self.connected){for(var i in self.namespaces)self.namespaces.hasOwnProperty(i)&&""!==i&&self.namespaces[i].packet({type:"connect"});self.publish("reconnect",self.transport.name,self.reconnectionAttempts)}clearTimeout(self.reconnectionTimer),self.removeListener("connect_failed",maybeReconnect),self.removeListener("connect",maybeReconnect),self.reconnecting=!1,delete self.reconnectionAttempts,delete self.reconnectionDelay,delete self.reconnectionTimer,delete self.redoTransports,self.options["try multiple transports"]=tryMultiple}function maybeReconnect(){return self.reconnecting?self.connected?reset():self.connecting&&self.reconnecting?self.reconnectionTimer=setTimeout(maybeReconnect,1e3):(self.reconnectionAttempts++>=maxAttempts?self.redoTransports?(self.publish("reconnect_failed"),reset()):(self.on("connect_failed",maybeReconnect),self.options["try multiple transports"]=!0,self.transports=self.origTransports,self.transport=self.getTransport(),self.redoTransports=!0,self.connect()):(self.reconnectionDelay<limit&&(self.reconnectionDelay*=2),self.connect(),self.publish("reconnecting",self.reconnectionDelay,self.reconnectionAttempts),self.reconnectionTimer=setTimeout(maybeReconnect,self.reconnectionDelay)),void 0):void 0}this.reconnecting=!0,this.reconnectionAttempts=0,this.reconnectionDelay=this.options["reconnection delay"];var self=this,maxAttempts=this.options["max reconnection attempts"],tryMultiple=this.options["try multiple transports"],limit=this.options["reconnection limit"];this.options["try multiple transports"]=!1,this.reconnectionTimer=setTimeout(maybeReconnect,this.reconnectionDelay),this.on("connect",maybeReconnect)}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),function(exports,io){function SocketNamespace(socket,name){this.socket=socket,this.name=name||"",this.flags={},this.json=new Flag(this,"json"),this.ackPackets=0,this.acks={}}function Flag(nsp,name){this.namespace=nsp,this.name=name}exports.SocketNamespace=SocketNamespace,io.util.mixin(SocketNamespace,io.EventEmitter),SocketNamespace.prototype.$emit=io.EventEmitter.prototype.emit,SocketNamespace.prototype.of=function(){return this.socket.of.apply(this.socket,arguments)},SocketNamespace.prototype.packet=function(packet){return packet.endpoint=this.name,this.socket.packet(packet),this.flags={},this},SocketNamespace.prototype.send=function(data,fn){var packet={type:this.flags.json?"json":"message",data:data};return"function"==typeof fn&&(packet.id=++this.ackPackets,packet.ack=!0,this.acks[packet.id]=fn),this.packet(packet)},SocketNamespace.prototype.emit=function(name){var args=Array.prototype.slice.call(arguments,1),lastArg=args[args.length-1],packet={type:"event",name:name};return"function"==typeof lastArg&&(packet.id=++this.ackPackets,packet.ack="data",this.acks[packet.id]=lastArg,args=args.slice(0,args.length-1)),packet.args=args,this.packet(packet)},SocketNamespace.prototype.disconnect=function(){return""===this.name?this.socket.disconnect():(this.packet({type:"disconnect"}),this.$emit("disconnect")),this},SocketNamespace.prototype.onPacket=function(packet){function ack(){self.packet({type:"ack",args:io.util.toArray(arguments),ackId:packet.id})}var self=this;switch(packet.type){case"connect":this.$emit("connect");break;case"disconnect":""===this.name?this.socket.onDisconnect(packet.reason||"booted"):this.$emit("disconnect",packet.reason);break;case"message":case"json":var params=["message",packet.data];"data"==packet.ack?params.push(ack):packet.ack&&this.packet({type:"ack",ackId:packet.id}),this.$emit.apply(this,params);break;case"event":var params=[packet.name].concat(packet.args);"data"==packet.ack&&params.push(ack),this.$emit.apply(this,params);break;case"ack":this.acks[packet.ackId]&&(this.acks[packet.ackId].apply(this,packet.args),delete this.acks[packet.ackId]);break;case"error":packet.advice?this.socket.onError(packet):"unauthorized"==packet.reason?this.$emit("connect_failed",packet.reason):this.$emit("error",packet.reason)}},Flag.prototype.send=function(){this.namespace.flags[this.name]=!0,this.namespace.send.apply(this.namespace,arguments)},Flag.prototype.emit=function(){this.namespace.flags[this.name]=!0,this.namespace.emit.apply(this.namespace,arguments)}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(exports,io,global){function WS(){io.Transport.apply(this,arguments)}exports.websocket=WS,io.util.inherit(WS,io.Transport),WS.prototype.name="websocket",WS.prototype.open=function(){var Socket,query=io.util.query(this.socket.options.query),self=this;return Socket||(Socket=global.MozWebSocket||global.WebSocket),this.websocket=new Socket(this.prepareUrl()+query),this.websocket.onopen=function(){self.onOpen(),self.socket.setBuffer(!1)},this.websocket.onmessage=function(ev){self.onData(ev.data)},this.websocket.onclose=function(){self.onClose(),self.socket.setBuffer(!0)},this.websocket.onerror=function(e){self.onError(e)},this},WS.prototype.send=io.util.ua.iDevice?function(data){var self=this;return setTimeout(function(){self.websocket.send(data)},0),this}:function(data){return this.websocket.send(data),this},WS.prototype.payload=function(arr){for(var i=0,l=arr.length;l>i;i++)this.packet(arr[i]);return this},WS.prototype.close=function(){return this.websocket.close(),this},WS.prototype.onError=function(e){this.socket.onError(e)},WS.prototype.scheme=function(){return this.socket.options.secure?"wss":"ws"},WS.check=function(){return"WebSocket"in global&&!("__addTask"in WebSocket)||"MozWebSocket"in global},WS.xdomainCheck=function(){return!0},io.transports.push("websocket")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),function(exports,io,global){function XHR(socket){socket&&(io.Transport.apply(this,arguments),this.sendBuffer=[])}function empty(){}exports.XHR=XHR,io.util.inherit(XHR,io.Transport),XHR.prototype.open=function(){return this.socket.setBuffer(!1),this.onOpen(),this.get(),this.setCloseTimeout(),this},XHR.prototype.payload=function(payload){for(var msgs=[],i=0,l=payload.length;l>i;i++)msgs.push(io.parser.encodePacket(payload[i]));this.send(io.parser.encodePayload(msgs))},XHR.prototype.send=function(data){return this.post(data),this},XHR.prototype.post=function(data){function stateChange(){4==this.readyState&&(this.onreadystatechange=empty,self.posting=!1,200==this.status?self.socket.setBuffer(!1):self.onClose())}function onload(){this.onload=empty,self.socket.setBuffer(!1)}var self=this;this.socket.setBuffer(!0),this.sendXHR=this.request("POST"),global.XDomainRequest&&this.sendXHR instanceof XDomainRequest?this.sendXHR.onload=this.sendXHR.onerror=onload:this.sendXHR.onreadystatechange=stateChange,this.sendXHR.send(data)},XHR.prototype.close=function(){return this.onClose(),this},XHR.prototype.request=function(method){var req=io.util.request(this.socket.isXDomain()),query=io.util.query(this.socket.options.query,"t="+ +new Date);if(req.open(method||"GET",this.prepareUrl()+query,!0),"POST"==method)try{req.setRequestHeader?req.setRequestHeader("Content-type","text/plain;charset=UTF-8"):req.contentType="text/plain"}catch(e){}return req},XHR.prototype.scheme=function(){return this.socket.options.secure?"https":"http"},XHR.check=function(socket,xdomain){try{var request=io.util.request(xdomain),usesXDomReq=global.XDomainRequest&&request instanceof XDomainRequest,socketProtocol=socket&&socket.options&&socket.options.secure?"https:":"http:",isXProtocol=global.location&&socketProtocol!=global.location.protocol;if(request&&(!usesXDomReq||!isXProtocol))return!0}catch(e){}return!1},XHR.xdomainCheck=function(socket){return XHR.check(socket,!0)}}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),function(exports,io){function HTMLFile(){io.Transport.XHR.apply(this,arguments)}exports.htmlfile=HTMLFile,io.util.inherit(HTMLFile,io.Transport.XHR),HTMLFile.prototype.name="htmlfile",HTMLFile.prototype.get=function(){this.doc=new(window[["Active"].concat("Object").join("X")])("htmlfile"),this.doc.open(),this.doc.write("<html></html>"),this.doc.close(),this.doc.parentWindow.s=this;var iframeC=this.doc.createElement("div");iframeC.className="socketio",this.doc.body.appendChild(iframeC),this.iframe=this.doc.createElement("iframe"),iframeC.appendChild(this.iframe);var self=this,query=io.util.query(this.socket.options.query,"t="+ +new Date);this.iframe.src=this.prepareUrl()+query,io.util.on(window,"unload",function(){self.destroy()})},HTMLFile.prototype._=function(data,doc){data=data.replace(/\\\//g,"/"),this.onData(data);try{var script=doc.getElementsByTagName("script")[0];script.parentNode.removeChild(script)}catch(e){}},HTMLFile.prototype.destroy=function(){if(this.iframe){try{this.iframe.src="about:blank"}catch(e){}this.doc=null,this.iframe.parentNode.removeChild(this.iframe),this.iframe=null,CollectGarbage()}},HTMLFile.prototype.close=function(){return this.destroy(),io.Transport.XHR.prototype.close.call(this)},HTMLFile.check=function(socket){if("undefined"!=typeof window&&["Active"].concat("Object").join("X")in window)try{var a=new(window[["Active"].concat("Object").join("X")])("htmlfile");return a&&io.Transport.XHR.check(socket)}catch(e){}return!1},HTMLFile.xdomainCheck=function(){return!1},io.transports.push("htmlfile")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(exports,io,global){function XHRPolling(){io.Transport.XHR.apply(this,arguments)}function empty(){}exports["xhr-polling"]=XHRPolling,io.util.inherit(XHRPolling,io.Transport.XHR),io.util.merge(XHRPolling,io.Transport.XHR),XHRPolling.prototype.name="xhr-polling",XHRPolling.prototype.heartbeats=function(){return!1},XHRPolling.prototype.open=function(){var self=this;return io.Transport.XHR.prototype.open.call(self),!1},XHRPolling.prototype.get=function(){function stateChange(){4==this.readyState&&(this.onreadystatechange=empty,200==this.status?(self.onData(this.responseText),self.get()):self.onClose())}function onload(){this.onload=empty,this.onerror=empty,self.retryCounter=1,self.onData(this.responseText),self.get()}function onerror(){self.retryCounter++,!self.retryCounter||self.retryCounter>3?self.onClose():self.get()}if(this.isOpen){var self=this;this.xhr=this.request(),global.XDomainRequest&&this.xhr instanceof XDomainRequest?(this.xhr.onload=onload,this.xhr.onerror=onerror):this.xhr.onreadystatechange=stateChange,this.xhr.send(null)}},XHRPolling.prototype.onClose=function(){if(io.Transport.XHR.prototype.onClose.call(this),this.xhr){this.xhr.onreadystatechange=this.xhr.onload=this.xhr.onerror=empty;try{this.xhr.abort()}catch(e){}this.xhr=null}},XHRPolling.prototype.ready=function(socket,fn){var self=this;io.util.defer(function(){fn.call(self)})},io.transports.push("xhr-polling")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),function(exports,io,global){function JSONPPolling(){io.Transport["xhr-polling"].apply(this,arguments),this.index=io.j.length;var self=this;io.j.push(function(msg){self._(msg)})}var indicator=global.document&&"MozAppearance"in global.document.documentElement.style;
exports["jsonp-polling"]=JSONPPolling,io.util.inherit(JSONPPolling,io.Transport["xhr-polling"]),JSONPPolling.prototype.name="jsonp-polling",JSONPPolling.prototype.post=function(data){function complete(){initIframe(),self.socket.setBuffer(!1)}function initIframe(){self.iframe&&self.form.removeChild(self.iframe);try{iframe=document.createElement('<iframe name="'+self.iframeId+'">')}catch(e){iframe=document.createElement("iframe"),iframe.name=self.iframeId}iframe.id=self.iframeId,self.form.appendChild(iframe),self.iframe=iframe}var self=this,query=io.util.query(this.socket.options.query,"t="+ +new Date+"&i="+this.index);if(!this.form){var iframe,form=document.createElement("form"),area=document.createElement("textarea"),id=this.iframeId="socketio_iframe_"+this.index;form.className="socketio",form.style.position="absolute",form.style.top="0px",form.style.left="0px",form.style.display="none",form.target=id,form.method="POST",form.setAttribute("accept-charset","utf-8"),area.name="d",form.appendChild(area),document.body.appendChild(form),this.form=form,this.area=area}this.form.action=this.prepareUrl()+query,initIframe(),this.area.value=io.JSON.stringify(data);try{this.form.submit()}catch(e){}this.iframe.attachEvent?iframe.onreadystatechange=function(){"complete"==self.iframe.readyState&&complete()}:this.iframe.onload=complete,this.socket.setBuffer(!0)},JSONPPolling.prototype.get=function(){var self=this,script=document.createElement("script"),query=io.util.query(this.socket.options.query,"t="+ +new Date+"&i="+this.index);this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),script.async=!0,script.src=this.prepareUrl()+query,script.onerror=function(){self.onClose()};var insertAt=document.getElementsByTagName("script")[0];insertAt.parentNode.insertBefore(script,insertAt),this.script=script,indicator&&setTimeout(function(){var iframe=document.createElement("iframe");document.body.appendChild(iframe),document.body.removeChild(iframe)},100)},JSONPPolling.prototype._=function(msg){return this.onData(msg),this.isOpen&&this.get(),this},JSONPPolling.prototype.ready=function(socket,fn){var self=this;return indicator?(io.util.load(function(){fn.call(self)}),void 0):fn.call(this)},JSONPPolling.check=function(){return"document"in global},JSONPPolling.xdomainCheck=function(){return!0},io.transports.push("jsonp-polling")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),"function"==typeof define&&define.amd&&define([],function(){return io})}(),function(io){function request(url,data,cb,method){var socket=this,usage="Usage:\n socket."+(method||"request")+"( destinationURL, dataToSend, fnToCallWhenComplete )";if(url=url.replace(/^(.+)\/*\s*$/,"$1"),method=method||"get","string"!=typeof url)throw new Error("Invalid or missing URL!\n"+usage);"function"==typeof data&&(cb=data,data={});var json=window.io.JSON.stringify({url:url,data:data});socket.emit(method,json,function(result){var parsedResult=result;if(result&&"string"==typeof result)try{parsedResult=window.io.JSON.parse(result)}catch(e){throw"undefined"!=typeof console&&console.warn("Could not parse:",result,e),new Error("Server response could not be parsed!\n"+result)}if(404===parsedResult)throw new Error("404: Not found");if(403===parsedResult)throw new Error("403: Forbidden");if(500===parsedResult)throw new Error("500: Server error");cb&&cb(parsedResult)})}var Socket=io.SocketNamespace;Socket.prototype.get=function(url,data,cb){return this.request(url,data,cb,"get")},Socket.prototype.post=function(url,data,cb){return this.request(url,data,cb,"post")},Socket.prototype.put=function(url,data,cb){return this.request(url,data,cb,"put")},Socket.prototype["delete"]=function(url,data,cb){return this.request(url,data,cb,"delete")},Socket.prototype.request=request}(window.io),function(io){function log(){"undefined"!=typeof console&&console.log.apply(console,arguments)}var socket=io.connect();"undefined"!=typeof console&&log("Connecting to Sails.js..."),socket.on("connect",function(){socket.on("message",function(message){log("New comet message received :: ",message)}),log('Socket is now connected and globally accessible as `socket`.\ne.g. to send a GET request to Sails, try \n`socket.get("/", function (response) { console.log(response); })`')}),window.socket=socket}(window.io),function(definition){if("function"==typeof bootstrap)bootstrap("promise",definition);else if("object"==typeof exports)module.exports=definition();else if("function"==typeof define&&define.amd)define(definition);else if("undefined"!=typeof ses){if(!ses.ok())return;ses.makeQ=definition}else Q=definition()}(function(){"use strict";function uncurryThis(f){return function(){return call.apply(f,arguments)}}function isObject(value){return value===Object(value)}function isStopIteration(exception){return"[object StopIteration]"===object_toString(exception)||exception instanceof QReturnValue}function makeStackTraceLong(error,promise){if(hasStacks&&promise.stack&&"object"==typeof error&&null!==error&&error.stack&&-1===error.stack.indexOf(STACK_JUMP_SEPARATOR)){for(var stacks=[],p=promise;p;p=p.source)p.stack&&stacks.unshift(p.stack);stacks.unshift(error.stack);var concatedStacks=stacks.join("\n"+STACK_JUMP_SEPARATOR+"\n");error.stack=filterStackString(concatedStacks)}}function filterStackString(stackString){for(var lines=stackString.split("\n"),desiredLines=[],i=0;i<lines.length;++i){var line=lines[i];isInternalFrame(line)||isNodeFrame(line)||!line||desiredLines.push(line)}return desiredLines.join("\n")}function isNodeFrame(stackLine){return-1!==stackLine.indexOf("(module.js:")||-1!==stackLine.indexOf("(node.js:")}function getFileNameAndLineNumber(stackLine){var attempt1=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(stackLine);if(attempt1)return[attempt1[1],Number(attempt1[2])];var attempt2=/at ([^ ]+):(\d+):(?:\d+)$/.exec(stackLine);if(attempt2)return[attempt2[1],Number(attempt2[2])];var attempt3=/.*@(.+):(\d+)$/.exec(stackLine);return attempt3?[attempt3[1],Number(attempt3[2])]:void 0}function isInternalFrame(stackLine){var fileNameAndLineNumber=getFileNameAndLineNumber(stackLine);if(!fileNameAndLineNumber)return!1;var fileName=fileNameAndLineNumber[0],lineNumber=fileNameAndLineNumber[1];return fileName===qFileName&&lineNumber>=qStartingLine&&qEndingLine>=lineNumber}function captureLine(){if(hasStacks)try{throw new Error}catch(e){var lines=e.stack.split("\n"),firstLine=lines[0].indexOf("@")>0?lines[1]:lines[2],fileNameAndLineNumber=getFileNameAndLineNumber(firstLine);if(!fileNameAndLineNumber)return;return qFileName=fileNameAndLineNumber[0],fileNameAndLineNumber[1]}}function deprecate(callback,name,alternative){return function(){return"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(name+" is deprecated, use "+alternative+" instead.",new Error("").stack),callback.apply(callback,arguments)}}function Q(value){return isPromise(value)?value:isPromiseAlike(value)?coerce(value):fulfill(value)}function defer(){function become(newPromise){resolvedPromise=newPromise,promise.source=newPromise,array_reduce(messages,function(undefined,message){nextTick(function(){newPromise.promiseDispatch.apply(newPromise,message)})},void 0),messages=void 0,progressListeners=void 0}var resolvedPromise,messages=[],progressListeners=[],deferred=object_create(defer.prototype),promise=object_create(Promise.prototype);if(promise.promiseDispatch=function(resolve,op,operands){var args=array_slice(arguments);messages?(messages.push(args),"when"===op&&operands[1]&&progressListeners.push(operands[1])):nextTick(function(){resolvedPromise.promiseDispatch.apply(resolvedPromise,args)})},promise.valueOf=deprecate(function(){if(messages)return promise;var nearerValue=nearer(resolvedPromise);return isPromise(nearerValue)&&(resolvedPromise=nearerValue),nearerValue},"valueOf","inspect"),promise.inspect=function(){return resolvedPromise?resolvedPromise.inspect():{state:"pending"}},Q.longStackSupport&&hasStacks)try{throw new Error}catch(e){promise.stack=e.stack.substring(e.stack.indexOf("\n")+1)}return deferred.promise=promise,deferred.resolve=function(value){resolvedPromise||become(Q(value))},deferred.fulfill=function(value){resolvedPromise||become(fulfill(value))},deferred.reject=function(reason){resolvedPromise||become(reject(reason))},deferred.notify=function(progress){resolvedPromise||array_reduce(progressListeners,function(undefined,progressListener){nextTick(function(){progressListener(progress)})},void 0)},deferred}function promise(resolver){if("function"!=typeof resolver)throw new TypeError("resolver must be a function.");var deferred=defer();try{resolver(deferred.resolve,deferred.reject,deferred.notify)}catch(reason){deferred.reject(reason)}return deferred.promise}function race(answerPs){return promise(function(resolve,reject){for(var i=0,len=answerPs.length;len>i;i++)Q(answerPs[i]).then(resolve,reject)})}function Promise(descriptor,fallback,inspect){void 0===fallback&&(fallback=function(op){return reject(new Error("Promise does not support operation: "+op))}),void 0===inspect&&(inspect=function(){return{state:"unknown"}});var promise=object_create(Promise.prototype);if(promise.promiseDispatch=function(resolve,op,args){var result;try{result=descriptor[op]?descriptor[op].apply(promise,args):fallback.call(promise,op,args)}catch(exception){result=reject(exception)}resolve&&resolve(result)},promise.inspect=inspect,inspect){var inspected=inspect();"rejected"===inspected.state&&(promise.exception=inspected.reason),promise.valueOf=deprecate(function(){var inspected=inspect();return"pending"===inspected.state||"rejected"===inspected.state?promise:inspected.value})}return promise}function when(value,fulfilled,rejected,progressed){return Q(value).then(fulfilled,rejected,progressed)}function nearer(value){if(isPromise(value)){var inspected=value.inspect();if("fulfilled"===inspected.state)return inspected.value}return value}function isPromise(object){return isObject(object)&&"function"==typeof object.promiseDispatch&&"function"==typeof object.inspect}function isPromiseAlike(object){return isObject(object)&&"function"==typeof object.then}function isPending(object){return isPromise(object)&&"pending"===object.inspect().state}function isFulfilled(object){return!isPromise(object)||"fulfilled"===object.inspect().state}function isRejected(object){return isPromise(object)&&"rejected"===object.inspect().state}function displayUnhandledReasons(){unhandledReasonsDisplayed||"undefined"==typeof window||window.Touch||!window.console||console.warn("[Q] Unhandled rejection reasons (should be empty):",unhandledReasons),unhandledReasonsDisplayed=!0}function logUnhandledReasons(){for(var i=0;i<unhandledReasons.length;i++){var reason=unhandledReasons[i];reason&&"undefined"!=typeof reason.stack?console.warn("Unhandled rejection reason:",reason.stack):console.warn("Unhandled rejection reason (no stack):",reason)}}function resetUnhandledRejections(){unhandledReasons.length=0,unhandledRejections.length=0,unhandledReasonsDisplayed=!1,trackUnhandledRejections||(trackUnhandledRejections=!0,"undefined"!=typeof process&&process.on&&process.on("exit",logUnhandledReasons))}function trackRejection(promise,reason){trackUnhandledRejections&&(unhandledRejections.push(promise),unhandledReasons.push(reason),displayUnhandledReasons())}function untrackRejection(promise){if(trackUnhandledRejections){var at=array_indexOf(unhandledRejections,promise);-1!==at&&(unhandledRejections.splice(at,1),unhandledReasons.splice(at,1))}}function reject(reason){var rejection=Promise({when:function(rejected){return rejected&&untrackRejection(this),rejected?rejected(reason):this}},function(){return this},function(){return{state:"rejected",reason:reason}});return trackRejection(rejection,reason),rejection}function fulfill(value){return Promise({when:function(){return value},get:function(name){return value[name]},set:function(name,rhs){value[name]=rhs},"delete":function(name){delete value[name]},post:function(name,args){return null===name||void 0===name?value.apply(void 0,args):value[name].apply(value,args)},apply:function(thisp,args){return value.apply(thisp,args)},keys:function(){return object_keys(value)}},void 0,function(){return{state:"fulfilled",value:value}})}function coerce(promise){var deferred=defer();return nextTick(function(){try{promise.then(deferred.resolve,deferred.reject,deferred.notify)}catch(exception){deferred.reject(exception)}}),deferred.promise}function master(object){return Promise({isDef:function(){}},function(op,args){return dispatch(object,op,args)},function(){return Q(object).inspect()})}function spread(value,fulfilled,rejected){return Q(value).spread(fulfilled,rejected)}function async(makeGenerator){return function(){function continuer(verb,arg){var result;if(hasES6Generators){try{result=generator[verb](arg)}catch(exception){return reject(exception)}return result.done?result.value:when(result.value,callback,errback)}try{result=generator[verb](arg)}catch(exception){return isStopIteration(exception)?exception.value:reject(exception)}return when(result,callback,errback)}var generator=makeGenerator.apply(this,arguments),callback=continuer.bind(continuer,"next"),errback=continuer.bind(continuer,"throw");return callback()}}function spawn(makeGenerator){Q.done(Q.async(makeGenerator)())}function _return(value){throw new QReturnValue(value)}function promised(callback){return function(){return spread([this,all(arguments)],function(self,args){return callback.apply(self,args)})}}function dispatch(object,op,args){return Q(object).dispatch(op,args)}function all(promises){return when(promises,function(promises){var countDown=0,deferred=defer();return array_reduce(promises,function(undefined,promise,index){var snapshot;isPromise(promise)&&"fulfilled"===(snapshot=promise.inspect()).state?promises[index]=snapshot.value:(++countDown,when(promise,function(value){promises[index]=value,0===--countDown&&deferred.resolve(promises)},deferred.reject,function(progress){deferred.notify({index:index,value:progress})}))},void 0),0===countDown&&deferred.resolve(promises),deferred.promise})}function allResolved(promises){return when(promises,function(promises){return promises=array_map(promises,Q),when(all(array_map(promises,function(promise){return when(promise,noop,noop)})),function(){return promises})})}function allSettled(promises){return Q(promises).allSettled()}function progress(object,progressed){return Q(object).then(void 0,void 0,progressed)}function nodeify(object,nodeback){return Q(object).nodeify(nodeback)}var hasStacks=!1;try{throw new Error}catch(e){hasStacks=!!e.stack}var qFileName,QReturnValue,qStartingLine=captureLine(),noop=function(){},nextTick=function(){function flush(){for(;head.next;){head=head.next;var task=head.task;head.task=void 0;var domain=head.domain;domain&&(head.domain=void 0,domain.enter());try{task()}catch(e){if(isNodeJS)throw domain&&domain.exit(),setTimeout(flush,0),domain&&domain.enter(),e;setTimeout(function(){throw e},0)}domain&&domain.exit()}flushing=!1}var head={task:void 0,next:null},tail=head,flushing=!1,requestTick=void 0,isNodeJS=!1;if(nextTick=function(task){tail=tail.next={task:task,domain:isNodeJS&&process.domain,next:null},flushing||(flushing=!0,requestTick())},"undefined"!=typeof process&&process.nextTick)isNodeJS=!0,requestTick=function(){process.nextTick(flush)};else if("function"==typeof setImmediate)requestTick="undefined"!=typeof window?setImmediate.bind(window,flush):function(){setImmediate(flush)};else if("undefined"!=typeof MessageChannel){var channel=new MessageChannel;channel.port1.onmessage=flush,requestTick=function(){channel.port2.postMessage(0)}}else requestTick=function(){setTimeout(flush,0)};return nextTick}(),call=Function.call,array_slice=uncurryThis(Array.prototype.slice),array_reduce=uncurryThis(Array.prototype.reduce||function(callback,basis){var index=0,length=this.length;if(1===arguments.length)for(;;){if(index in this){basis=this[index++];break}if(++index>=length)throw new TypeError}for(;length>index;index++)index in this&&(basis=callback(basis,this[index],index));return basis}),array_indexOf=uncurryThis(Array.prototype.indexOf||function(value){for(var i=0;i<this.length;i++)if(this[i]===value)return i;return-1}),array_map=uncurryThis(Array.prototype.map||function(callback,thisp){var self=this,collect=[];return array_reduce(self,function(undefined,value,index){collect.push(callback.call(thisp,value,index,self))},void 0),collect}),object_create=Object.create||function(prototype){function Type(){}return Type.prototype=prototype,new Type},object_hasOwnProperty=uncurryThis(Object.prototype.hasOwnProperty),object_keys=Object.keys||function(object){var keys=[];for(var key in object)object_hasOwnProperty(object,key)&&keys.push(key);return keys},object_toString=uncurryThis(Object.prototype.toString);QReturnValue="undefined"!=typeof ReturnValue?ReturnValue:function(value){this.value=value};var hasES6Generators;try{new Function("(function* (){ yield 1; })"),hasES6Generators=!0}catch(e){hasES6Generators=!1}var STACK_JUMP_SEPARATOR="From previous event:";Q.resolve=Q,Q.nextTick=nextTick,Q.longStackSupport=!1,Q.defer=defer,defer.prototype.makeNodeResolver=function(){var self=this;return function(error,value){error?self.reject(error):arguments.length>2?self.resolve(array_slice(arguments,1)):self.resolve(value)}},Q.promise=promise,Q.passByCopy=function(object){return object},Promise.prototype.passByCopy=function(){return this},Q.join=function(x,y){return Q(x).join(y)},Promise.prototype.join=function(that){return Q([this,that]).spread(function(x,y){if(x===y)return x;throw new Error("Can't join: not the same: "+x+" "+y)})},Q.race=race,Promise.prototype.race=function(){return this.then(Q.race)},Q.makePromise=Promise,Promise.prototype.toString=function(){return"[object Promise]"},Promise.prototype.then=function(fulfilled,rejected,progressed){function _fulfilled(value){try{return"function"==typeof fulfilled?fulfilled(value):value}catch(exception){return reject(exception)}}function _rejected(exception){if("function"==typeof rejected){makeStackTraceLong(exception,self);try{return rejected(exception)}catch(newException){return reject(newException)}}return reject(exception)}function _progressed(value){return"function"==typeof progressed?progressed(value):value}var self=this,deferred=defer(),done=!1;return nextTick(function(){self.promiseDispatch(function(value){done||(done=!0,deferred.resolve(_fulfilled(value)))},"when",[function(exception){done||(done=!0,deferred.resolve(_rejected(exception)))}])}),self.promiseDispatch(void 0,"when",[void 0,function(value){var newValue,threw=!1;try{newValue=_progressed(value)}catch(e){if(threw=!0,!Q.onerror)throw e;Q.onerror(e)}threw||deferred.notify(newValue)}]),deferred.promise},Q.when=when,Promise.prototype.thenResolve=function(value){return this.then(function(){return value})},Q.thenResolve=function(promise,value){return Q(promise).thenResolve(value)},Promise.prototype.thenReject=function(reason){return this.then(function(){throw reason})},Q.thenReject=function(promise,reason){return Q(promise).thenReject(reason)},Q.nearer=nearer,Q.isPromise=isPromise,Q.isPromiseAlike=isPromiseAlike,Q.isPending=isPending,Promise.prototype.isPending=function(){return"pending"===this.inspect().state},Q.isFulfilled=isFulfilled,Promise.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state},Q.isRejected=isRejected,Promise.prototype.isRejected=function(){return"rejected"===this.inspect().state};var unhandledReasons=[],unhandledRejections=[],unhandledReasonsDisplayed=!1,trackUnhandledRejections=!0;Q.resetUnhandledRejections=resetUnhandledRejections,Q.getUnhandledReasons=function(){return unhandledReasons.slice()},Q.stopUnhandledRejectionTracking=function(){resetUnhandledRejections(),"undefined"!=typeof process&&process.on&&process.removeListener("exit",logUnhandledReasons),trackUnhandledRejections=!1},resetUnhandledRejections(),Q.reject=reject,Q.fulfill=fulfill,Q.master=master,Q.spread=spread,Promise.prototype.spread=function(fulfilled,rejected){return this.all().then(function(array){return fulfilled.apply(void 0,array)},rejected)},Q.async=async,Q.spawn=spawn,Q["return"]=_return,Q.promised=promised,Q.dispatch=dispatch,Promise.prototype.dispatch=function(op,args){var self=this,deferred=defer();return nextTick(function(){self.promiseDispatch(deferred.resolve,op,args)}),deferred.promise},Q.get=function(object,key){return Q(object).dispatch("get",[key])},Promise.prototype.get=function(key){return this.dispatch("get",[key])},Q.set=function(object,key,value){return Q(object).dispatch("set",[key,value])},Promise.prototype.set=function(key,value){return this.dispatch("set",[key,value])},Q.del=Q["delete"]=function(object,key){return Q(object).dispatch("delete",[key])},Promise.prototype.del=Promise.prototype["delete"]=function(key){return this.dispatch("delete",[key])},Q.mapply=Q.post=function(object,name,args){return Q(object).dispatch("post",[name,args])},Promise.prototype.mapply=Promise.prototype.post=function(name,args){return this.dispatch("post",[name,args])},Q.send=Q.mcall=Q.invoke=function(object,name){return Q(object).dispatch("post",[name,array_slice(arguments,2)])},Promise.prototype.send=Promise.prototype.mcall=Promise.prototype.invoke=function(name){return this.dispatch("post",[name,array_slice(arguments,1)])},Q.fapply=function(object,args){return Q(object).dispatch("apply",[void 0,args])},Promise.prototype.fapply=function(args){return this.dispatch("apply",[void 0,args])},Q["try"]=Q.fcall=function(object){return Q(object).dispatch("apply",[void 0,array_slice(arguments,1)])},Promise.prototype.fcall=function(){return this.dispatch("apply",[void 0,array_slice(arguments)])},Q.fbind=function(object){var promise=Q(object),args=array_slice(arguments,1);return function(){return promise.dispatch("apply",[this,args.concat(array_slice(arguments))])}},Promise.prototype.fbind=function(){var promise=this,args=array_slice(arguments);return function(){return promise.dispatch("apply",[this,args.concat(array_slice(arguments))])}},Q.keys=function(object){return Q(object).dispatch("keys",[])},Promise.prototype.keys=function(){return this.dispatch("keys",[])},Q.all=all,Promise.prototype.all=function(){return all(this)},Q.allResolved=deprecate(allResolved,"allResolved","allSettled"),Promise.prototype.allResolved=function(){return allResolved(this)},Q.allSettled=allSettled,Promise.prototype.allSettled=function(){return this.then(function(promises){return all(array_map(promises,function(promise){function regardless(){return promise.inspect()}return promise=Q(promise),promise.then(regardless,regardless)}))})},Q.fail=Q["catch"]=function(object,rejected){return Q(object).then(void 0,rejected)},Promise.prototype.fail=Promise.prototype["catch"]=function(rejected){return this.then(void 0,rejected)},Q.progress=progress,Promise.prototype.progress=function(progressed){return this.then(void 0,void 0,progressed)},Q.fin=Q["finally"]=function(object,callback){return Q(object)["finally"](callback)},Promise.prototype.fin=Promise.prototype["finally"]=function(callback){return callback=Q(callback),this.then(function(value){return callback.fcall().then(function(){return value})},function(reason){return callback.fcall().then(function(){throw reason})})},Q.done=function(object,fulfilled,rejected,progress){return Q(object).done(fulfilled,rejected,progress)},Promise.prototype.done=function(fulfilled,rejected,progress){var onUnhandledError=function(error){nextTick(function(){if(makeStackTraceLong(error,promise),!Q.onerror)throw error;Q.onerror(error)})},promise=fulfilled||rejected||progress?this.then(fulfilled,rejected,progress):this;"object"==typeof process&&process&&process.domain&&(onUnhandledError=process.domain.bind(onUnhandledError)),promise.then(void 0,onUnhandledError)},Q.timeout=function(object,ms,message){return Q(object).timeout(ms,message)},Promise.prototype.timeout=function(ms,message){var deferred=defer(),timeoutId=setTimeout(function(){deferred.reject(new Error(message||"Timed out after "+ms+" ms"))},ms);return this.then(function(value){clearTimeout(timeoutId),deferred.resolve(value)},function(exception){clearTimeout(timeoutId),deferred.reject(exception)},deferred.notify),deferred.promise},Q.delay=function(object,timeout){return void 0===timeout&&(timeout=object,object=void 0),Q(object).delay(timeout)},Promise.prototype.delay=function(timeout){return this.then(function(value){var deferred=defer();return setTimeout(function(){deferred.resolve(value)},timeout),deferred.promise})},Q.nfapply=function(callback,args){return Q(callback).nfapply(args)},Promise.prototype.nfapply=function(args){var deferred=defer(),nodeArgs=array_slice(args);return nodeArgs.push(deferred.makeNodeResolver()),this.fapply(nodeArgs).fail(deferred.reject),deferred.promise},Q.nfcall=function(callback){var args=array_slice(arguments,1);return Q(callback).nfapply(args)},Promise.prototype.nfcall=function(){var nodeArgs=array_slice(arguments),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),this.fapply(nodeArgs).fail(deferred.reject),deferred.promise},Q.nfbind=Q.denodeify=function(callback){var baseArgs=array_slice(arguments,1);return function(){var nodeArgs=baseArgs.concat(array_slice(arguments)),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),Q(callback).fapply(nodeArgs).fail(deferred.reject),deferred.promise}},Promise.prototype.nfbind=Promise.prototype.denodeify=function(){var args=array_slice(arguments);return args.unshift(this),Q.denodeify.apply(void 0,args)},Q.nbind=function(callback,thisp){var baseArgs=array_slice(arguments,2);return function(){function bound(){return callback.apply(thisp,arguments)}var nodeArgs=baseArgs.concat(array_slice(arguments)),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),Q(bound).fapply(nodeArgs).fail(deferred.reject),deferred.promise}},Promise.prototype.nbind=function(){var args=array_slice(arguments,0);return args.unshift(this),Q.nbind.apply(void 0,args)},Q.nmapply=Q.npost=function(object,name,args){return Q(object).npost(name,args)},Promise.prototype.nmapply=Promise.prototype.npost=function(name,args){var nodeArgs=array_slice(args||[]),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),this.dispatch("post",[name,nodeArgs]).fail(deferred.reject),deferred.promise},Q.nsend=Q.nmcall=Q.ninvoke=function(object,name){var nodeArgs=array_slice(arguments,2),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),Q(object).dispatch("post",[name,nodeArgs]).fail(deferred.reject),deferred.promise},Promise.prototype.nsend=Promise.prototype.nmcall=Promise.prototype.ninvoke=function(name){var nodeArgs=array_slice(arguments,1),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),this.dispatch("post",[name,nodeArgs]).fail(deferred.reject),deferred.promise},Q.nodeify=nodeify,Promise.prototype.nodeify=function(nodeback){return nodeback?(this.then(function(value){nextTick(function(){nodeback(null,value)})},function(error){nextTick(function(){nodeback(error)})}),void 0):this};var qEndingLine=captureLine();return Q}),function(undefined){var undefinedType="undefined";!function(name,definition){"undefined"!=typeof module?module.exports=definition():"function"==typeof define&&"object"==typeof define.amd?define(definition):this[name]=definition()}("log",function(){function realMethod(methodName){return typeof console===undefinedType?noop:console[methodName]===undefined?boundToConsole(console,"log")||noop:boundToConsole(console,methodName)}function boundToConsole(console,methodName){var method=console[methodName];return method.bind===undefined?Function.prototype.bind===undefined?function(){method.apply(console,arguments)}:Function.prototype.bind.call(console[methodName],console):console[methodName].bind(console)}function clearMethods(){for(var ii=0;ii<logMethods.length;ii++)self[logMethods[ii]]=noop}function cookiesAvailable(){return typeof window!==undefinedType&&window.document!==undefined&&window.document.cookie!==undefined}function setLevelInCookie(levelNum){if(cookiesAvailable()){var levelName;for(var key in self.levels)if(self.levels.hasOwnProperty(key)&&self.levels[key]===levelNum){levelName=key;break}levelName!==undefined&&(window.document.cookie="loglevel="+levelName+";")}}function loadLevelFromCookie(){var cookieLevel;if(cookiesAvailable()){var cookieMatch=cookieRegex.exec(window.document.cookie)||[];cookieLevel=cookieMatch[1]}self.setLevel(self.levels[cookieLevel]||self.levels.WARN)}var self={},noop=function(){},logMethods=["trace","debug","info","warn","error"],cookieRegex=/loglevel=([^;]+)/;self.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},self.setLevel=function(level){if("number"==typeof level&&level>=0&&level<=self.levels.SILENT){if(setLevelInCookie(level),level===self.levels.SILENT)return clearMethods(),void 0;if(typeof console===undefinedType)throw clearMethods(),"No console available for logging";for(var ii=0;ii<logMethods.length;ii++){var methodName=logMethods[ii];self[methodName]=level<=self.levels[methodName.toUpperCase()]?realMethod(methodName):noop}}else{if("string"!=typeof level)throw"log.setLevel() called with invalid level: "+level;self.setLevel(self.levels[level.toUpperCase()])}},self.enableAll=function(){self.setLevel(self.levels.TRACE)},self.disableAll=function(){self.setLevel(self.levels.SILENT)};try{loadLevelFromCookie()}catch(e){self.setLevel(self.levels.SILENT)}return self})}();var RTCPeerConnection=null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null;navigator.mozGetUserMedia?(console.log("This appears to be Firefox"),webrtcDetectedBrowser="firefox",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]),RTCPeerConnection=mozRTCPeerConnection,RTCSessionDescription=mozRTCSessionDescription,RTCIceCandidate=mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),createIceServer=function(url,username,password){var iceServer=null,url_parts=url.split(":");if(0===url_parts[0].indexOf("stun"))iceServer={url:url};else if(0===url_parts[0].indexOf("turn")&&(-1!==url.indexOf("transport=udp")||-1===url.indexOf("?transport"))){var turn_url_parts=url.split("?");iceServer={url:turn_url_parts[0],credential:password,username:username}}return iceServer},attachMediaStream=function(element,stream){console.log("Attaching media stream"),element.mozSrcObject=stream,element.play()},reattachMediaStream=function(to,from){console.log("Reattaching media stream"),to.mozSrcObject=from.mozSrcObject,to.play()},MediaStream.prototype.getVideoTracks=function(){return[]},MediaStream.prototype.getAudioTracks=function(){return[]}):navigator.webkitGetUserMedia?(console.log("This appears to be Chrome"),webrtcDetectedBrowser="chrome",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2]),createIceServer=function(url,username,password){var iceServer=null,url_parts=url.split(":");if(0===url_parts[0].indexOf("stun"))iceServer={url:url};else if(0===url_parts[0].indexOf("turn"))if(28>webrtcDetectedVersion){var url_turn_parts=url.split("turn:");iceServer={url:"turn:"+username+"@"+url_turn_parts[1],credential:password}}else iceServer={url:url,credential:password,username:username};return iceServer},RTCPeerConnection=webkitRTCPeerConnection,getUserMedia=navigator.webkitGetUserMedia.bind(navigator),attachMediaStream=function(element,stream){"undefined"!=typeof element.srcObject?element.srcObject=stream:"undefined"!=typeof element.mozSrcObject?element.mozSrcObject=stream:"undefined"!=typeof element.src?element.src=URL.createObjectURL(stream):console.log("Error attaching stream to element.")},reattachMediaStream=function(to,from){to.src=from.src},webkitMediaStream.prototype.getVideoTracks||(webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks},webkitMediaStream.prototype.getAudioTracks=function(){return this.audioTracks}),webkitRTCPeerConnection.prototype.getLocalStreams||(webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams
},webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams})):console.log("Browser does not appear to be WebRTC-capable");var webrtc={instances:{}};log.setLevel("debug"),webrtc.getClient=function(id){"use strict";return void 0===id&&log.debug((new Error).stack),webrtc.instances[id]},webrtc.makeUniqueID=function(){"use strict";return Math.floor(1e8*Math.random())},Object.defineProperty(Object.prototype,"forOwn",{value:function(func){"use strict";for(var name in this)this.hasOwnProperty(name)&&func(this[name],name)},enumerable:!1,configurable:!1}),Object.defineProperty(Object.prototype,"isNumber",{value:function(number){"use strict";return!isNaN(parseFloat(number))&&isFinite(number)&&void 0===number.length},enumerable:!1,configurable:!1}),Object.defineProperty(Object.prototype,"publicize",{value:function(name,func){"use strict";return this[name]=func,func},enumerable:!1,configurable:!1}),webrtc.Class=function(params){"use strict";var that={className:"webrtc.Class"};return params=params||{},params.client,delete that.client,params.forOwn(function(thing,name){that[name]=thing}),that.publicize("getClass",function(){return that.className}),that},Q.longStackSupport=!0,Q.stackJumpLimit=5,Q.longStackJumpLimit=20,webrtc.EventThrower=function(params){"use strict";params=params||{},params.client;var that=webrtc.Class(params);delete that.client,that.className="webrtc.EventThrower";var eventList={};return that.publicize("listen",function(eventType,listener){eventList[eventType]=eventList[eventType]||[],"function"==typeof listener&&eventList[eventType].push(listener)}),that.publicize("ignore",function(eventType,listener){return void 0===eventType?(eventList={},void 0):void 0===listener?(eventList[eventType]=[],void 0):(eventList[eventType].reverse().forEach(function(eachListener,index){listener===eachListener&&eventList[eventType].splice(index,1)}),void 0)}),that.publicize("fire",function(eventType){if(eventType&&eventList[eventType]){var args=Array.prototype.slice.call(arguments,1);eventList[eventType].forEach(function(listener){if("function"==typeof listener)try{listener.apply(that,args)}catch(e){log.error("Error in "+that.className+"#"+eventType+": "+e.message),log.error(e.stack)}})}}),that},webrtc.Client=function(params){"use strict";params=params||{};var client=webrtc.makeUniqueID().toString(),that=webrtc.EventThrower(params);webrtc.instances[client]=that,that.className="webrtc.Client",window.location.hostname,window.location.port;var connected=!1,signalingChannel=null,clientSettings=params.clientSettings||{};log.debug("Client ID is "+client);var mediaSettings={constraints:params.constraints||[{video:{mandatory:{minWidth:640,minHeight:480}},audio:!0,optional:[],mandatory:{}}],servers:params.servers||{iceServers:[{url:"stun:stun.l.google.com:19302"}]}};return signalingChannel=webrtc.SignalingChannel({client:client}),that.identityProvider=webrtc.IdentityProvider({client:client}),that.user=null,log.debug(signalingChannel),that.publicize("connect",function(){signalingChannel.open(),connected=!0}),that.publicize("disconnect",function(){signalingChannel.close(),connected=!1}),that.publicize("getID",function(){return client}),that.publicize("login",function(userAccount,token){var userPromise=that.identityProvider.login(userAccount,token);return userPromise.then(function(user){user.setOnline(),that.user=user,log.info("logged in as user "+user.getDisplayName()),log.debug(user)},function(error){log.error(error.message)}).done(),userPromise}),that.publicize("logout",function(usernames){if(null!==that.user){var userSession=that.user.getUserSession();(!usernames||userSession.userAccount in usernames)&&(that.identityProvider.logout(userSession.userAccount,userSession.token),userSession.loggedIn=!1)}}),that.publicize("isConnected",function(){return!!connected}),that.publicize("isLoggedIn",function(){return that.user?!!that.user.getUserSession().isLoggedIn():!1}),that.publicize("getClientSettings",function(){return clientSettings}),that.publicize("getMediaSettings",function(){return mediaSettings}),that.publicize("setDefaultMediaSettings",function(settings){settings=settings||{},settings.constraints&&(mediaSettings.constraints=settings.constraints),settings.servers&&(mediaSettings.servers=settings.servers)}),that.publicize("getSignalingChannel",function(){return signalingChannel}),that},webrtc.AbstractIdentityProvider=function(params){"use strict";params=params||{},params.client;var that=webrtc.EventThrower(params);return delete that.client,that.className="webrtc.AbstractIdentityProvider",that.publicize("login",function(){}),that.publicize("logout",function(){}),that.publicize("isLoggedIn",function(){}),that},webrtc.IdentityProvider=function(params){"use strict";params=params||{};var client=params.client,that=webrtc.AbstractIdentityProvider(params);delete that.client,that.className="webrtc.IdentityProvider";var signalingChannel=null,loggedIn=!1;return that.publicize("login",function(username,password){var deferred=null,user=null;return log.trace("User login"),log.debug("client is "+client),null===signalingChannel&&(signalingChannel=webrtc.getClient(client).getSignalingChannel()),signalingChannel.isOpen()||signalingChannel.open(),deferred=Q.defer(),signalingChannel.authenticate(username,password,function(response){200===response.code?(user=webrtc.User({client:client,username:username,loggedIn:!0}),deferred.resolve(user)):403===response.code?deferred.reject(new Error("Authentication failed.")):deferred.reject(new Error("Unknown error in authentication attempt."))}),deferred.promise}),that.publicize("logout",function(){log.trace("User logout"),signalingChannel.listen("closed",function(){loggedIn=!1}),signalingChannel.close()}),that.publicize("isLoggedIn",function(){return!!loggedIn}),that},webrtc.ContactList=function(params){"use strict";params=params||{},params.client;var that=webrtc.EventThrower(params);delete that.client,that.className="webrtc.ContactList",that.length=0;var contacts={},presenceQueue=[];return that.publicize("add",function(contact){if(contact instanceof webrtc.AbstractPresentable||!contact.getID)throw new Error("Can't add endpoint to list. Wrong type!");contact.getID()in contacts||(that.length+=1,that.fire("new",contact),contacts[contact.getID()]=contact)}),that.publicize("get",function(contactID){return contacts[contactID]}),that.publicize("remove",function(contactID){contacts.hasOwnProperty(contactID)&&(that.length-=1,that.fire("remove",contacts[contactID]),contacts[contactID]=void 0)}),that.publicize("getContacts",function(sortField){var values=[];return sortField=sortField||"id",contacts.forOwn(function(value){values.push(value)}),that.length=values.length,values=values.sort(function(a,b){return sortField in a&&sortField in b?webrtc.isNumber(a[sortField])&&webrtc.isNumber(b[sortField])?a[sortField]-b[sortField]:a.toLowerCase&&b.toLowerCase?a[sortField].toLowerCase()<b[sortField].toLowerCase()?-1:a[sortField].toLowerCase()>b[sortField].toLowerCase()?1:0:a[sortField]<b[sortField]?-1:a[sortField]>b[sortField]?1:0:(log.warn("sortField doesn't exist in both objects."),0)})}),that.publicize("queuePresence",function(message){presenceQueue.push(message)}),that.publicize("processPresenceQueue",function(){for(var i=0;i<=presenceQueue.length;i+=1)presenceQueue[i]&&that.fire("presence",presenceQueue[i]);presenceQueue=[]}),that},webrtc.AbstractPresentable=function(params){"use strict";params=params||{},params.client;var that=webrtc.EventThrower(params);delete that.client,that.className="webrtc.AbstractPresentable";var presence="unavailable",skills={video:{send:!0,receive:!0},audio:{send:!0,receive:!0}};return that.publicize("hasMedia",function(){return!1}),that.publicize("canSendAudio",function(){return skills.audio.send}),that.publicize("canSendVideo",function(){return skills.video.send}),that.publicize("getID",function(){return that.id}),that.publicize("getName",function(){return that.name}),that.publicize("getDisplayName",function(){return that.name}),that.publicize("getPresence",function(){return presence}),that.publicize("setPresence",function(newPresence){presence=newPresence,that.fire("presence",presence)}),that},webrtc.AbstractEndpoint=function(params){"use strict";params=params||{};var client=params.client,that=webrtc.AbstractPresentable(params);delete that.client,that.className="webrtc.AbstractEndpoint",that.mediaSessions=[];var signalingChannel=webrtc.getClient(client).getSignalingChannel();return that.publicize("sendMessage",function(message){signalingChannel.isOpen()&&signalingChannel.send(message)}),that.publicize("startMedia",function(){}),that.publicize("stopMedia",function(){}),that},webrtc.AbstractUser=function(params){"use strict";params=params||{},params.client;var that=webrtc.AbstractPresentable(params);delete that.client,that.className="webrtc.AbstractUser";var contactList=[],userSession=webrtc.UserSession({token:params.token,timeLoggedIn:params.timeLoggedIn||new Date,loggedIn:params.loggedIn});return delete params.token,delete params.timeLoggedIn,delete params.loggedIn,that.publicize("getUserSession",function(){return userSession}),that.publicize("getContactList",function(){return contactList}),that.publicize("setOnline",function(){that.setPresence("available")}),that},webrtc.UserSession=function(params){"use strict";params=params||{},params.client;var that=webrtc.EventThrower(params);delete that.client,that.className="webrtc.UserSession";var token=params.token||"";params.timeLoggedIn||null;var loggedIn=params.loggedIn||!1;return delete params.token,delete params.timeLoggedIn,delete params.loggedIn,that.publicize("getAuthToken",function(){return token}),that.publicize("isLoggedIn",function(){return!!loggedIn}),that},webrtc.AbstractContact=function(params){"use strict";params=params||{},params.client;var that=webrtc.AbstractEndpoint(params);return delete that.client,that.className="webrtc.AbstractContact",that.publicize("getMessages",function(){}),that},webrtc.Presentable=function(params){"use strict";params=params||{};var client=params.client,that=webrtc.AbstractPresentable(params);delete that.client,that.className="webrtc.Presentable";var presence="unavailable";return that.listen("signaling:received",function(message){try{webrtc.getClient(client).getSignalingChannel().routeSignal(message)}catch(e){log.error("Couldn't route message: "+e.message)}}),that.publicize("getID",function(){return that.id}),that.publicize("getDisplayName",function(){return that.name||that.username||that.id}),that.publicize("getUsername",function(){return that.username}),that.publicize("getStatus",function(){return presence}),that},webrtc.Endpoint=function(params){"use strict";params=params||{};var client=params.client,that=webrtc.Presentable(params);delete that.client,that.className="webrtc.Endpoint";var signalingChannel=webrtc.getClient(client).getSignalingChannel();return that.publicize("sendMessage",function(message){signalingChannel.sendMessage(webrtc.ChatMessage({recipient:that,sender:webrtc.getClient(client).user.getID(),payload:message}))}),that.publicize("startMedia",function(mediaSettings,initiator){var id=that.getID(),mediaSession=null,user=webrtc.getClient(client).user;return log.trace("startMedia"),void 0===initiator&&(initiator=!0),mediaSession=webrtc.MediaSession({client:client,username:user.getUsername(),remoteEndpoint:id,initiator:initiator,signalInitiate:function(sdp){sdp.type="offer",signalingChannel.sendSDP(that,sdp)},signalAccept:function(sdp){sdp.type="answer",signalingChannel.sendSDP(that,sdp)},signalCandidate:function(oCan){null!==oCan&&signalingChannel.sendCandidate(that,oCan)},signalTerminate:function(){signalingChannel.sendBye(that)},signalReport:function(oReport){log.debug("Not sending report"),log.debug(oReport)}}),mediaSession.start(),user.addMediaSession(mediaSession),mediaSession.listen("hangup",function(){user.removeMediaSession(id)}),mediaSession}),that},webrtc.Contact=function(params){"use strict";params=params||{},params.client;var that=webrtc.Endpoint(params);delete that.client,that.className="webrtc.Contact";var presence="unavailable",sessions={};that.publicize("setPresence",function(presenceString,sessionId){presenceString=presenceString||"available",console.log("presenceString"),console.log(presenceString),sessions.hasOwnProperty(sessionId)||(sessions[sessionId]={sessionId:sessionId,presence:presenceString}),sessions[sessionId].presence=presenceString,log.debug("after setPresence"),log.debug(sessions),resolvePresence()});var resolvePresence=function(){var options=["chat","available","away","dnd","xa","unavailable"],sessionIds=Object.keys(sessions);sessionIds=sessionIds.sort(function(a,b){var indexA=options.indexOf(sessions[a].presence),indexB=options.indexOf(sessions[b].presence);return indexA=-1===indexA?1e3:indexA,indexB=-1===indexB?1e3:indexB,indexB>indexA?-1:indexA>indexB?1:0}),presence=sessionIds[0]?sessions[sessionIds[0]].presence:"unavailable",log.debug("presences resolved to "+presence),that.fire("presence",presence)};return that},webrtc.User=function(params){"use strict";params=params||{};var client=params.client,that=webrtc.Presentable(params);delete that.client,that.className="webrtc.User";var mediaSessions=[],contactList=webrtc.ContactList({client:client}),presence="unavailable",signalingChannel=webrtc.getClient(client).getSignalingChannel(),userSession=webrtc.UserSession({client:client,token:params.token,timeLoggedIn:params.timeLoggedIn,loggedIn:params.loggedIn});return that.listen("presence",function(presenceString){presence=presenceString,signalingChannel&&signalingChannel.isOpen()?(log.info("sending my presence update "+presenceString),signalingChannel.sendPresence(presenceString)):log.error("Can't send my presence: no signaling channel.")}),contactList.listen("new",function(contact){that.fire("contact:new",contact)}),contactList.listen("presence",function(presenceMessage){var presPayload=presenceMessage.getPayload(),from=presenceMessage.getSender(),sessionId=presenceMessage.getSessionID(),contact=contactList.get(from);contact?contact.setPresence(presPayload.type,sessionId):from===webrtc.getClient(client).user.getID()?log.debug("got own presence"):(log.debug("Got unrecognized presence"),log.debug(presPayload))}),that.publicize("getContacts",function(){var deferred=Q.defer();if(!userSession.isLoggedIn())return deferred.reject(new Error("Can't request contacts unless logged in.")),deferred.promise;deferred.promise.then(function(contactList){setTimeout(function(){contactList.processPresenceQueue()},1e3)},function(err){throw err}).done();var presenceHandler=function(message){var contact,message=webrtc.PresenceMessage({rawMessage:message});if(0===contactList.length)return contactList.queuePresence(message),void 0;try{contact=contactList.get(message.getSender())}catch(e){throw new Error("Couldn't get presence sender.")}contact?(log.debug("presence "+message.getText()+" set on contact "+contact.getDisplayName()),contact.setPresence(message.getText(),message.getSessionID())):(log.warn("Can't set presence"),log.debug(message.getSender()),log.debug(message.getText()))};return signalingChannel.getContactList(function(list){!(list in[null,void 0])&&list.length>=0?(list.forEach(function(contactInfo){var contact=webrtc.Contact({client:client,id:contactInfo.id,username:contactInfo.username,email:contactInfo.email,name:contactInfo.name});contactList.add(contact)}),deferred.resolve(contactList)):deferred.reject(new Error("Can't get contact list: "+list.error))},function(presenceList){presenceList&&presenceList.length>0&&presenceList.forEach(function(presence){contactList.fire("presence",webrtc.PresenceMessage({rawMessage:presence}))})}),signalingChannel.addHandler("presence",presenceHandler),signalingChannel.addHandler("chat",function(message){var contact;try{contact=contactList.get(message.header.from.split(":")[1])}catch(e){throw new Error("Couldn't parse chat message.")}if(!contact)return log.warn("No such contact "+message.header.from),void 0;try{var parsed=JSON.parse(message.text);if(parsed&&"object"==typeof parsed)return parsed.candidate&&(parsed.type="candidate"),contact.fire("signaling:received",webrtc.SignalingMessage({client:client,rawMessage:JSON.stringify(parsed),recipient:that,sender:contact.getID()})),void 0}catch(e){log.debug("message error"),log.debug(message)}contact.fire("message:received",webrtc.ChatMessage({client:client,rawMessage:message.text,recipient:that,sender:contact.getID()}))}),deferred.promise}),that.publicize("getUserSession",function(){return userSession}),that.publicize("getActiveMediaSession",function(){var session=null;return mediaSessions.forEach(function(mediaSession){mediaSession.isActive()&&(session=mediaSession)}),session}),that.publicize("getMediaSessionByContact",function(contactId){var session=null,contact=null,mediaSettings=null;if(mediaSessions.forEach(function(mediaSession){if(mediaSession.remoteEndpoint===contactId){if("ended"===mediaSession.getState())return;session=mediaSession}}),null===session)try{contact=contactList.get(contactId),mediaSettings=webrtc.getClient(client).getMediaSettings(),session=contact.startMedia(mediaSettings,!1)}catch(e){log.error("Couldn't create MediaSession: "+e.message)}return session}),that.publicize("addMediaSession",function(mediaSession){mediaSessions.push(mediaSession),that.fire("media:started",mediaSession,mediaSession.getContactID())}),that.publicize("removeMediaSession",function(contactId){if(!contactId)throw new Error("Must specify contactId of MediaSession to remove.");for(var i=mediaSessions.length-1;i>=0;i-=1){var mediaSession=mediaSessions[i];mediaSession.remoteEndpoint===contactId&&mediaSessions.splice(i)}}),that.publicize("setOnline",function(){that.setPresence("available")}),that},webrtc.AbstractSignalingChannel=function(params){"use strict";params=params||{},params.client;var that=webrtc.EventThrower(params);delete that.client,that.className="webrtc.AbstractSignalingChannel";var state="new";return that.publicize("open",function(){state="open"}),that.publicize("close",function(){state="closed"}),that.publicize("getState",function(){return state}),that.publicize("isOpen",function(){return"open"===state}),that.publicize("send",function(){}),that},webrtc.AbstractMessage=function(params){"use strict";params=params||{},params.client;var that=webrtc.Class(params);return delete that.client,that.className="webrtc.AbstractMessage",that.publicize("parse",function(){}),that.publicize("getPayload",function(){}),that.publicize("getText",function(){}),that},webrtc.SignalingChannel=function(params){"use strict";params=params||{};var client=params.client,that=webrtc.AbstractSignalingChannel(params);delete that.client,that.className="webrtc.SignalingChannel";var state="new",baseURL=null,appId=null,socket=null,xhr=new XMLHttpRequest;xhr.withCredentials=!0;var handlerQueue={chat:[],signaling:[],presence:[]};that.publicize("open",function(){if(null===baseURL||null===appId){var clientSettings=webrtc.getClient(client).getClientSettings();baseURL=clientSettings.baseURL||"http://54.200.29.88:1337",appId=clientSettings.appId}if(!appId)throw new Error("No appId specified.");log.trace("Signaling connection open."),state="open"}),that.publicize("close",function(){log.trace("Signaling connection closed."),state="closed"}),webrtc.makeUniqueID,that.publicize("getState",function(){return state}),that.publicize("isOpen",function(){return"open"===state}),that.publicize("sendPresence",function(presenceString){log.trace("Signaling sendPresence"),wsCall({path:"/v1/presence",httpMethod:"POST",parameters:{presence:{show:"no show",status:"Hey, I'm having fun!",type:presenceString||"available"}}})}),that.publicize("getContactList",function(onContacts,onPresence){wsCall({path:"/v1/contacts/"},function(contactList){var userIdList=[];contactList.forEach(function(contact){userIdList.push({userId:contact.id})}),onContacts&&onContacts(contactList),wsCall({path:"/v1/presence/observer",httpMethod:"POST",parameters:{users:userIdList}},function(presenceList){onPresence&&onPresence(presenceList)})})}),that.publicize("sendMessage",function(message){wsCall({path:"/v1/chat",httpMethod:"POST",parameters:{destUserId:message.getRecipient().getID(),text:message.getPayload()}},null),message.getRecipient().fire("message:sent",message)}),that.publicize("send",function(){}),that.publicize("sendCandidate",function(recipient,candObj){recipient.sendMessage(JSON.stringify(candObj))}),that.publicize("sendSDP",function(recipient,sdpObj){recipient.sendMessage(JSON.stringify(sdpObj))}),that.publicize("sendBye",function(recipient,reason){recipient.sendMessage(JSON.stringify({type:"bye",reason:reason}))}),that.publicize("parseText",function(msgString){return msgString}),that.publicize("routeSignal",function(message){webrtc.getClient(client).user.getMediaSessionByContact(message.sender);var signal=message.getPayload();switch(signal.type){case"offer":case"answer":case"candidate":case"bye":that.fire("received:"+signal.type,signal);break;case"error":log.warn("Received an error"),log.warn(signal);break;default:log.error("Don't know what to do with msg of unknown type "+signal.type)}}),that.publicize("addHandler",function(type,handler){socket.socket&&socket.socket.open?socket.on(type,handler):handlerQueue[type].push(handler)}),that.publicize("authenticate",function(username,password,callback){call({httpMethod:"POST",path:"/v1/authsession",parameters:{username:username,password:password,appId:appId}},function(response){var pieces=baseURL.split(/:\/\//),protocol=pieces[0],pieces=pieces[1].split(/:/),host=pieces[0],port=pieces[1];socket=io.connect(baseURL,{host:host,port:port,protocol:protocol,secure:"https"===protocol}),socket.on("connect",function(){handlerQueue.forOwn(function(array,category){array.forEach(function(handler){socket.on(category,handler)}),array=[]})}),socket.on("signaling",that.routeSignal),200===response.code&&wsCall({path:"/v1/usersessions",httpMethod:"POST",parameters:{presence:{show:"no show",status:"Hey, I'm having fun!",type:"available"}}}),callback(response)})});var wsCall=function(params,responseHandler){if(!params)throw new Error("No params.");if(!params.path)throw new Error("No request path.");params.httpMethod=(params.httpMethod||"get").toLowerCase(),params.objectId&&(params.path=params.path.replace(/\%s/gi,params.objectId)),void 0===responseHandler&&(responseHandler=function(response){log.debug("default responseHandler"),log.debug(response)}),socket[params.httpMethod](params.path,params.parameters,function(response){log.debug("wsCall response to "+params.httpMethod+" "+params.path),log.debug(response),responseHandler&&responseHandler(response,{uri:params.path,params:params.parameters})})},call=function(params,responseHandler){var paramString=null,uri=null,response=null,response={result:null,code:null};if(uri=baseURL+params.path,!params)throw new Error("No params.");if(!params.httpMethod)throw new Error("No HTTP method.");if(!params.path)throw new Error("No request path.");if(params.objectId&&(params.path=params.path.replace(/\%s/gi,params.objectId)),responseHandler||(responseHandler=function(response){log.debug("default responseHandler"),log.debug(response)}),["GET","DELETE"].indexOf(params.httpMethod)>-1&&(uri+=makeParamString(params.parameters)),xhr.open(params.httpMethod,uri),["POST","PUT"].indexOf(params.httpMethod)>-1){paramString=JSON.stringify(params.parameters);try{xhr.setRequestHeader("Content-Type","application/json;charset=UTF-8")}catch(e){log.debug("Can't set content-type header in readyState "+xhr.readyState+". "+e.message)}}else if(-1===["GET","DELETE"].indexOf(params.httpMethod))throw new Error("Illegal HTTP request method "+params.httpMethod);log.debug("calling "+params.httpMethod+" "+uri+" with params "+paramString);try{xhr.send(paramString)}catch(e){log.warn("Can't call xhr.send. "+e.message)}xhr.onreadystatechange=function(){if(4===this.readyState&&0!==this.status)if([200,204,205,302,403,404,418].indexOf(this.status)>-1){response.code=this.status;try{response.result=JSON.parse(this.response)}catch(e){response.result=this.response,response.error="Invalid JSON."}log.debug(response),responseHandler(response,{uri:uri,params:params.parameters})}else log.warn("unexpected response "+this.status)}},makeParamString=function(params){var strings=[];return params?(params.forOwn(function(value,name){"array"==typeof value?strings.push([name,value.join(",")].join("=")):"object"!=typeof value&&"function"!=typeof value&&strings.push([name,value].join("="))}),strings.length>0?"?"+strings.join("&"):""):""};return that},webrtc.ChatMessage=function(params){"use strict";params=params||{},params.client;var that=webrtc.AbstractMessage(params);delete that.client,that.className="webrtc.ChatMessage";var rawMessage=params.rawMessage,payload=params.payload;params.sender;var recipient=params.recipient,parse=that.publicize("parse",function(thisMsg){payload=thisMsg||rawMessage});return that.publicize("getPayload",function(){return payload}),that.publicize("getText",function(){return payload}),that.publicize("getRecipient",function(){return recipient}),rawMessage&&parse(),that},webrtc.SignalingMessage=function(params){"use strict";params=params||{},params.client;var that=webrtc.AbstractMessage(params);delete that.client,that.className="webrtc.SignalingMessage";var rawMessage=params.rawMessage,payload=null;params.sender;var recipient=params.recipient,parse=that.publicize("parse",function(thisMsg){try{payload=JSON.parse(rawMessage||thisMsg)}catch(e){log.error("Not a JSON message!")}});return that.publicize("getText",function(){return payload.type}),that.publicize("getPayload",function(){return payload}),that.publicize("getRecipient",function(){return recipient}),rawMessage&&parse(),that},webrtc.PresenceMessage=function(params){"use strict";params=params||{},params.client;var that=webrtc.AbstractMessage(params);delete that.client,that.className="webrtc.PresenceMessage";var rawMessage=params.rawMessage;delete params.rawMessage;var payload={},sender=params.sender,sessionId=null,parse=that.publicize("parse",function(thisMsg){var pieces;thisMsg&&(rawMessage=thisMsg);try{pieces=rawMessage.header.from.split(":")[1].split("@"),sender=pieces[0],sessionId=pieces[1]}catch(e){sender=rawMessage.userId,sessionId=rawMessage.sessionId}delete rawMessage.header,payload=rawMessage});return that.publicize("getText",function(){if(!payload)throw new Error("No message payload.");return payload.type}),that.publicize("getPayload",function(){return payload}),that.publicize("getSender",function(){return sender}),that.publicize("getSessionID",function(){return sessionId}),rawMessage&&parse(),that},webrtc.MediaSession=function(params){"use strict";params=params||{};var client=params.client,that=webrtc.EventThrower(params);delete that.client,that.className="webrtc.MediaSession",that.initiator||(that.initiator=!1);var pc=null,savedOffer=null,receivedAnswer=!1,receivedBye=!1,candidateSendingQueue=[],candidateReceivingQueue=[],mediaStreams=[],clientObj=webrtc.getClient(client),localVideoElements=params.localVideoElements||[],remoteVideoElements=params.remoteVideoElements||[],signalingChannel=clientObj.getSignalingChannel(),remoteEndpoint=params.remoteEndpoint,signalInitiate=params.signalInitiate,signalAccept=params.signalAccept,signalTerminate=params.signalTerminate,signalReport=params.signalReport,signalCandidate=params.signalCandidate,mediaSettings=clientObj.getMediaSettings(),options={optional:[{DtlsSrtpKeyAgreement:!0},{RtpDataChannels:!1}]};params.mediaSettings&&params.mediaSettings.constraints&&(mediaSettings.constraints=params.mediaSettings.constraints),params.mediaSettings&&params.mediaSettings.servers&&(mediaSettings.servers=params.mediaSettings.servers);var report={startCallCount:0,startCount:0,callStarted:0,callStopped:0,roomkey:null,sessionkey:null,lastSDPString:"",sdpsSent:[],sdpsReceived:[],candidatesSent:[],candidatesReceived:[],userAgent:navigator.userAgent,os:navigator.platform};that.publicize("start",function(){if(!that.username)throw new Error("Can't use a MediaSession without username. got "+that.username);report.startCount+=1,log.trace("calling requestMedia from start."),log.debug("I am "+(that.initiator?"":"not ")+"the initiator."),requestMedia()});var startCall=function(){log.trace("startCall"),report.startCallCount+=1,log.info("creating offer"),pc.createOffer(saveOfferAndSend,function(){log.error("createOffer failed")},null)},onReceiveUserMedia=function(stream,oneConstraints,index){var videoElement=null;if(that.state="media flowing",log.debug("User gave permission to use media."),log.trace(onReceiveUserMedia),log.trace(stream),null===pc)return log.error("Peer connection is null!"),void 0;mediaStreams.push(webrtc.MediaStream({stream:stream,isLocal:!0})),stream.id=clientObj.user.getID()+index,pc.addStream(stream);for(var i=0;i<localVideoElements.length&&null===videoElement;i+=1)"VIDEO"!==localVideoElements[i].tagName||localVideoElements[i].used||(videoElement=localVideoElements[i]);null===videoElement&&(videoElement=document.createElement("video")),videoElement.muted=!0,videoElement.autoplay=!0,attachMediaStream(videoElement,stream),setTimeout(function(){videoElement.play()},100),that.fire("stream:local:received",videoElement),videoElement.used=!0,1===mediaStreams.length&&(that.initiator?(that.fire("call:initiate"),startCall()):acceptCall())},requestMedia=function(){var now=new Date,toDelete=[],url="";report.callStarted=now.getTime(),log.trace(requestMedia);try{pc=new RTCPeerConnection(mediaSettings.servers,options)}catch(e){log.debug("Removing TURN servers.");for(var i in mediaSettings.servers.iceServers)mediaSettings.servers.iceServers.hasOwnProperty(i)&&(url=mediaSettings.servers.iceServers[i].url,url.toLowerCase().indexOf("turn")>-1&&toDelete.push(i));toDelete.sort(function(a,b){return b-a}),toDelete.forEach(function(value,index){mediaSettings.servers.iceServers.splice(index)}),pc=new RTCPeerConnection(mediaSettings.servers,options)}pc.onaddstream=onRemoteStreamAdded,pc.onremovestream=onRemoteStreamRemoved,pc.onicecandidate=onIceCandidate,pc.onnegotiationneeded=onNegotiationNeeded,pc.onstatechange=onStateChange,pc.onicechange=onIceChange,savedOffer&&(processOffer(savedOffer),savedOffer=null),mediaSettings.constraints.forOwn(function(oneConstraints,index){try{log.debug("Running getUserMedia with constraints"),log.debug(oneConstraints),getUserMedia(oneConstraints,function(p){onReceiveUserMedia(p,oneConstraints,index)},function(p){onUserMediaError(p,oneConstraints,index)})}catch(e){log.error("Couldn't get user media: "+e.message)}})},onUserMediaError=function(p){log.trace("onUserMediaError"),1===p.code?(log.warn("Permission denied."),report.callStoppedReason="Permission denied."):(log.warn(p),report.callStoppedReason=p.code),stopMedia(!that.initiator)},acceptCall=function(){log.trace("acceptCall"),savedOffer?(processOffer(savedOffer),savedOffer=null):(log.error("Can't process offer--no SDP!"),stopMedia(!0))},onRemoteStreamRemoved=function(){log.trace("pc event: remote stream removed")},onRemoteStreamAdded=function(evt){that.state="media flowing";var videoElement=null;log.trace("received remote media");for(var i=0;i<remoteVideoElements.length&&null===videoElement;i+=1)"VIDEO"!==remoteVideoElements[i].tagName||remoteVideoElements[i].used||(videoElement=remoteVideoElements[i]);null===videoElement&&(videoElement=document.createElement("video")),videoElement.autoplay=!0,attachMediaStream(videoElement,evt.stream),setTimeout(function(){videoElement.play()},100),that.fire("stream:remote:received",videoElement),videoElement.used=!0,mediaStreams.push(webrtc.MediaStream({stream:evt.stream,isLocal:!1}))},onStateChange=function(p){log.trace("iceState is "+p.currentTarget.iceState),log.trace("readyState is "+p.currentTarget.readyState)},onIceChange=function(p){log.trace("pc event: ice changed"),log.trace(p)},onIceCandidate=function(oCan){oCan.candidate&&(log.trace("original browser-generated candidate object"),log.trace(oCan.candidate),that.initiator&&!receivedAnswer?candidateSendingQueue.push(oCan.candidate):that.initiator||(report.candidatesSent.push(oCan.candidate),signalCandidate(oCan.candidate)))
},onNegotiationNeeded=function(){log.warn("Negotiation needed.")},processQueues=function(){var can=null;log.trace("Processing candidate queues.");for(var i=0;i<=candidateSendingQueue.length;i+=1)can=candidateSendingQueue[i],signalCandidate(can);candidateSendingQueue=[];for(var i=0;i<=candidateReceivingQueue.length;i+=1)can=candidateReceivingQueue[i],log.trace("Calling processCandidate in processQueues"),log.trace(can),processCandidate(can);candidateReceivingQueue=[]},saveOfferAndSend=function(oSession){oSession.type="offer",log.debug("setting and sending initiate"),log.debug(oSession),report.sdpsSent.push(oSession),pc.setLocalDescription(oSession,function(){signalInitiate(oSession)},function(p){log.error("setLocalDescription failed"),log.error(p)})},saveAnswerAndSend=function(oSession){oSession.type="answer",log.debug("setting and sending accept"),log.debug(oSession),report.sdpsSent.push(oSession),pc.setLocalDescription(oSession,function(){signalAccept(oSession)},function(p){log.error("setLocalDescription failed"),log.error(p)})},stopMedia=that.publicize("stopMedia",function(sendSignal){that.state="ended",null!==pc&&(log.debug("hanging up"),sendSignal="boolean"==typeof sendSignal?sendSignal:!0,!receivedBye&&sendSignal&&(log.info("sending bye"),signalTerminate()),report.callStopped=(new Date).getTime(),signalReport(report),that.fire("hangup",sendSignal),that.ignore(),signalingChannel.ignore("received:offer",onOffer),signalingChannel.ignore("received:answer",onAnswer),signalingChannel.ignore("received:candidate",processCandidate),signalingChannel.ignore("received:bye",onBye),mediaStreams.forOwn(function(stream){stream.stop()}),pc&&pc.close(),mediaStreams=[],pc=null)}),processOffer=function(oSession){oSession.type="offer",log.trace("processOffer"),log.trace(oSession);try{pc.setRemoteDescription(new RTCSessionDescription(oSession),function(){log.debug("set remote desc of offer succeeded"),pc.createAnswer(saveAnswerAndSend,function(p){log.error("Error creating SDP answer."),report.callStoppedReason="Error creating SDP answer.",log.error(p)}),that.savedOffer=null},function(p){log.error("set remote desc of offer failed"),report.callStoppedReason="setLocalDescr failed at offer.",log.error(oSession),log.error(p),that.stopMedia()})}catch(e){log.error("error processing offer: "+e.message)}};that.publicize("isActive",function(){var inProgress=!1;return log.trace("isActive"),pc&&receivedBye!==!0?(inProgress=pc.readyState in["new","active"],log.info("readyState is "+pc.readyState+". Call is "+(inProgress?"":"not ")+"in progress."),inProgress):!1});var onOffer=function(oSession){that.state="setup",log.debug("got offer"),log.debug(oSession),savedOffer=oSession,that.initiator?(log.warn("Got initiate in precall state."),log.trace("rejecting call."),signalTerminate()):(report.sdpsReceived.push(oSession),report.lastSDPString=oSession.sdp)},onAnswer=function(oSession){that.state="setup",log.debug("remote side sdp is"),log.debug(oSession),savedOffer=oSession,receivedAnswer=!0,report.sdpsReceived.push(oSession),report.lastSDPString=oSession.sdp,pc.setRemoteDescription(new RTCSessionDescription(oSession),processQueues,function(){log.error("set remote desc of answer failed"),report.callStoppedReason="setRemoteDescription failed at answer.",log.error(oSession),that.stopMedia()})},processCandidate=function(oCan){if(!oCan||null===oCan.candidate)return log.info("End of candidates."),void 0;if(oCan.hasOwnProperty("sdpMLineIndex")&&oCan.candidate||(log.warn("processCandidate got wrong format!"),log.warn(oCan)),that.initiator&&!receivedAnswer)return candidateReceivingQueue.push(oCan),log.debug("Queueing a candidate."),void 0;try{pc.addIceCandidate(new RTCIceCandidate(oCan))}catch(e){log.error("Couldn't add ICE candidate: "+e.message),log.error(oCan)}report.candidatesReceived.push(oCan)};that.publicize("getState",function(){return pc?pc.readyState:"before"}),that.publicize("isInitiator",function(){return that.initiator}),that.publicize("getContactID",function(){return remoteEndpoint}),that.publicize("getStreams",function(){return mediaStreams}),that.publicize("getLocalStreams",function(){var streams=[];return mediaStreams.forOwn(function(stream){stream.isLocal()&&streams.push(stream)}),streams}),that.publicize("getRemoteStreams",function(){var streams=[];return mediaStreams.forOwn(function(stream){stream.isLocal()||streams.push(stream)}),streams}),that.publicize("toggleVideo",function(){that.isActive()&&(pc.localStreams[0].videoTracks[0].enabled?that.muteVideo():that.unmuteVideo())}),that.publicize("toggleAudio",function(){that.isActive()&&(pc.localStreams[0].audioTracks[0].enabled?that.muteAudio():that.unmuteAudio())}),that.publicize("muteVideo",function(){log.trace("muting video"),mediaStreams.forOwn(function(stream){stream.muteVideo()}),that.fire("video:muted")}),that.publicize("unmuteVideo",function(){log.trace("unmuting video"),mediaStreams.forOwn(function(stream){stream.unmuteVideo()}),that.fire("video:unmuted")}),that.publicize("muteAudio",function(){log.trace("muting audio"),mediaStreams.forOwn(function(stream){stream.muteAudio()}),that.fire("audio:muted")}),that.publicize("unmuteAudio",function(){log.trace("unmuting audio"),mediaStreams.forOwn(function(stream){stream.unmuteAudio()}),that.fire("audio:unmuted")});var onBye=function(){receivedBye=!0,stopMedia()};return signalingChannel.listen("received:offer",onOffer),signalingChannel.listen("received:answer",onAnswer),signalingChannel.listen("received:candidate",processCandidate),signalingChannel.listen("received:bye",onBye),that},webrtc.MediaStream=function(params){"use strict";params=params||{};var that=webrtc.EventThrower(params);that.className="webrtc.MediaStream";var stream=params.stream,local=params.isLocal;that.publicize("stop",function(){stream.stop()}),that.publicize("muteAudio",function(){stream.audioTracks[0].enabled=!1,that.fire("audio:muted")}),that.publicize("muteVideo",function(){stream.videoTracks[0].enabled=!1,that.fire("video:muted")}),that.publicize("unmuteAudio",function(){stream.audioTracks[0].enabled=!0,that.fire("audio:unmuted")}),that.publicize("unmuteVideo",function(){stream.videoTracks[0].enabled=!0,that.fire("video:unmuted")});var isLocal=that.publicize("isLocal",function(){return!!local});return that.publicize("isRemote",function(){return!isLocal()}),that.publicize("getID",function(){return stream.id}),that.publicize("getURL",function(){}),that};